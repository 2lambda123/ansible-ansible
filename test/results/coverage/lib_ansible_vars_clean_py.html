


<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    
    <meta http-equiv="X-UA-Compatible" content="IE=emulateIE7" />
    <title>Coverage for lib/ansible/vars/clean.py: 81%</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.hotkeys.js"></script>
    <script type="text/javascript" src="jquery.isonscreen.js"></script>
    <script type="text/javascript" src="coverage_html.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(coverage.pyfile_ready);
    </script>
</head>
<body class="pyfile">

<div id="header">
    <div class="content">
        <h1>Coverage for <b>lib/ansible/vars/clean.py</b> :
            <span class="pc_cov">81%</span>
        </h1>

        <img id="keyboard_icon" src="keybd_closed.png" alt="Show keyboard shortcuts" />

        <h2 class="stats">
            86 statements &nbsp;
            <span class="run hide_run shortkey_r button_toggle_run">71 run</span>
            <span class="mis shortkey_m button_toggle_mis">15 missing</span>
            <span class="exc shortkey_x button_toggle_exc">0 excluded</span>

            
                <span class="par run hide_run shortkey_p button_toggle_par">7 partial</span>
            
        </h2>
    </div>
</div>

<div class="help_panel">
    <img id="panel_icon" src="keybd_open.png" alt="Hide keyboard shortcuts" />
    <p class="legend">Hot-keys on this page</p>
    <div>
    <p class="keyhelp">
        <span class="key">r</span>
        <span class="key">m</span>
        <span class="key">x</span>
        <span class="key">p</span> &nbsp; toggle line displays
    </p>
    <p class="keyhelp">
        <span class="key">j</span>
        <span class="key">k</span> &nbsp; next/prev highlighted chunk
    </p>
    <p class="keyhelp">
        <span class="key">0</span> &nbsp; (zero) top of page
    </p>
    <p class="keyhelp">
        <span class="key">1</span> &nbsp; (one) first highlighted chunk
    </p>
    </div>
</div>

<div id="source">
    <table>
        <tr>
            <td class="linenos">
<p id="n1" class="pln"><a href="#n1">1</a></p>
<p id="n2" class="pln"><a href="#n2">2</a></p>
<p id="n3" class="pln"><a href="#n3">3</a></p>
<p id="n4" class="pln"><a href="#n4">4</a></p>
<p id="n5" class="stm run hide_run"><a href="#n5">5</a></p>
<p id="n6" class="stm run hide_run"><a href="#n6">6</a></p>
<p id="n7" class="pln"><a href="#n7">7</a></p>
<p id="n8" class="stm run hide_run"><a href="#n8">8</a></p>
<p id="n9" class="stm run hide_run"><a href="#n9">9</a></p>
<p id="n10" class="pln"><a href="#n10">10</a></p>
<p id="n11" class="stm run hide_run"><a href="#n11">11</a></p>
<p id="n12" class="stm run hide_run"><a href="#n12">12</a></p>
<p id="n13" class="stm run hide_run"><a href="#n13">13</a></p>
<p id="n14" class="stm run hide_run"><a href="#n14">14</a></p>
<p id="n15" class="pln"><a href="#n15">15</a></p>
<p id="n16" class="stm run hide_run"><a href="#n16">16</a></p>
<p id="n17" class="stm run hide_run"><a href="#n17">17</a></p>
<p id="n18" class="stm run hide_run"><a href="#n18">18</a></p>
<p id="n19" class="stm run hide_run"><a href="#n19">19</a></p>
<p id="n20" class="stm run hide_run"><a href="#n20">20</a></p>
<p id="n21" class="pln"><a href="#n21">21</a></p>
<p id="n22" class="pln"><a href="#n22">22</a></p>
<p id="n23" class="stm run hide_run"><a href="#n23">23</a></p>
<p id="n24" class="pln"><a href="#n24">24</a></p>
<p id="n25" class="pln"><a href="#n25">25</a></p>
<p id="n26" class="pln"><a href="#n26">26</a></p>
<p id="n27" class="pln"><a href="#n27">27</a></p>
<p id="n28" class="pln"><a href="#n28">28</a></p>
<p id="n29" class="pln"><a href="#n29">29</a></p>
<p id="n30" class="pln"><a href="#n30">30</a></p>
<p id="n31" class="pln"><a href="#n31">31</a></p>
<p id="n32" class="pln"><a href="#n32">32</a></p>
<p id="n33" class="pln"><a href="#n33">33</a></p>
<p id="n34" class="pln"><a href="#n34">34</a></p>
<p id="n35" class="pln"><a href="#n35">35</a></p>
<p id="n36" class="pln"><a href="#n36">36</a></p>
<p id="n37" class="pln"><a href="#n37">37</a></p>
<p id="n38" class="pln"><a href="#n38">38</a></p>
<p id="n39" class="pln"><a href="#n39">39</a></p>
<p id="n40" class="pln"><a href="#n40">40</a></p>
<p id="n41" class="pln"><a href="#n41">41</a></p>
<p id="n42" class="pln"><a href="#n42">42</a></p>
<p id="n43" class="pln"><a href="#n43">43</a></p>
<p id="n44" class="pln"><a href="#n44">44</a></p>
<p id="n45" class="pln"><a href="#n45">45</a></p>
<p id="n46" class="pln"><a href="#n46">46</a></p>
<p id="n47" class="pln"><a href="#n47">47</a></p>
<p id="n48" class="pln"><a href="#n48">48</a></p>
<p id="n49" class="pln"><a href="#n49">49</a></p>
<p id="n50" class="pln"><a href="#n50">50</a></p>
<p id="n51" class="pln"><a href="#n51">51</a></p>
<p id="n52" class="stm run hide_run"><a href="#n52">52</a></p>
<p id="n53" class="stm run hide_run"><a href="#n53">53</a></p>
<p id="n54" class="stm run hide_run"><a href="#n54">54</a></p>
<p id="n55" class="stm run hide_run"><a href="#n55">55</a></p>
<p id="n56" class="stm run hide_run"><a href="#n56">56</a></p>
<p id="n57" class="stm run hide_run"><a href="#n57">57</a></p>
<p id="n58" class="pln"><a href="#n58">58</a></p>
<p id="n59" class="stm run hide_run"><a href="#n59">59</a></p>
<p id="n60" class="pln"><a href="#n60">60</a></p>
<p id="n61" class="stm run hide_run"><a href="#n61">61</a></p>
<p id="n62" class="stm run hide_run"><a href="#n62">62</a></p>
<p id="n63" class="stm run hide_run"><a href="#n63">63</a></p>
<p id="n64" class="pln"><a href="#n64">64</a></p>
<p id="n65" class="stm run hide_run"><a href="#n65">65</a></p>
<p id="n66" class="pln"><a href="#n66">66</a></p>
<p id="n67" class="stm run hide_run"><a href="#n67">67</a></p>
<p id="n68" class="pln"><a href="#n68">68</a></p>
<p id="n69" class="pln"><a href="#n69">69</a></p>
<p id="n70" class="stm run hide_run"><a href="#n70">70</a></p>
<p id="n71" class="pln"><a href="#n71">71</a></p>
<p id="n72" class="pln"><a href="#n72">72</a></p>
<p id="n73" class="pln"><a href="#n73">73</a></p>
<p id="n74" class="pln"><a href="#n74">74</a></p>
<p id="n75" class="pln"><a href="#n75">75</a></p>
<p id="n76" class="stm run hide_run"><a href="#n76">76</a></p>
<p id="n77" class="stm run hide_run"><a href="#n77">77</a></p>
<p id="n78" class="stm run hide_run"><a href="#n78">78</a></p>
<p id="n79" class="stm run hide_run"><a href="#n79">79</a></p>
<p id="n80" class="stm run hide_run"><a href="#n80">80</a></p>
<p id="n81" class="stm run hide_run"><a href="#n81">81</a></p>
<p id="n82" class="stm run hide_run"><a href="#n82">82</a></p>
<p id="n83" class="stm run hide_run"><a href="#n83">83</a></p>
<p id="n84" class="stm run hide_run"><a href="#n84">84</a></p>
<p id="n85" class="stm run hide_run"><a href="#n85">85</a></p>
<p id="n86" class="pln"><a href="#n86">86</a></p>
<p id="n87" class="pln"><a href="#n87">87</a></p>
<p id="n88" class="stm run hide_run"><a href="#n88">88</a></p>
<p id="n89" class="pln"><a href="#n89">89</a></p>
<p id="n90" class="pln"><a href="#n90">90</a></p>
<p id="n91" class="pln"><a href="#n91">91</a></p>
<p id="n92" class="stm run hide_run"><a href="#n92">92</a></p>
<p id="n93" class="stm par run hide_run"><a href="#n93">93</a></p>
<p id="n94" class="stm mis"><a href="#n94">94</a></p>
<p id="n95" class="stm mis"><a href="#n95">95</a></p>
<p id="n96" class="pln"><a href="#n96">96</a></p>
<p id="n97" class="pln"><a href="#n97">97</a></p>
<p id="n98" class="stm run hide_run"><a href="#n98">98</a></p>
<p id="n99" class="stm run hide_run"><a href="#n99">99</a></p>
<p id="n100" class="stm run hide_run"><a href="#n100">100</a></p>
<p id="n101" class="pln"><a href="#n101">101</a></p>
<p id="n102" class="pln"><a href="#n102">102</a></p>
<p id="n103" class="stm run hide_run"><a href="#n103">103</a></p>
<p id="n104" class="pln"><a href="#n104">104</a></p>
<p id="n105" class="stm run hide_run"><a href="#n105">105</a></p>
<p id="n106" class="pln"><a href="#n106">106</a></p>
<p id="n107" class="stm run hide_run"><a href="#n107">107</a></p>
<p id="n108" class="stm run hide_run"><a href="#n108">108</a></p>
<p id="n109" class="pln"><a href="#n109">109</a></p>
<p id="n110" class="pln"><a href="#n110">110</a></p>
<p id="n111" class="pln"><a href="#n111">111</a></p>
<p id="n112" class="stm run hide_run"><a href="#n112">112</a></p>
<p id="n113" class="stm run hide_run"><a href="#n113">113</a></p>
<p id="n114" class="pln"><a href="#n114">114</a></p>
<p id="n115" class="pln"><a href="#n115">115</a></p>
<p id="n116" class="stm run hide_run"><a href="#n116">116</a></p>
<p id="n117" class="pln"><a href="#n117">117</a></p>
<p id="n118" class="pln"><a href="#n118">118</a></p>
<p id="n119" class="stm run hide_run"><a href="#n119">119</a></p>
<p id="n120" class="stm run hide_run"><a href="#n120">120</a></p>
<p id="n121" class="stm run hide_run"><a href="#n121">121</a></p>
<p id="n122" class="stm run hide_run"><a href="#n122">122</a></p>
<p id="n123" class="stm run hide_run"><a href="#n123">123</a></p>
<p id="n124" class="pln"><a href="#n124">124</a></p>
<p id="n125" class="stm par run hide_run"><a href="#n125">125</a></p>
<p id="n126" class="stm mis"><a href="#n126">126</a></p>
<p id="n127" class="stm run hide_run"><a href="#n127">127</a></p>
<p id="n128" class="stm run hide_run"><a href="#n128">128</a></p>
<p id="n129" class="pln"><a href="#n129">129</a></p>
<p id="n130" class="pln"><a href="#n130">130</a></p>
<p id="n131" class="stm run hide_run"><a href="#n131">131</a></p>
<p id="n132" class="stm par run hide_run"><a href="#n132">132</a></p>
<p id="n133" class="stm mis"><a href="#n133">133</a></p>
<p id="n134" class="pln"><a href="#n134">134</a></p>
<p id="n135" class="pln"><a href="#n135">135</a></p>
<p id="n136" class="stm run hide_run"><a href="#n136">136</a></p>
<p id="n137" class="stm run hide_run"><a href="#n137">137</a></p>
<p id="n138" class="stm par run hide_run"><a href="#n138">138</a></p>
<p id="n139" class="stm mis"><a href="#n139">139</a></p>
<p id="n140" class="pln"><a href="#n140">140</a></p>
<p id="n141" class="stm par run hide_run"><a href="#n141">141</a></p>
<p id="n142" class="stm mis"><a href="#n142">142</a></p>
<p id="n143" class="stm mis"><a href="#n143">143</a></p>
<p id="n144" class="stm mis"><a href="#n144">144</a></p>
<p id="n145" class="stm mis"><a href="#n145">145</a></p>
<p id="n146" class="stm mis"><a href="#n146">146</a></p>
<p id="n147" class="stm mis"><a href="#n147">147</a></p>
<p id="n148" class="stm mis"><a href="#n148">148</a></p>
<p id="n149" class="stm mis"><a href="#n149">149</a></p>
<p id="n150" class="stm mis"><a href="#n150">150</a></p>
<p id="n151" class="pln"><a href="#n151">151</a></p>
<p id="n152" class="stm run hide_run"><a href="#n152">152</a></p>
<p id="n153" class="pln"><a href="#n153">153</a></p>
<p id="n154" class="pln"><a href="#n154">154</a></p>
<p id="n155" class="stm run hide_run"><a href="#n155">155</a></p>
<p id="n156" class="pln"><a href="#n156">156</a></p>
<p id="n157" class="stm run hide_run"><a href="#n157">157</a></p>
<p id="n158" class="stm run hide_run"><a href="#n158">158</a></p>
<p id="n159" class="stm par run hide_run"><a href="#n159">159</a></p>
<p id="n160" class="pln"><a href="#n160">160</a></p>
<p id="n161" class="stm mis"><a href="#n161">161</a></p>
<p id="n162" class="pln"><a href="#n162">162</a></p>
<p id="n163" class="stm run hide_run"><a href="#n163">163</a></p>
<p id="n164" class="pln"><a href="#n164">164</a></p>
<p id="n165" class="stm run hide_run"><a href="#n165">165</a></p>

            </td>
            <td class="text">
<p id="t1" class="pln"><span class="com"># Copyright (c) 2017 Ansible Project</span><span class="strut">&nbsp;</span></p>
<p id="t2" class="pln"><span class="com"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span><span class="strut">&nbsp;</span></p>
<p id="t3" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t4" class="pln"><span class="com"># Make coding more python3-ish</span><span class="strut">&nbsp;</span></p>
<p id="t5" class="stm run hide_run"><span class="key">from</span> <span class="nam">__future__</span> <span class="key">import</span> <span class="op">(</span><span class="nam">absolute_import</span><span class="op">,</span> <span class="nam">division</span><span class="op">,</span> <span class="nam">print_function</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t6" class="stm run hide_run"><span class="nam">__metaclass__</span> <span class="op">=</span> <span class="nam">type</span><span class="strut">&nbsp;</span></p>
<p id="t7" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t8" class="stm run hide_run"><span class="key">import</span> <span class="nam">os</span><span class="strut">&nbsp;</span></p>
<p id="t9" class="stm run hide_run"><span class="key">import</span> <span class="nam">re</span><span class="strut">&nbsp;</span></p>
<p id="t10" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t11" class="stm run hide_run"><span class="key">from</span> <span class="nam">ansible</span> <span class="key">import</span> <span class="nam">constants</span> <span class="key">as</span> <span class="nam">C</span><span class="strut">&nbsp;</span></p>
<p id="t12" class="stm run hide_run"><span class="key">from</span> <span class="nam">ansible</span><span class="op">.</span><span class="nam">module_utils</span><span class="op">.</span><span class="nam">_text</span> <span class="key">import</span> <span class="nam">to_text</span><span class="strut">&nbsp;</span></p>
<p id="t13" class="stm run hide_run"><span class="key">from</span> <span class="nam">ansible</span><span class="op">.</span><span class="nam">module_utils</span> <span class="key">import</span> <span class="nam">six</span><span class="strut">&nbsp;</span></p>
<p id="t14" class="stm run hide_run"><span class="key">from</span> <span class="nam">ansible</span><span class="op">.</span><span class="nam">plugins</span><span class="op">.</span><span class="nam">loader</span> <span class="key">import</span> <span class="nam">connection_loader</span><span class="strut">&nbsp;</span></p>
<p id="t15" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t16" class="stm run hide_run"><span class="key">try</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t17" class="stm run hide_run">    <span class="key">from</span> <span class="nam">__main__</span> <span class="key">import</span> <span class="nam">display</span><span class="strut">&nbsp;</span></p>
<p id="t18" class="stm run hide_run"><span class="key">except</span> <span class="nam">ImportError</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t19" class="stm run hide_run">    <span class="key">from</span> <span class="nam">ansible</span><span class="op">.</span><span class="nam">utils</span><span class="op">.</span><span class="nam">display</span> <span class="key">import</span> <span class="nam">Display</span><span class="strut">&nbsp;</span></p>
<p id="t20" class="stm run hide_run">    <span class="nam">display</span> <span class="op">=</span> <span class="nam">Display</span><span class="op">(</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t21" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t22" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t23" class="stm run hide_run"><span class="key">def</span> <span class="nam">module_response_deepcopy</span><span class="op">(</span><span class="nam">v</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t24" class="pln">    <span class="str">"""Function to create a deep copy of module response data</span><span class="strut">&nbsp;</span></p>
<p id="t25" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t26" class="pln"><span class="str">    Designed to be used within the Ansible "engine" to improve performance</span><span class="strut">&nbsp;</span></p>
<p id="t27" class="pln"><span class="str">    issues where ``copy.deepcopy`` was used previously, largely with CPU</span><span class="strut">&nbsp;</span></p>
<p id="t28" class="pln"><span class="str">    and memory contention.</span><span class="strut">&nbsp;</span></p>
<p id="t29" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t30" class="pln"><span class="str">    This only supports the following data types, and was designed to only</span><span class="strut">&nbsp;</span></p>
<p id="t31" class="pln"><span class="str">    handle specific workloads:</span><span class="strut">&nbsp;</span></p>
<p id="t32" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t33" class="pln"><span class="str">    * ``dict``</span><span class="strut">&nbsp;</span></p>
<p id="t34" class="pln"><span class="str">    * ``list``</span><span class="strut">&nbsp;</span></p>
<p id="t35" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t36" class="pln"><span class="str">    The data we pass here will come from a serialization such</span><span class="strut">&nbsp;</span></p>
<p id="t37" class="pln"><span class="str">    as JSON, so we shouldn't have need for other data types such as</span><span class="strut">&nbsp;</span></p>
<p id="t38" class="pln"><span class="str">    ``set`` or ``tuple``.</span><span class="strut">&nbsp;</span></p>
<p id="t39" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t40" class="pln"><span class="str">    Take note that this function should not be used extensively as a</span><span class="strut">&nbsp;</span></p>
<p id="t41" class="pln"><span class="str">    replacement for ``deepcopy`` due to the naive way in which this</span><span class="strut">&nbsp;</span></p>
<p id="t42" class="pln"><span class="str">    handles other data types.</span><span class="strut">&nbsp;</span></p>
<p id="t43" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t44" class="pln"><span class="str">    Do not expect uses outside of those listed below to maintain</span><span class="strut">&nbsp;</span></p>
<p id="t45" class="pln"><span class="str">    backwards compatibility, in case we need to extend this function</span><span class="strut">&nbsp;</span></p>
<p id="t46" class="pln"><span class="str">    to handle our specific needs:</span><span class="strut">&nbsp;</span></p>
<p id="t47" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t48" class="pln"><span class="str">    * ``ansible.executor.task_result.TaskResult.clean_copy``</span><span class="strut">&nbsp;</span></p>
<p id="t49" class="pln"><span class="str">    * ``ansible.vars.clean.clean_facts``</span><span class="strut">&nbsp;</span></p>
<p id="t50" class="pln"><span class="str">    * ``ansible.vars.namespace_facts``</span><span class="strut">&nbsp;</span></p>
<p id="t51" class="pln"><span class="str">    """</span><span class="strut">&nbsp;</span></p>
<p id="t52" class="stm run hide_run">    <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">v</span><span class="op">,</span> <span class="nam">dict</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t53" class="stm run hide_run">        <span class="nam">ret</span> <span class="op">=</span> <span class="nam">v</span><span class="op">.</span><span class="nam">copy</span><span class="op">(</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t54" class="stm run hide_run">        <span class="nam">items</span> <span class="op">=</span> <span class="nam">six</span><span class="op">.</span><span class="nam">iteritems</span><span class="op">(</span><span class="nam">ret</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t55" class="stm run hide_run">    <span class="key">elif</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">v</span><span class="op">,</span> <span class="nam">list</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t56" class="stm run hide_run">        <span class="nam">ret</span> <span class="op">=</span> <span class="nam">v</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t57" class="stm run hide_run">        <span class="nam">items</span> <span class="op">=</span> <span class="nam">enumerate</span><span class="op">(</span><span class="nam">ret</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t58" class="pln">    <span class="key">else</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t59" class="stm run hide_run">        <span class="key">return</span> <span class="nam">v</span><span class="strut">&nbsp;</span></p>
<p id="t60" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t61" class="stm run hide_run">    <span class="key">for</span> <span class="nam">key</span><span class="op">,</span> <span class="nam">value</span> <span class="key">in</span> <span class="nam">items</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t62" class="stm run hide_run">        <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">value</span><span class="op">,</span> <span class="op">(</span><span class="nam">dict</span><span class="op">,</span> <span class="nam">list</span><span class="op">)</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t63" class="stm run hide_run">            <span class="nam">ret</span><span class="op">[</span><span class="nam">key</span><span class="op">]</span> <span class="op">=</span> <span class="nam">module_response_deepcopy</span><span class="op">(</span><span class="nam">value</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t64" class="pln">        <span class="key">else</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t65" class="stm run hide_run">            <span class="nam">ret</span><span class="op">[</span><span class="nam">key</span><span class="op">]</span> <span class="op">=</span> <span class="nam">value</span><span class="strut">&nbsp;</span></p>
<p id="t66" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t67" class="stm run hide_run">    <span class="key">return</span> <span class="nam">ret</span><span class="strut">&nbsp;</span></p>
<p id="t68" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t69" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t70" class="stm run hide_run"><span class="key">def</span> <span class="nam">strip_internal_keys</span><span class="op">(</span><span class="nam">dirty</span><span class="op">,</span> <span class="nam">exceptions</span><span class="op">=</span><span class="nam">None</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t71" class="pln">    <span class="str">'''</span><span class="strut">&nbsp;</span></p>
<p id="t72" class="pln"><span class="str">    All keys starting with _ansible_ are internal, so create a copy of the 'dirty' dict</span><span class="strut">&nbsp;</span></p>
<p id="t73" class="pln"><span class="str">    and remove them from the clean one before returning it</span><span class="strut">&nbsp;</span></p>
<p id="t74" class="pln"><span class="str">    '''</span><span class="strut">&nbsp;</span></p>
<p id="t75" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t76" class="stm run hide_run">    <span class="key">if</span> <span class="nam">exceptions</span> <span class="key">is</span> <span class="nam">None</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t77" class="stm run hide_run">        <span class="nam">exceptions</span> <span class="op">=</span> <span class="op">(</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t78" class="stm run hide_run">    <span class="nam">clean</span> <span class="op">=</span> <span class="nam">dirty</span><span class="op">.</span><span class="nam">copy</span><span class="op">(</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t79" class="stm run hide_run">    <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">dirty</span><span class="op">.</span><span class="nam">keys</span><span class="op">(</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t80" class="stm run hide_run">        <span class="key">if</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">k</span><span class="op">,</span> <span class="nam">six</span><span class="op">.</span><span class="nam">string_types</span><span class="op">)</span> <span class="key">and</span> <span class="nam">k</span><span class="op">.</span><span class="nam">startswith</span><span class="op">(</span><span class="str">'_ansible_'</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t81" class="stm run hide_run">            <span class="key">if</span> <span class="nam">k</span> <span class="key">not</span> <span class="key">in</span> <span class="nam">exceptions</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t82" class="stm run hide_run">                <span class="key">del</span> <span class="nam">clean</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t83" class="stm run hide_run">        <span class="key">elif</span> <span class="nam">isinstance</span><span class="op">(</span><span class="nam">dirty</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span><span class="op">,</span> <span class="nam">dict</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t84" class="stm run hide_run">            <span class="nam">clean</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span> <span class="op">=</span> <span class="nam">strip_internal_keys</span><span class="op">(</span><span class="nam">dirty</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t85" class="stm run hide_run">    <span class="key">return</span> <span class="nam">clean</span><span class="strut">&nbsp;</span></p>
<p id="t86" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t87" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t88" class="stm run hide_run"><span class="key">def</span> <span class="nam">remove_internal_keys</span><span class="op">(</span><span class="nam">data</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t89" class="pln">    <span class="str">'''</span><span class="strut">&nbsp;</span></p>
<p id="t90" class="pln"><span class="str">    More nuanced version of strip_internal_keys</span><span class="strut">&nbsp;</span></p>
<p id="t91" class="pln"><span class="str">    '''</span><span class="strut">&nbsp;</span></p>
<p id="t92" class="stm run hide_run">    <span class="key">for</span> <span class="nam">key</span> <span class="key">in</span> <span class="nam">list</span><span class="op">(</span><span class="nam">data</span><span class="op">.</span><span class="nam">keys</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t93" class="stm par run hide_run"><span class="annotate short">93&#x202F;&#x219B;&#x202F;94</span><span class="annotate long">line 93 didn't jump to line 94, because the condition on line 93 was never true</span>        <span class="key">if</span> <span class="op">(</span><span class="nam">key</span><span class="op">.</span><span class="nam">startswith</span><span class="op">(</span><span class="str">'_ansible_'</span><span class="op">)</span> <span class="key">and</span> <span class="nam">key</span> <span class="op">!=</span> <span class="str">'_ansible_parsed'</span><span class="op">)</span> <span class="key">or</span> <span class="nam">key</span> <span class="key">in</span> <span class="nam">C</span><span class="op">.</span><span class="nam">INTERNAL_RESULT_KEYS</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t94" class="stm mis">            <span class="nam">display</span><span class="op">.</span><span class="nam">warning</span><span class="op">(</span><span class="str">"Removed unexpected internal key in module return: %s = %s"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">key</span><span class="op">,</span> <span class="nam">data</span><span class="op">[</span><span class="nam">key</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t95" class="stm mis">            <span class="key">del</span> <span class="nam">data</span><span class="op">[</span><span class="nam">key</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t96" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t97" class="pln">    <span class="com"># remove bad/empty internal keys</span><span class="strut">&nbsp;</span></p>
<p id="t98" class="stm run hide_run">    <span class="key">for</span> <span class="nam">key</span> <span class="key">in</span> <span class="op">[</span><span class="str">'warnings'</span><span class="op">,</span> <span class="str">'deprecations'</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t99" class="stm run hide_run">        <span class="key">if</span> <span class="nam">key</span> <span class="key">in</span> <span class="nam">data</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">data</span><span class="op">[</span><span class="nam">key</span><span class="op">]</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t100" class="stm run hide_run">            <span class="key">del</span> <span class="nam">data</span><span class="op">[</span><span class="nam">key</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t101" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t102" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t103" class="stm run hide_run"><span class="key">def</span> <span class="nam">clean_facts</span><span class="op">(</span><span class="nam">facts</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t104" class="pln">    <span class="str">''' remove facts that can override internal keys or otherwise deemed unsafe '''</span><span class="strut">&nbsp;</span></p>
<p id="t105" class="stm run hide_run">    <span class="nam">data</span> <span class="op">=</span> <span class="nam">module_response_deepcopy</span><span class="op">(</span><span class="nam">facts</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t106" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t107" class="stm run hide_run">    <span class="nam">remove_keys</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t108" class="stm run hide_run">    <span class="nam">fact_keys</span> <span class="op">=</span> <span class="nam">set</span><span class="op">(</span><span class="nam">data</span><span class="op">.</span><span class="nam">keys</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t109" class="pln">    <span class="com"># first we add all of our magic variable names to the set of</span><span class="strut">&nbsp;</span></p>
<p id="t110" class="pln">    <span class="com"># keys we want to remove from facts</span><span class="strut">&nbsp;</span></p>
<p id="t111" class="pln">    <span class="com"># NOTE: these will eventually disappear in favor of others below</span><span class="strut">&nbsp;</span></p>
<p id="t112" class="stm run hide_run">    <span class="key">for</span> <span class="nam">magic_var</span> <span class="key">in</span> <span class="nam">C</span><span class="op">.</span><span class="nam">MAGIC_VARIABLE_MAPPING</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t113" class="stm run hide_run">        <span class="nam">remove_keys</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="nam">fact_keys</span><span class="op">.</span><span class="nam">intersection</span><span class="op">(</span><span class="nam">C</span><span class="op">.</span><span class="nam">MAGIC_VARIABLE_MAPPING</span><span class="op">[</span><span class="nam">magic_var</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t114" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t115" class="pln">    <span class="com"># remove common connection vars</span><span class="strut">&nbsp;</span></p>
<p id="t116" class="stm run hide_run">    <span class="nam">remove_keys</span><span class="op">.</span><span class="nam">update</span><span class="op">(</span><span class="nam">fact_keys</span><span class="op">.</span><span class="nam">intersection</span><span class="op">(</span><span class="nam">C</span><span class="op">.</span><span class="nam">COMMON_CONNECTION_VARS</span><span class="op">)</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t117" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t118" class="pln">    <span class="com"># next we remove any connection plugin specific vars</span><span class="strut">&nbsp;</span></p>
<p id="t119" class="stm run hide_run">    <span class="key">for</span> <span class="nam">conn_path</span> <span class="key">in</span> <span class="nam">connection_loader</span><span class="op">.</span><span class="nam">all</span><span class="op">(</span><span class="nam">path_only</span><span class="op">=</span><span class="nam">True</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t120" class="stm run hide_run">        <span class="key">try</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t121" class="stm run hide_run">            <span class="nam">conn_name</span> <span class="op">=</span> <span class="nam">os</span><span class="op">.</span><span class="nam">path</span><span class="op">.</span><span class="nam">splitext</span><span class="op">(</span><span class="nam">os</span><span class="op">.</span><span class="nam">path</span><span class="op">.</span><span class="nam">basename</span><span class="op">(</span><span class="nam">conn_path</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t122" class="stm run hide_run">            <span class="nam">re_key</span> <span class="op">=</span> <span class="nam">re</span><span class="op">.</span><span class="nam">compile</span><span class="op">(</span><span class="str">'^ansible_%s_'</span> <span class="op">%</span> <span class="nam">conn_name</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t123" class="stm run hide_run">            <span class="key">for</span> <span class="nam">fact_key</span> <span class="key">in</span> <span class="nam">fact_keys</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t124" class="pln">                <span class="com"># most lightweight VM or container tech creates devices with this pattern, this avoids filtering them out</span><span class="strut">&nbsp;</span></p>
<p id="t125" class="stm par run hide_run"><span class="annotate short">125&#x202F;&#x219B;&#x202F;123,&nbsp;&nbsp; 125&#x202F;&#x219B;&#x202F;126</span><span class="annotate long">2 missed branches: 1) line 125 didn't jump to line 123, because the condition on line 125 was never false, 2) line 125 didn't jump to line 126, because the condition on line 125 was never true</span>                <span class="key">if</span> <span class="op">(</span><span class="nam">re_key</span><span class="op">.</span><span class="nam">match</span><span class="op">(</span><span class="nam">fact_key</span><span class="op">)</span> <span class="key">and</span> <span class="key">not</span> <span class="nam">fact_key</span><span class="op">.</span><span class="nam">endswith</span><span class="op">(</span><span class="op">(</span><span class="str">'_bridge'</span><span class="op">,</span> <span class="str">'_gwbridge'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="key">or</span> <span class="nam">re_key</span><span class="op">.</span><span class="nam">startswith</span><span class="op">(</span><span class="str">'ansible_become_'</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t126" class="stm mis">                    <span class="nam">remove_keys</span><span class="op">.</span><span class="nam">add</span><span class="op">(</span><span class="nam">fact_key</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t127" class="stm run hide_run">        <span class="key">except</span> <span class="nam">AttributeError</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t128" class="stm run hide_run">            <span class="key">pass</span><span class="strut">&nbsp;</span></p>
<p id="t129" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t130" class="pln">    <span class="com"># remove some KNOWN keys</span><span class="strut">&nbsp;</span></p>
<p id="t131" class="stm run hide_run">    <span class="key">for</span> <span class="nam">hard</span> <span class="key">in</span> <span class="nam">C</span><span class="op">.</span><span class="nam">RESTRICTED_RESULT_KEYS</span> <span class="op">+</span> <span class="nam">C</span><span class="op">.</span><span class="nam">INTERNAL_RESULT_KEYS</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t132" class="stm par run hide_run"><span class="annotate short">132&#x202F;&#x219B;&#x202F;133</span><span class="annotate long">line 132 didn't jump to line 133, because the condition on line 132 was never true</span>        <span class="key">if</span> <span class="nam">hard</span> <span class="key">in</span> <span class="nam">fact_keys</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t133" class="stm mis">            <span class="nam">remove_keys</span><span class="op">.</span><span class="nam">add</span><span class="op">(</span><span class="nam">hard</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t134" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t135" class="pln">    <span class="com"># finally, we search for interpreter keys to remove</span><span class="strut">&nbsp;</span></p>
<p id="t136" class="stm run hide_run">    <span class="nam">re_interp</span> <span class="op">=</span> <span class="nam">re</span><span class="op">.</span><span class="nam">compile</span><span class="op">(</span><span class="str">'^ansible_.*_interpreter$'</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t137" class="stm run hide_run">    <span class="key">for</span> <span class="nam">fact_key</span> <span class="key">in</span> <span class="nam">fact_keys</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t138" class="stm par run hide_run"><span class="annotate short">138&#x202F;&#x219B;&#x202F;139</span><span class="annotate long">line 138 didn't jump to line 139, because the condition on line 138 was never true</span>        <span class="key">if</span> <span class="nam">re_interp</span><span class="op">.</span><span class="nam">match</span><span class="op">(</span><span class="nam">fact_key</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t139" class="stm mis">            <span class="nam">remove_keys</span><span class="op">.</span><span class="nam">add</span><span class="op">(</span><span class="nam">fact_key</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t140" class="pln">    <span class="com"># then we remove them (except for ssh host keys)</span><span class="strut">&nbsp;</span></p>
<p id="t141" class="stm par run hide_run"><span class="annotate short">141&#x202F;&#x219B;&#x202F;142</span><span class="annotate long">line 141 didn't jump to line 142, because the loop on line 141 never started</span>    <span class="key">for</span> <span class="nam">r_key</span> <span class="key">in</span> <span class="nam">remove_keys</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t142" class="stm mis">        <span class="key">if</span> <span class="key">not</span> <span class="nam">r_key</span><span class="op">.</span><span class="nam">startswith</span><span class="op">(</span><span class="str">'ansible_ssh_host_key_'</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t143" class="stm mis">            <span class="key">try</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t144" class="stm mis">                <span class="nam">r_val</span> <span class="op">=</span> <span class="nam">to_text</span><span class="op">(</span><span class="nam">data</span><span class="op">[</span><span class="nam">r_key</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t145" class="stm mis">                <span class="key">if</span> <span class="nam">len</span><span class="op">(</span><span class="nam">r_val</span><span class="op">)</span> <span class="op">></span> <span class="num">24</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t146" class="stm mis">                    <span class="nam">r_val</span> <span class="op">=</span> <span class="str">'%s ... %s'</span> <span class="op">%</span> <span class="op">(</span><span class="nam">r_val</span><span class="op">[</span><span class="op">:</span><span class="num">13</span><span class="op">]</span><span class="op">,</span> <span class="nam">r_val</span><span class="op">[</span><span class="op">-</span><span class="num">6</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t147" class="stm mis">            <span class="key">except</span> <span class="nam">Exception</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t148" class="stm mis">                <span class="nam">r_val</span> <span class="op">=</span> <span class="str">' &lt;failed to convert value to a string> '</span><span class="strut">&nbsp;</span></p>
<p id="t149" class="stm mis">            <span class="nam">display</span><span class="op">.</span><span class="nam">warning</span><span class="op">(</span><span class="str">"Removed restricted key from module data: %s = %s"</span> <span class="op">%</span> <span class="op">(</span><span class="nam">r_key</span><span class="op">,</span> <span class="nam">r_val</span><span class="op">)</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t150" class="stm mis">            <span class="key">del</span> <span class="nam">data</span><span class="op">[</span><span class="nam">r_key</span><span class="op">]</span><span class="strut">&nbsp;</span></p>
<p id="t151" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t152" class="stm run hide_run">    <span class="key">return</span> <span class="nam">strip_internal_keys</span><span class="op">(</span><span class="nam">data</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t153" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t154" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t155" class="stm run hide_run"><span class="key">def</span> <span class="nam">namespace_facts</span><span class="op">(</span><span class="nam">facts</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t156" class="pln">    <span class="str">''' return all facts inside 'ansible_facts' w/o an ansible_ prefix '''</span><span class="strut">&nbsp;</span></p>
<p id="t157" class="stm run hide_run">    <span class="nam">deprefixed</span> <span class="op">=</span> <span class="op">{</span><span class="op">}</span><span class="strut">&nbsp;</span></p>
<p id="t158" class="stm run hide_run">    <span class="key">for</span> <span class="nam">k</span> <span class="key">in</span> <span class="nam">facts</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t159" class="stm par run hide_run"><span class="annotate short">159&#x202F;&#x219B;&#x202F;161</span><span class="annotate long">line 159 didn't jump to line 161, because the condition on line 159 was never true</span>        <span class="key">if</span> <span class="nam">k</span> <span class="key">in</span> <span class="op">(</span><span class="str">'ansible_local'</span><span class="op">,</span><span class="op">)</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t160" class="pln">            <span class="com"># exceptions to 'deprefixing'</span><span class="strut">&nbsp;</span></p>
<p id="t161" class="stm mis">            <span class="nam">deprefixed</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span> <span class="op">=</span> <span class="nam">module_response_deepcopy</span><span class="op">(</span><span class="nam">facts</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t162" class="pln">        <span class="key">else</span><span class="op">:</span><span class="strut">&nbsp;</span></p>
<p id="t163" class="stm run hide_run">            <span class="nam">deprefixed</span><span class="op">[</span><span class="nam">k</span><span class="op">.</span><span class="nam">replace</span><span class="op">(</span><span class="str">'ansible_'</span><span class="op">,</span> <span class="str">''</span><span class="op">,</span> <span class="num">1</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="nam">module_response_deepcopy</span><span class="op">(</span><span class="nam">facts</span><span class="op">[</span><span class="nam">k</span><span class="op">]</span><span class="op">)</span><span class="strut">&nbsp;</span></p>
<p id="t164" class="pln"><span class="strut">&nbsp;</span></p>
<p id="t165" class="stm run hide_run">    <span class="key">return</span> <span class="op">{</span><span class="str">'ansible_facts'</span><span class="op">:</span> <span class="nam">deprefixed</span><span class="op">}</span><span class="strut">&nbsp;</span></p>

            </td>
        </tr>
    </table>
</div>

<div id="footer">
    <div class="content">
        <p>
            <a class="nav" href="index.html">&#xab; index</a> &nbsp; &nbsp; <a class="nav" href="https://coverage.readthedocs.io">coverage.py v4.5.2</a>,
            created at 2019-05-13 15:45
        </p>
    </div>
</div>

</body>
</html>
