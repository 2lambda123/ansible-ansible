---

# Look at git diff

# Build command line
# FIXME extra parsing options
# Q: We don't know what to replace unknowns with as how do we know {PLATFORM} at this point? Do we need one classification job per {platform}?
# display output

# Add jobs via Zuul


###
# Run ansible-test
#

- name: Build test options
  set_fact:
    # FIXME Correctly set basebranch
    standard_options: '--color no --tox --continue-on-error'
    #test_targets: "{{ platform }}_.*"
    test_targets: "{{ platform }}_command" # Needs to be passed in via job

- name: Run ansible-test network-integration
  command: "{{ ansible_path }}/test/runner/ansible-test network-integration --inventory /var/lib/network-image-builder/output/{{ platform }}/inventory {{ standard_options }} --python {{ python_version }} {{ test_targets }}"

##
# Check for failures
#

- name: Remove temporary results file
  file:
    path: "{{ ansible_path }}/test/results/bot/ansible-test-failure.json"
    state: absent

- name: Examine results files
  find:
    path: "{{ ansible_path }}/test/results/bot"
    patterns: "ansible-test-*.json"
  register: results_files

- name: Check for failing tests
  fail:
    msg: One or more tests have failed
  when:
    results_files.matched
