# This file is part of Ansible

# Copyright: (c) 2018, Wojciech Sciesinski <wojciech[at]sciesinski[dot]net>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

---

- name: install updated NuGet version
  win_shell: 'Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force'

- name: check setting of InstallationPolicy
  win_psrepository:
    name: PSGallery
    source: "{{ PSGallery_url }}"
    installation_policy: trusted
  register: change_installation_policy_1

- name: get result of setting of InstallationPolicy
  win_shell: '(Get-PSRepository -Name PSGallery).InstallationPolicy'
  changed_when: false
  register: result_change_installation_policy_1

- name: test check setting of InstallationPolicy
  assert:
    that:
      - "change_installation_policy_1 is changed"
      - "'{{ result_change_installation_policy_1.stdout | trim }}' == 'Trusted'"

- name: check idempotency setting of InstallationPolicy
  win_psrepository:
    name: PSGallery
    source: "{{ PSGallery_url }}"
    installation_policy: trusted
  register: change_installation_policy_2

- name: test idempotency setting of InstallationPolicy
  assert:
    that:
      - "change_installation_policy_2 is not changed"

- name: check adding of repository
  win_psrepository:
    name: "{{ repository_name }}"
    source: "{{ repository_sourcelocation }}"
    state: present
  register: adding_repository_1

- name: get result of adding of repository 1
  win_shell: |
    $repo = Get-PSRepository -Name {{ repository_name|quote }} -ErrorAction Stop
    $repo.SourceLocation
    $repo.InstallationPolicy
  changed_when: false
  register: result_adding_repository_1

- name: test adding of repository
  assert:
      that:
        - "adding_repository_1 is changed"
        - "'{{ result_adding_repository_1.stdout_lines[0] }}' == '{{ repository_sourcelocation }}'"
        - "'{{ result_adding_repository_1.stdout_lines[1] }}' == 'Trusted'"

- name: check idempotency adding of repository
  win_psrepository:
    name: "{{ repository_name }}"
    source: "{{ repository_sourcelocation }}"
    state: present
  register: adding_repository_2

- name: test idempotency adding of repository
  assert:
      that:
        - "adding_repository_2 is not changed"

- name: check removing of repository
  win_psrepository:
    name: "{{ repository_name }}"
    state: absent
  register: removing_repository_1

- name: get result removing  of repository 1
  win_shell: '((Get-PSRepository -Name {{ repository_name }} -ErrorAction Ignore | Measure-Object).Count -eq 0)'
  changed_when: false
  register: result_removing_repository_1

- name: test removing of repository
  assert:
    that:
      - "removing_repository_1 is changed"
      - "'{{ result_removing_repository_1.stdout | trim }}' == 'True'"

- name: check removing of repository idempotency
  win_psrepository:
    name: "{{ repository_name }}"
    state: absent
  register: removing_repository_2

- name: test removing of repository idempotency
  assert:
    that:
      - "removing_repository_2 is not changed"

- name: check adding of repository - 3
  win_psrepository:
    name: "{{ repository_name }}"
    source: "{{ repository_sourcelocation }}"
    installation_policy: untrusted
    state: present
  register: adding_repository_3

- name: get result of adding of repository 3 - 1
  win_shell: '((Get-PSRepository -Name {{ repository_name }} | Measure-Object).Count -eq 1)'
  changed_when: false
  register: result_adding_repository_3_1

- name: get result of adding of repository 3 - 2
  win_shell: '(Get-PSRepository -Name {{ repository_name }}).SourceLocation'
  changed_when: false
  register: result_adding_repository_3_2

- name: get result of adding of repository 3 - 3
  win_shell: '(Get-PSRepository -Name {{ repository_name }}).InstallationPolicy'
  changed_when: false
  register: result_adding_repository_3_3

- name: test adding of repository
  assert:
      that:
        - "adding_repository_3 is changed"
        - "'{{ result_adding_repository_3_1.stdout | trim }}' == 'True'"
        - "'{{ result_adding_repository_3_2.stdout | trim }}' == '{{ repository_sourcelocation }}'"
        - "'{{ result_adding_repository_3_3.stdout | trim }}' == 'Untrusted'"
