# This file is part of Ansible

# Copyright: (c) 2020, Brian Scholer <@briantist>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Add a repository with a redirected URL (check mode)
  win_psrepository:
    name: "{{ repository_name }}"
    source_location: "{{ redirect_1_url }}"
  check_mode: True
  register: redirect_add_check

- name: Assert that task response is changed
  assert:
    that:
      - redirect_add_check is changed

- import_tasks: get_repo_info.yml

- name: Assert that the repository was not created (check mode)
  assert:
    that:
      - not repo_result.exists

- name: Add a repository with a redirected URL
  win_psrepository:
    name: "{{ repository_name }}"
    source_location: "{{ redirect_1_url }}"
  register: redirect_add_check

- name: Assert that task response is changed
  assert:
    that:
      - redirect_add_check is changed

- import_tasks: get_repo_info.yml

- name: Assert that the repository was created with expected destination
  assert:
    that:
      - repo_result.exists
      - repo_result.repo.SourceLocation == redirect_1_expected_target

