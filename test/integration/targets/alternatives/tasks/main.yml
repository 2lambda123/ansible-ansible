# (c) 2014, James Tanner <tanner.jc@gmail.com>

# This file is part of Ansible
#
# Ansible is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Ansible is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.

- name: 'setup: create a dummy alternative'
  block:
  - import_tasks: setup.yml

  ##############
  # Test parameters:
  # link parameter present / absent ('with_link' variable)
  # with / without alternatives defined in alternatives file ('with_alternatives' variable)
  # auto / manual ('mode' variable)

  - include_tasks: tests.yml
    vars:
      mode: auto
    with_nested:
        - [ True, False ] # with_link
        - [ True, False ] # with_alternatives
    loop_control:
      loop_var: test_conf

  - include_tasks: tests.yml
    vars:
      mode: manual
    with_nested:
        - [ True, False ] # with_link
        - [ True, False ] # with_alternatives
    loop_control:
      loop_var: test_conf

  ##########
  # Priority
  - block:
    - include_tasks: remove_links.yml
    - include_tasks: setup_test.yml
    # at least two iterations again
    - include_tasks: tests_set_priority.yml
      with_sequence: start=3 end=4
    vars:
      with_alternatives: True
      mode: auto

  - block:
    - include_tasks: remove_links.yml
    - include_tasks: setup_test.yml
    # at least two iterations again
    - include_tasks: tests_set_priority.yml
      with_sequence: start=3 end=4
    vars:
      with_alternatives: False
      mode: auto
  always:
    - include_tasks: remove_links.yml

    - file:
        path: '{{ item }}'
        state: absent
      with_items:
        - '{{ alternatives_dir }}/dummy'

    - file:
        path: '/usr/bin/dummy{{ item }}'
        state: absent
      with_sequence: start=1 end=4
  # *Disable tests on Fedora 24*
  # Shippable Fedora 24 image provides chkconfig-1.7-2.fc24.x86_64 but not the
  # latest available version (chkconfig-1.8-1.fc24.x86_64). update-alternatives
  # in chkconfig-1.7-2 fails when /etc/alternatives/dummy link is missing,
  # error is: 'failed to read link /usr/bin/dummy: No such file or directory'.
  # Moreover Fedora 24 is no longer maintained.
  when: ansible_distribution != 'Fedora' or ansible_distribution_major_version|int > 24
