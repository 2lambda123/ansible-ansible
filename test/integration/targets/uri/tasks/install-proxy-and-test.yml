- when: ansible_facts.distribution not in ['MacOSX']
  vars:
    packages:
      - tinyproxy
  block:
    - name: install packages for proxy testing
      package:
        name: '{{ item }}'
        state: present
      register: proxy_install_package
      when: ansible_facts.distribution not in ['Alpine']
      loop: '{{ packages }}'

    - name: install packages for proxy testing for alpine
      command: apk add --virtual .{{ item }} {{ item }}
      register: proxy_install_alpine
      when: ansible_facts.distribution == 'Alpine'
      loop: '{{ packages }}'

    - include_tasks: proxy.yml
  always:
    - name: uninstall packages for proxy testing
      package:
        name: '{{ item }}'
        state: absent
      when: proxy_install_package.results[idx]|default({}) is changed
      loop: '{{ packages }}'
      loop_control:
        index_var: idx

    - name: uninstall packages for proxy testing for alpine
      command: apk del .{{ item }}
      when:
        - proxy_install_alpine|default({}) is changed
        - >-
          'Installing ' ~ item in proxy_install_alpine.results[idx].stdout
      loop: '{{ packages }}'
      loop_control:
        index_var: idx
