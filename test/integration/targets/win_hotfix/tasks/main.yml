# There are manual tests that can be run on a fresh Server 2012 R2 install
# from the evaluation ISO, these are run when test_win_hotfix_manual_run
# is set to True
---
- name: filter servers that can support DISM
  win_command: powershell.exe "Import-Module -Name DISM"
  register: eligable_servers
  ignore_errors: True

- name: fail to run module on servers that don't support DISM
  win_hotfix:
    path: fake
    state: present
  register: fail_no_dism
  failed_when: fail_no_dism.msg != 'The DISM PS module needs to be installed, this can be done through the windows-adk chocolately package'
  when: eligable_servers.rc != 0

- name: run tests on hosts that support DISM
  include_tasks: tests.yml
  when: eligable_servers.rc == 0

- name: run manual tests if flag is set
  include_tasks: manual_tests.yml
  when: eligable_servers.rc == 0 and test_win_hotfix_manual_run == True
