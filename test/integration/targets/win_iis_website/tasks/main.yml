---
# Cannot use win_feature to install IIS on Server 2008.
# Run a brief check and skip hosts that don't support
# that operation
- name: check if win_feature will work on test host
  win_command: powershell.exe "Get-WindowsFeature"
  register: module_available
  failed_when: False

# Run actual tests
- block:
  # Setup for tests
  - name: this is too finicky reboot before feature install
    win_reboot:

  - name: ensure IIS features are installed
    win_feature:
      name: Web-Server
      state: present
      includ_sub_features: True
      include_management_tools: True
    register: feature_install

  - name: reboot after feature install
    win_reboot:
    when: feature_install.reboot_required
  
  - name: ensure test path is present
    win_file:
      path: '{{item}}'
      state: directory
    with_items:
    - '{{test_iis_website_path}}'
    - '{{test_iis_website_path2}}'

  - name: ensure the app pool is present
    win_iis_webapppool:
      name: '{{test_iis_application_pool}}'
      state: started
  
  - name: ensure test site is removed before test
    win_iis_website:
      name: '{{item}}'
      state: absent
    with_items:
    - '{{test_iis_website_name}}'
    - Default Web Site

  # Tests
  - name: run tests on hosts that support it
    include_tasks: tests.yml
  
  always:
  # cleanup
  - name: ensure test site is deleted
    win_iis_website:
      name: '{{test_iis_website_name}}'
      state: absent

  - name: remove IIS features after test
    win_feature:
      name: Web-Server
      state: absent
      includ_sub_features: True
      include_management_tools: True
    register: feature_uninstall
  
  - name: reboot after feature install
    win_reboot:
    when: feature_uninstall.reboot_required

  when: module_available.rc == 0
