- name: set up aws connection info
  set_fact:
    aws_connection_info: &aws_connection_info
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token }}"
      region: "{{ ec2_region }}"
  no_log: yes

- name: Check mode - inserting db record
  aws_dynamodb_item:
    table: "{{ dynamo_db_table }}"
    state: present
    primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
    update_expression: "SET person =:person"
    expression_attribute_values: {":person": {"S": "ochoa"}}
    <<: *aws_connection_info
  register: result
  check_mode: yes
- name: assert status
  assert:
    that:
      - result.changed

- name: Check mode - updating db record with the status protected word
  aws_dynamodb_item:
    table: "{{ dynamo_db_table }}"
    state: present
    primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
    update_expression: 'SET #s =:status'
    expression_attribute_values: {":status": {"S": "red"}}
    expression_attribute_names: {"#s": "status"}
    <<: *aws_connection_info
  register: result
  check_mode: yes
- name: assert status
  assert:
    that:
      - result.changed

- name: Check mode - updating to delete attribute 'person' in previously added db record
  aws_dynamodb_item:
    table: "{{ dynamo_db_table }}"
    state: present
    primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
    update_expression: 'REMOVE person'
    <<: *aws_connection_info
  register: result
  check_mode: yes
- name: assert status
  assert:
    that:
      - result.changed

- name: Check mode - deletes a single db record
  aws_dynamodb_item:
    table: "{{ dynamo_db_table }}"
    state: absent
    primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
    <<: *aws_connection_info
  register: result
  check_mode: yes
- name: assert status
  assert:
    that:
      - result.changed
