---
# tasks file for testing aws_dynamodb_item module

- block:

    - name: set up aws connection info
      set_fact:
        aws_connection_info: &aws_connection_info
          aws_access_key: "{{ aws_access_key }}"
          aws_secret_key: "{{ aws_secret_key }}"
          security_token: "{{ security_token }}"
          region: "{{ ec2_region }}"
      no_log: yes

    - name: create dynamodb database
      dynamodb_table:
        name: "{{ dynamo_db_table }}"
        hash_key_name: bank
        hash_key_type: STRING
        range_key_name: quantity
        range_key_type: NUMBER
        # tag necessary so it waits until table creation
        tags:
          ansible_test: integration
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: inserting db record
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: "SET person =:person"
        expression_attribute_values: {":person": {"S": "ochoa"}}
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: Check mode - inserting db record
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: "SET person =:person"
        expression_attribute_values: {":person": {"S": "ochoa"}}
        <<: *aws_connection_info
      register: result
      check_mode: yes
    - name: assert status
      assert:
        that:
          - result.changed

    - name: inserting db record with a primary record that already exists
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: "SET person =:person"
        expression_attribute_values: {":person": {"S": "ochoa"}}
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: adding protected field status (protected word)
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'SET #s =:status'
        expression_attribute_values: {":status": {"S": "red"}}
        expression_attribute_names: {"#s": "status"}
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    # - name: gets previously updated item
    #   aws_dynamodb_item:
    #     table: "{{ dynamo_db_table }}"
    #     action: get
    #     filter_expression: 'bank = :bank_name AND quantity = :number'
    #     expression_attribute_values: {":bank_name": {"S": "hsbc"}, ":number": {"N": "1000"}}
    #     <<: *aws_connection_info
    #   register: result
    # - name: assert data is correct
    #   assert:
    #     that:
    #       - '''[{"bank": {"s": "hsbc"}, "quantity": {"n": "1000"}, "person": {"s": "ochoa"}, "status": {"s": "blue"}}] in result.returned_items'''

    - name: inserting db record on a table that doesnt exist
      aws_dynamodb_item:
        table: "willfail"
        state: present
        primary_key: {"bank": {"S": "hsbc"}}
        <<: *aws_connection_info
      ignore_errors: yes
      register: result
    - name: assert failure
      assert:
        that:
          - result.failed
          - '"Table willfail doesnt exist" in result.msg'

    - name: missing primary_key parameter
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        expression_attribute_values: {":status": {"S": "red"}}
        <<: *aws_connection_info
      ignore_errors: yes
      register: result
    - name: assert failure
      assert:
        that:
          - result.failed
          - '"missing required arguments: primary_key" in result.msg'

    - name: invalid primary_key when updating
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"willfail": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'SET #s =:status'
        expression_attribute_values: {":status": {"S": "red"}}
        expression_attribute_names: {"#s": "status"}
        <<: *aws_connection_info
      ignore_errors: yes
      register: result
    - name: assert failure
      assert:
        that:
          - result.failed
          - '"Check the primary key, it doesnt match your table config" in result.msg'

    - name: updating db record with the status protected word
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'SET #s =:status'
        expression_attribute_values: {":status": {"S": "red"}}
        expression_attribute_names: {"#s": "status"}
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: Check mode - updating db record with the status protected word
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'SET #s =:status'
        expression_attribute_values: {":status": {"S": "red"}}
        expression_attribute_names: {"#s": "status"}
        <<: *aws_connection_info
      register: result
      check_mode: yes
    - name: assert status
      assert:
        that:
          - result.changed

    - name: updating a protected word without expression_attribute_names
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'SET status =:status'
        expression_attribute_values: {":status": {"S": "blue"}}
        <<: *aws_connection_info
      ignore_errors: yes
      register: result
    - name: assert failure
      assert:
        that:
          - result.failed
          - '"You are trying to use a DynamoDB reserved word" in result.msg'

    # - name: Gets a single item
    #   aws_dynamodb_item:
    #     table: "{{ dynamo_db_table }}"
    #     action: get
    #     filter_expression: 'bank = :bank_name AND quantity = :number'
    #     expression_attribute_values: {":bank_name": {"S": "hsbc"}, ":number": {"N": "1000"}}
    #     <<: *aws_connection_info
    #   register: result
    # - name: assert data is correct
    #   assert:
    #     that:
    #       - '''[{"bank": {"s": "hsbc"}, "quantity": {"n": "1000"}, "person": {"s": "ochoa"}, "status": {"s": "red"}}] in result.returned_items'''

    # - name: Gets an item that doesnt exist
    #   aws_dynamodb_item:
    #     table: "{{ dynamo_db_table }}"
    #     action: get
    #     filter_expression: 'bank = :bank_name AND quantity = :number'
    #     expression_attribute_values: {":bank_name": {"S": "willfail"}, ":number": {"N": "1000"}}
    #     <<: *aws_connection_info
    #   register: result
    # - name: assert data is correct
    #   assert:
    #     that:
    #       - '''[] in result.returned_items'''

    - name: updating to delete attribute 'person' in previously added db record
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'REMOVE person'
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: Check mode - updating to delete attribute 'person' in previously added db record
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: present
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        update_expression: 'REMOVE person'
        <<: *aws_connection_info
      register: result
      check_mode: yes
    - name: assert status
      assert:
        that:
          - result.changed

    # - name: Gets a single item
    #   aws_dynamodb_item:
    #     table: "{{ dynamo_db_table }}"
    #     action: get
    #     filter_expression: 'bank = :bank_name AND quantity = :number'
    #     expression_attribute_values: {":bank_name": {"S": "hsbc"}, ":number": {"N": "1000"}}
    #     <<: *aws_connection_info
    #   register: result
    # - name: assert that person is no longer present
    #   assert:
    #     that:
    #       - '''[{"bank": {"s": "hsbc"}, "quantity": {"n": "1000"}, "status": {"s": "red"}}] in result.returned_items'''

    - name: deletes a single db record that doesnt match conditional expression (doesnt exist)
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: absent
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "2000"}}
        condition_expression: quantity =:quantity
        expression_attribute_values: {":quantity": {"N": "2000"}}
        <<: *aws_connection_info
      ignore_errors: yes
      register: result
    - name: assert failure
      assert:
        that:
          - result.failed
          - '"No item matching your conditional expression" in result.msg'

    - name: deletes a single db record
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: absent
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: Check mode - deletes a single db record
      aws_dynamodb_item:
        table: "{{ dynamo_db_table }}"
        state: absent
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}}
        <<: *aws_connection_info
      register: result
      check_mode: yes
    - name: assert status
      assert:
        that:
          - result.changed

  always:
    ###### TEARDOWN STARTS HERE ######

    - name: delete the table
      dynamodb_table:
        name: "{{ dynamo_db_table }}"
        region: "{{ ec2_region }}"
        state: absent
        <<: *aws_connection_info
      ignore_errors: yes
