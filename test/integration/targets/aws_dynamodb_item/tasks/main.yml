---
# tasks file for testing aws_dynamodb_item module

- block:

    - name: set up aws connection info
      set_fact:
        aws_connection_info: &aws_connection_info
          aws_access_key: "{{ aws_access_key }}"
          aws_secret_key: "{{ aws_secret_key }}"
          security_token: "{{ security_token }}"
          region: "{{ ec2_region }}"
      no_log: yes

    - name: create dynamodb database
      dynamodb_table:
        name: "{{ dynamo_db_table }}"
        hash_key_name: bank
        hash_key_type: STRING
        range_key_name: quantity
        range_key_type: NUMBER
        # tag necessary so it waits until table creation
        tags:
          ansible_test: integration
        <<: *aws_connection_info
      register: result
    - name: assert status
      assert:
        that:
          - result.changed

    - name: test real inserts and deletions
      include_tasks: insert_deletion.yml

    - name: test check mode
      include_tasks: check_mode.yml

    - name: test exceptions
      include_tasks: exceptions.yml

  always:
    ###### TEARDOWN STARTS HERE ######

    - name: delete the table
      dynamodb_table:
        name: "{{ dynamo_db_table }}"
        region: "{{ ec2_region }}"
        state: absent
        <<: *aws_connection_info
      ignore_errors: yes
