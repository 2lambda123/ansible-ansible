# Test code for the netapp_e_iscsi_interface module
# (c) 2018, NetApp, Inc
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: NetApp Test ASUP module
  fail:
    msg: 'Please define netapp_e_api_username, netapp_e_api_password, netapp_e_api_host, and netapp_e_ssid.'
  when:  netapp_e_api_username is undefined or netapp_e_api_password is undefined
          or netapp_e_api_host is undefined or netapp_e_ssid is undefined
  vars:
    credentials: &creds
      api_url: "https://{{ netapp_e_api_host }}/devmgr/v2"
      api_username: "{{ netapp_e_api_username }}"
      api_password: "{{ netapp_e_api_password }}"
      ssid: "{{ netapp_e_ssid }}"
      validate_certs: no

- name: set credentials
  set_fact:
    credentials: *creds

# ****************************************************
# *** Setup test hosts, storage pools, and volumes ***
# ****************************************************
- name: Create host for host mapping
  netapp_e_host:
    <<: *creds
    state: present
    name: test_host_mapping_host
    host_type_index: 27
- name: Create storage pool for host mapping
  netapp_e_storagepool:
    <<: *creds
    state: present
    name: test_host_mapping_storage_pool
    raid_level: raid0
    criteria_min_usable_capacity: 1
- name: Create volume for host mapping
  netapp_e_volume:
    <<: *creds
    state: present
    name: test_host_mapping_volume
    storage_pool_name: test_host_mapping_storage_pool
    size: 1

# **********************************************
# *** Create new lun between host and volume ***
# **********************************************
- name: Create netapp_e_lun_mapping
  netapp_e_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
    log_path: log_path
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}/storage-systems/{{ netapp_e_ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

- pause: seconds=30
# **************************************************************
# *** Repeat previous lun creation play and verify unchanged ***
# **************************************************************
- name: Repeat lun creation
  netapp_e_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
    log_path: log_path
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}/storage-systems/{{ netapp_e_ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

- pause: seconds=30
# ****************************************************************
# *** Move existing lun to default target and verify unchanged ***
# ****************************************************************
- name: Move lun to default target
  netapp_e_lun_mapping:
    <<: *creds
    state: present
    volume: test_host_mapping_volume
    log_path: log_path
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}/storage-systems/{{ netapp_e_ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

- pause: seconds=30
# *****************************************************************
# *** Move existing lun to specific target and verify unchanged ***
# *****************************************************************
- name: Move lun to default target
  netapp_e_lun_mapping:
    <<: *creds
    state: present
    target: test_host_mapping_host
    volume: test_host_mapping_volume
    log_path: log_path
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}/storage-systems/{{ netapp_e_ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

- pause: seconds=30
# ********************************
# *** Delete newly created lun ***
# ********************************
- name: Delete lun creation
  netapp_e_lun_mapping:
    <<: *creds
    state: absent
    target: test_host_mapping_host
    volume: test_host_mapping_volume
    log_path: log_path
  register: result

- name: Verify lun mapping
  uri:
    url: "{{ credentials.api_url }}/storage-systems/{{ netapp_e_ssid }}/graph/xpath-filter?query=//volume[name='test_host_mapping_volume']"
    user: "{{ credentials.api_username }}"
    password: "{{ credentials.api_password }}"
    body_format: json
    validate_certs: no
  register: current

- assert:
    that: "{{ not item['mapped'] }}"
    msg: "Lun failed to be created."
  loop: "{{ lookup('list', current.json)}}"

- pause: seconds=30
# ********************************************************
# *** Tear down test hosts, storage pools, and volumes ***
# ********************************************************
- name: Create volume for host mapping
  netapp_e_volume:
    <<: *creds
    state: absent
    name: test_host_mapping_volume
    storage_pool_name: test_host_mapping_storage_pool
    size: 1
- name: Create storage pool for host mapping
  netapp_e_storagepool:
    <<: *creds
    state: absent
    name: test_host_mapping_storage_pool
    raid_level: raid0
    criteria_min_usable_capacity: 1
- name: Create host for host mapping
  netapp_e_host:
    <<: *creds
    state: absent
    name: test_host_mapping_host
    host_type_index: 27