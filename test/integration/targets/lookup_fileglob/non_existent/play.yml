- hosts: localhost
  gather_facts: false
  tasks:
    - name: fileglob should be empty
      assert:
        that: q("fileglob", seed) | length == 0

    - name: Test ignore_missing
      vars:
        query_with_warnings: "query('fileglob', 'missing/file')"
        query_without_warnings: "query('fileglob', 'missing/file', on_missing_dir='ignore')"
        query_fail: "query('fileglob', 'missing/file', on_missing_dir='fail')"
        warning: "Unable to find 'missing' in expected paths"
      block:
        - name: Test a warning is given for a missing path
          command: ansible localhost -m debug -a msg="{{ '{{' ~ query_with_warnings ~ '}}' }}"
          register: warn_for_missing

        - name: Test ignoring the warning
          command: ansible localhost -m debug -a msg="{{ '{{' ~ query_without_warnings ~ '}}' }}"
          register: ignore_missing

        - name: Test ignoring the warning
          command: ansible localhost -m debug -a msg="{{ '{{' ~ query_fail ~ '}}' }}"
          register: fail_for_missing
          ignore_errors: true

        - assert:
            that:
              - warning in warn_for_missing.stderr
              - warning not in ignore_missing.stderr
              - fail_for_missing is failed
