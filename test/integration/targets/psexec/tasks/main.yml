---
- name: check whether the host supports encryption
  win_shell: |
    if ([System.Environment]::OSVersion.Version -lt [Version]"6.2") {
        "false"
    } else {
        "true"
    }
  register: encryption_supported_raw

- name: install pypsexec Python library for tests
  pip:
    name: pypsexec
    state: latest
  delegate_to: localhost

- name: define psexec variables
  set_fact:
    psexec_hostname: '{{ansible_host}}'
    psexec_username: '{{ansible_user}}'
    psexec_password: '{{ansible_password}}'
    psexec_encrypt: '{{encryption_supported_raw.stdout_lines[0]|bool}}'

- name: create test inbound SMB firewall rule
  win_firewall_rule:
    name: Psexec Test
    localport: 25
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: yes

- name: run tests
  block:
  - include_tasks: tests.yml
  
  always:
  - name: remove test inbound SMB firewall rule
    win_firewall_rule:
      name: Psexec Test
      action: allow
      direction: in
      protocol: tcp
      state: absent

