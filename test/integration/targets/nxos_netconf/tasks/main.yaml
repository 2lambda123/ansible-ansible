---
- name: Setup - Enable feature netconf
  nxos_feature:
    feature: netconf
    state: enabled
  vars:
    ansible_connection: network_cli
    ansible_ssh_port: 22

- name: Setup - Remove loopback
  nxos_config:
    lines:
      - no interface loopback55
  ignore_errors: yes

- name: Setup - Configure test loopback interface
  nxos_config:
    lines:
      - interface loopback55

- block:
  - { include: netconf.yaml, tags: ['netconf'] }

  always:
  - name: Disable feature netconf
    nxos_feature:
      feature: netconf
      state: disabled
    vars:
      ansible_connection: network_cli
      ansible_ssh_port: 22

  - name: Cleanup - Remove loopback
    nxos_config:
      lines:
        - no interface loopback55
    vars:
      ansible_connection: network_cli
      ansible_ssh_port: 22
    ignore_errors: yes
