---
# tasks file for aws_acm_facts

- name: set up aws connection info
  set_fact:
    aws_connection_info: &aws_connection_info
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token }}"
      region: "{{ aws_region }}"
  no_log: yes

# Preconditions to run this tests:
# 1. Create a TLS certificate on AWS ACM (Amazon Certificate Manager), Cosole link: https://console.aws.amazon.com/acm/home
# 2. Set the domain name in ../defaults/main.yml to the one of your certificate
# 3. Set the ARN in ../defaults/main.yml to the one of your certificate

# NOTE: This could also be done by a Ansible ACM module in the future
# but for now we don't have one.

- block:
    - name: Get all ACM certificate facts
      aws_acm_facts:
        <<: *aws_connection_info
      register: result

    - name: Assert that certificate infos are returned
    - assert:
        that:
          - result.certificates is defined
          - result.certificates|length > 0

    - name: Get ACM certificate facts by ARN id
      aws_acm_facts:
        certificate_arn: '{{ acm_arn }}'
        <<: *aws_connection_info
      register: result

    - name: Assert that certificate info is returned
      assert:
        that:
          - result.certificates is defined
          - result.certificates.0.certificate_arn == acm_arn

    - name: Get ACM certificate facts by domain name
      aws_acm_facts:
        domain_name: '{{ acm_domain }}'
        <<: *aws_connection_info
      register: result

    - name: Assert that certificate info is returned
      assert:
        that:
          - result.certificates is defined
          - result.certificates.0.domain_name == acm_domain
