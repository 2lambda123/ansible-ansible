---
- debug: msg="START TRANSPORT:{{ connection.transport }} nxos_vxlan_vtep_vni sanity test"

- block:
  - name: "Enable feature nv overlay"
    nxos_config: 
      commands:
        - feature nv overlay
      provider: "{{ connection }}"
      match: none

  - name: configure vxlan_vtep
    nxos_vxlan_vtep:
      interface: nve1
      host_reachability: True
      provider: "{{ connection }}"

  - name: configure vxlan_vtep_vni assoc-vrf
    nxos_vxlan_vtep_vni: &conf1
      interface: nve1
      vni: 6000
      assoc_vrf: True
      provider: "{{ connection }}"
    register: result

  - assert: &true
      that:
        - "result.changed == true"

  - name: "Conf 1 Idempotence"
    nxos_vxlan_vtep_vni: *conf1
    register: result

  - assert: &false
      that:
        - "result.changed == false"

  - name: remove vxlan_vtep_vni
    nxos_vxlan_vtep_vni:
      interface: nve1
      vni: 6000
      assoc_vrf: True
      state: absent
      provider: "{{ connection }}"

  - name: configure vxlan_vtep_vni mcast
    nxos_vxlan_vtep_vni: &conf2
      interface: nve1
      vni: 8000
      multicast_group: 224.1.1.1
      provider: "{{ connection }}"
    register: result

  - assert: *true

  - name: "Conf 2 Idempotence"
    nxos_vxlan_vtep_vni: *conf2
    register: result

  - assert: *false

  - name: "remove config"
    nxos_vxlan_vtep_vni: &remove
      interface: nve1
      vni: 8000
      state: absent
      provider: "{{ connection }}"

  - name: configure vxlan_vtep
    nxos_vxlan_vtep:
      interface: nve1
      host_reachability: False
      provider: "{{ connection }}"

  - name: configure vxlan_vtep_vni peer-list
    nxos_vxlan_vtep_vni: &conf3
      interface: nve1
      vni: 8000
      peer_list: 
        - 1.1.1.1
        - 2.2.2.2
        - 3.3.3.3
        - 4.4.4.4
      ingress_replication: static
      provider: "{{ connection }}"
    register: result

  - assert: *true

  - name: "Conf 3 Idempotence"
    nxos_vxlan_vtep_vni: *conf3
    register: result

  - assert: *false

  - name: remove vxlan_vtep_vni
    nxos_vxlan_vtep_vni: *remove
    register: result

  - assert: *true

  - name: "remove Idempotence"
    nxos_vxlan_vtep_vni: *remove
    register: result

  - assert: *false

  always:
  - name: remove vxlan_vtep
    nxos_vxlan_vtep:
      interface: nve1
      shutdown: true
      state: absent
      provider: "{{ connection }}"
    ignore_errors: yes

  - name: "Disable feature nv overlay"
    nxos_feature: 
      feature: nve
      state: disabled
      provider: "{{ connection }}"
    ignore_errors: yes

- debug: msg="END TRANSPORT:{{ connection.transport }} nxos_vxlan_vtep_vni sanity test"
