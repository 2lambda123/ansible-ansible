- name: get installed resolvelib version
  shell: "{{ ansible_python_interpreter }} -m pip freeze | grep 'resolvelib'"
  register: installed_resolvelib

- block:
    - name: install a version of resolvelib that is unsupported by ansible-galaxy
      pip:
        name: resolvelib
        version: "0.5.2"
        state: present

    - name: create test collection install directory - {{ test_name }}
      file:
        path: '{{ galaxy_dir }}/ansible_collections'
        state: directory

    - name: install simple collection from first accessible server (expected failure)
      command: ansible-galaxy collection install namespace1.name1 {{ galaxy_verbosity }}
      environment:
        ANSIBLE_COLLECTIONS_PATH: '{{ galaxy_dir }}/ansible_collections'
      register: resolvelib_version_error
      ignore_errors: yes

    - assert:
        that:
          - resolvelib_version_error is failed
          - expected_error in resolvelib_version_error.stderr
      vars:
        expected_error: "ansible-galaxy requires resolvelib<0.6.0,>=0.5.3"

  always:
    - name: reinstall the supported version of resolvelib
      pip:
        name: resolvelib
        version: "{{ reinstall_version }}"
        state: present
      vars:
        reinstall_version: "{{ installed_resolvelib.stdout | regex_search('resolvelib==(.*$)', '\\1') | first }}"

    - name: cleanup install directory
      file:
        path: '{{ galaxy_dir }}/ansible_collections'
        state: absent
