---
  - debug:
      msg: Start nxos_acls merged integration tests connection={{ansible_connection}}"
    
  - include_tasks: remove_config.yml

  - block:
      - name: Merged
        nxos_acls: &merged
          config:
            - afi: ipv4
              acls:
                - name: Trial_ACLv4
                  aces:
                    - grant: deny
                      destination:
                        address: 192.0.2.64
                        wildcard_bits: 0.0.0.255
                      source:
                        any: true
                        port_protocol:
                          lt: 55
                      protocol: tcp
                      protocol_options:
                        tcp:
                          ack: true
                          fin: true
                      sequence: 50
          
            - afi: ipv6
              acls:
                - name: Trial_ACLv6
                  aces:
                    - grant: permit
                      sequence: 10
                      source:
                        any: true
                      destination:
                        prefix: 2001:db8:12::/32
                      protocol: sctp
          state: merged
        register: result      

      - assert:
          that:
            - "result.changed == True"
            - "'ip access-list Trial_ACLv4' in result.commands"
            - "'20 permit ip any any fragments log' in result.commands" 
            - "'50 deny tcp any lt 55 192.0.2.64 0.0.0.255 ack fin' in result.commands"   
            - "'ipv6 access-list ACL6_with_ACE' in result.commands" 
            - "'10 permit sctp any 2001:db8:12::/32' in result.commands"
            - "result.commands | length == 5 "
    
      - name: Gather acls facts
        nxos_facts:
          gather_subset:
            - '!all'
            - '!min'
          gather_network_resources: acls
      
      - assert:
          that:
            - "ansible_facts.network_resources.acls == result.after"
      
        
      - name: Idempotence - Merged
        nxos_acls: *merged
        register: result

      - debug:
          var: result

      - assert:
          that:
            - "result.changed == false"

    always:
      - include_tasks: remove_config.yaml

      