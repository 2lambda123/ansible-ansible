 - name: Create managed disk
   set_fact:
       managed_disk1: "{{ resource_group | hash('md5') | truncate(24, True, '') }}"


 - name: Create new managed disk
   azure_rm_managed_disk:
       resource_group: "{{ resource_group }}" 
       name: "{{ managed_disk1 }}"
       account_type: Standard_LRS
       disk_size_gb: 1
       tags:
           test: test
           galaxy: galaxy
   register: output

 - name: Assert status succeeded and results include an Id value 
   assert:
     that:
       - output.changed
       - output.state.id is defined

 - name: Gather facts by tags
   azure_rm_managed_disk_facts:
       resource_group: "{{ resource_group }}"
       tags:
         - test
         - galaxy

 - assert:
       that: azure_storageaccounts | length >= 1

 - name: Change account type to an invalid type
   azure_rm_managed_disk:
       resource_group: "{{ resource_group }}" 
       name: "{{ managed_disk1 }}"
       account_type: PremiumL
       disk_size_gb: 1
   register: change_account
   ignore_errors: yes 

 - name: Assert account type change failed 
   assert: { that: "change_account['failed'] == True" }

 - name: Change disk size to incompatible size 
   azure_rm_managed_disk:
       resource_group: "{{ resource_group }}"
       name: "{{ managed_disk1 }}"
       disk_size_gb: 3000
   register: change_account
   ignore_errors: yes

 - name: Assert disk size change failure
   assert: { that: "'failed' in  change_account['msg']" }

 - name: Update account tags
   azure_rm_managed_disk:
       resource_group: "{{ resource_group }}"
       name: "{{ managed_disk1 }}"
       tags:
           testing: testing
           delete: never
           galaxy: 'no'
   register: output

 - assert:
       that:
           - "output.state.tags | length == 3"
           - "output.state.tags.galaxy == 'no'"

 - name: Update account tags
   azure_rm_managed_disk:
       resource_group: "{{ resource_group }}"
       name: "{{ managed_disk1 }}"
       tags:
           testing: testing
           delete: never
   register: output

 - assert:
       that:
           - "output.state.tags | length == 2"
           - "output.state.tags.testing == 'testing'"
           - "output.state.tags.delete == 'never'"

 - name: Gather facts
   azure_rm_managed_disk_facts:
       resource_group: "{{ resource_group }}"
       name: "{{ managed_disk1 }}"

 - assert:
       that:
           - "azure_storageaccounts| length == 1"

 - name: Gather facts
   azure_rm_managed_disk_facts:
       resource_group: "{{ resource_group }}"

 - assert:
       that:
           - "azure_storageaccounts | length > 0"

 - name: Delete acccount
   azure_rm_managed_disk:
       resource_group: "{{ resource_group }}" 
       name: "{{ managed_disk1 }}"
       state: absent

