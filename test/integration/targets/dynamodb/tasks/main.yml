---
# tasks file for testing aws dynamodb module

- name: set up aws connection info
  set_fact:
    aws_connection_info: &aws_connection_info
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token }}"
      region: "{{ aws_region }}"
  no_log: yes

- block:
    - name: create dynamodb database
      dynamodb_table:
        name: ansible-int-test
        hash_key_name: bank
        hash_key_type: STRING
        range_key_name: quantity
        range_key_type: NUMBER
        <<: *aws_connection_info
      register: result
    - name: assert changed is True
      assert:
        that:
          - result.changed == True

    - name: inserting db record
      dynamodb:
        table: ansible-int-test
        action: put
        item: {"bank": {"S": "hsbc"}, "quantity": {"N": "1000"}, "person": {"S": "ochoa"}}
        <<: *aws_connection_info
      register: result
    - name: assert object exists
      assert:
        that:
          - result.changed == True

    - name: updating db record with the hypotetic protected word (quantity)
      dynamodb:
        table: ansible-int-test
        action: update
        primary_key: {"bank": {"S": "hsbc"}}
        update_expression: 'SET #q = :number'
        expression_attribute_values: {":number": {"N": "2000"}}
        expression_attribute_names: {"#q": "quantity"}
        <<: *aws_connection_info
      register: result
    - name: assert object exists
      assert:
        that:
          - result.changed == True

    - name: updating to delete attribute 'person' in previously added db record
      dynamodb:
        table: ansible-int-test
        action: update
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "2000"}}
        update_expression: 'REMOVE person'
        <<: *aws_connection_info
      register: result
    - name: assert object exists
      assert:
        that:
          - result.changed == True

    - name: deletes a single db record
      dynamodb:
        table: ansible-int-test
        action: delete
        primary_key: {"bank": {"S": "hsbc"}, "quantity": {"N": "2000"}}
        condition_expression: person = :person
        expression_attribute_values: {":person": {"S": "ochoa"}}
        <<: *aws_connection_info
      register: result
    - name: assert object exists
      assert:
        that:
          - result.changed == True

  always:
    ###### TEARDOWN STARTS HERE ######

    - name: delete the test dynamo db
      dynamodb_table:
        name: ansible-int-test
        region: "{{ aws_region }}"
        state: absent
        <<: *aws_connection_info
      ignore_errors: yes
