---
- name: Registering container name
  set_fact:
    cname: "{{ cname_prefix ~ '-mounts' }}"
    cname_h1: "{{ cname_prefix ~ '-mounts-h1' }}"
    cname_h2: "{{ cname_prefix ~ '-mounts-h2' }}"
- name: Registering container name
  set_fact:
    cnames: "{{ cnames + [cname, cname_h1, cname_h2] }}"

####################################################################
## keep_volumes ####################################################
####################################################################

# TODO: - keep_volumes

####################################################################
## volume_driver ###################################################
####################################################################

- name: volume_driver
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    volume_driver: local
    state: started
  register: volume_driver_1

- name: volume_driver (idempotency)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    volume_driver: local
    state: started
  register: volume_driver_2

- name: volume_driver (change)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    volume_driver: /
    state: started
    force_kill: yes
  register: volume_driver_3

- name: cleanup
  docker_container:
    name: "{{ cname }}"
    state: absent
    force_kill: yes
  diff: no

- assert:
    that:
    - volume_driver_1 is changed
    - volume_driver_2 is not changed
    - volume_driver_3 is changed

####################################################################
## volumes #########################################################
####################################################################

- name: volumes
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes:
    - "/tmp:/tmp"
    - "/:/whatever:rw,z"
  register: volumes_1

- name: volumes (idempotency)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes:
    - "/:/whatever:rw,z"
    - "/tmp:/tmp"
  register: volumes_2

- name: volumes (less volumes)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes:
    - "/tmp:/tmp"
  register: volumes_3

- name: volumes (more volumes)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes:
    - "/tmp:/tmp"
    - "/tmp:/somewhereelse:ro,Z"
    force_kill: yes
  register: volumes_4

- name: volumes (different modes)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes:
    - "/tmp:/tmp"
    - "/tmp:/somewhereelse:ro"
    force_kill: yes
  register: volumes_5

- name: cleanup
  docker_container:
    name: "{{ cname }}"
    state: absent
    force_kill: yes
  diff: no

- assert:
    that:
    - volumes_1 is changed
    - volumes_2 is not changed
    - volumes_3 is not changed
    - volumes_4 is changed
    - volumes_5 is changed

####################################################################
## volumes_from ####################################################
####################################################################

- name: start helpers
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ container_name }}"
    state: started
    volumes:
    - "{{ '/tmp:/tmp' if container_name == cname_h1 else '/:/whatever:ro' }}"
  loop:
  - "{{ cname_h1 }}"
  - "{{ cname_h2 }}"
  loop_control:
    loop_var: container_name

- name: volumes_from
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes_from: "{{ cname_h1 }}"
  register: volumes_from_1

- name: volumes_from (idempotency)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes_from: "{{ cname_h1 }}"
  register: volumes_from_2

- name: volumes_from (change)
  docker_container:
    image: alpine:3.8
    command: '/bin/sh -c "sleep 10m"'
    name: "{{ cname }}"
    state: started
    volumes_from: "{{ cname_h2 }}"
    force_kill: yes
  register: volumes_from_3

- name: cleanup
  docker_container:
    name: "{{ container_name }}"
    state: absent
    force_kill: yes
  loop:
  - "{{ cname }}"
  - "{{ cname_h1 }}"
  - "{{ cname_h2 }}"
  loop_control:
    loop_var: container_name
  diff: no

- assert:
    that:
    - volumes_from_1 is changed
    - volumes_from_2 is not changed
    - volumes_from_3 is changed

####################################################################
####################################################################
####################################################################
