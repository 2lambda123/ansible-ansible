---
# NOTE(pabelanger): We sometime see random failures from iosxr about paramiko
# establishing the control socket for network_cli. It seems iosxr is closing
# the socket for some reason.  This is our attempt to ensure the port is open
# before starting paramiko.
- name: wait for iosxr SSH connection
  delegate_to: localhost
  wait_for:
    host: "{{ hostvars[item].ansible_host }}"
    port: 22
    search_regex: SSH
  with_inventory_hostnames: iosxr

- name: Ensure we have loopback 888 for testing
  iosxr_config:
    src: config.j2
  connection: network_cli

- name: Enable Netconf service
  iosxr_netconf:
    netconf_port: 830
    netconf_vrf: 'default'
    state: present
  connection: network_cli
  tags: netconf

# Some AWS hostnames can be longer than those allowed by the system we are testing
# Truncate the hostname
# http://jinja.pocoo.org/docs/2.9/templates/#truncate
- set_fact:
    shorter_hostname: '{{ inventory_hostname_short| truncate(10, True, "") }}'
