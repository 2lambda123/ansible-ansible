- name: Measure time before
  shell: date +%s
  register: before

- debug:
    var: i
  with_sequence: count=3
  loop_control:
    loop_var: i
    pause: 2

- name: Measure time after
  shell: date +%s
  register: after

# since there is 3 rounds, and 2 seconds between, it should last 4 seconds
# we do not test the upper bound, since CI can lag significantly
- assert:
    that:
    - '(after.stdout |int) - (before.stdout|int) >= 4'

- name: Configure variables for batch lookup plugin test
  set_fact:
    batch_count: 0
    batch_items:
      - 1
      - 2
      - 3
      - 4
      - 5

- name: Run items asynchronously in batch
  vars:
    batched_items: "{{ item }}"
    batch_lookup_size: 2
  include: execute_batch.yml
  with_batch: "{{ batch_items }}"

# execute_batch should have run 3 times - we have a list of 5 items and the
# batch_lookup_size is 2.
- assert:
    that:
      - batch_count == "3"
