---
- debug: msg="START TRANSPORT:NXAPI nxos_udld_interface sanity test"

# Select interface for test
- set_fact: intname="{{ nxos_int1 }}"

- block:
  - name: "Enable feature udld"
    nxos_feature: 
      feature: udld
      state: enabled
      provider: "{{ nxapi }}"

  - name: "put the interface into default state"
    nxos_config: 
      commands:
        - "default interface {{intname}}"
      provider: "{{ nxapi }}"
      match: none

  - name: ensure interface is configured to be in aggressive mode
    nxos_udld_interface: &conf1
      interface: "{{ intname }}"
      mode: aggressive
      state: present
      provider: "{{ nxapi }}"
    register: result

  - assert: &true
      that:
        - "result.changed == true"

  - name: "Conf1 Idempotence"
    nxos_udld_interface: *conf1
    register: result

  - assert: &false
      that:
        - "result.changed == false"

  - name: ensure interface has mode enabled
    nxos_udld_interface: &conf2
      interface: "{{ intname }}"
      mode: enabled
      state: present
      provider: "{{ nxapi }}"
    register: result

  - assert: *true

  - name: Remove the config
    nxos_udld_interface: &remove
      interface: "{{ intname }}"
      mode: enabled
      state: absent
      provider: "{{ nxapi }}"

  when: not (platform | search('N9K-F'))

  always:
  - name: "Disable udld"
    nxos_feature: 
      feature: udld
      state: disabled
      provider: "{{ nxapi }}"
    ignore_errors: yes

- debug: msg="END TRANSPORT:NXAPI nxos_udld_interface sanity test"
