---
- name: copy across testing files
  win_copy:
    src: files/
    dest: '{{ remote_tmp_dir }}'

- name: download SlimFTPd binary
  win_get_url:
    url: https://s3.amazonaws.com/ansible-ci-files/test/integration/roles/test_win_get_url/SlimFTPd.exe
    dest: '{{ remote_tmp_dir }}\SlimFTPd.exe'

- name: template SlimFTPd configuration file
  win_template:
    src: slimftpd.conf.tmpl
    dest: '{{ remote_tmp_dir }}\slimftpd.conf'

- block:
  # SlimFTPd is quite an old application and doesn't support the special chars we use in our testing tmp dir. We rely on
  # a symbolic link to smooth out the path used in the service
  - name: create symlink for SlimFTPd service
    win_command: cmd.exe /c mklink /d "{{ slimftpd_link }}" "{{ remote_tmp_dir }}"

  - name: create SlimFTPd service
    win_service:
      name: SlimFTPd
      path: '"{{ slimftpd_link }}\SlimFTPd.exe" -service'
      state: started
      dependencies:
      - tcpip

  - name: run URL tests
    import_tasks: tests_url.yml

  - name: run FTP tests
    import_tasks: tests_ftp.yml

  - name: run checksum tests
    import_tasks: tests_checksum.yml

  always:
  - name: remove SlimFTPd service
    win_service:
      name: SlimFTPd
      state: absent

  - name: remove SlimFTPd symlink
    win_file:
      path: '{{ slimftpd_link }}'
      state: absent
