# pg_config requires postgresql-server-dev package,
# try find extension path using one way for all systems
- block:
  - name: find PostgreSQL extension directory
    find:
      file_type: file
      paths: '/usr/share/'
      patterns: sql_features.txt
      recurse: yes
      follow: yes
    register: sql_features_path

  - name: ensure that only one path was found
    assert:
      that:
        - 'sql_features_path.matched == 1'

  - set_fact:
      pg_extension_dir: '{{ sql_features_path.files[0].path | dirname }}/extension'
  when: pg_extension_dir is not set

- name: retrieve fact for extension directory
  stat:
    path: '{{ pg_extension_dir }}'
  register: extension_directory

- name: ensure that extension directory exists
  assert:
    that:
      - 'extension_directory.stat.exists and extension_directory.stat.isdir'

- name: copy control file
  copy:
    src: dummy.control
    dest: '{{ pg_extension_dir }}'
    mode: 0444
    owner: '{{ extension_directory.stat.pw_name }}'

- name: copy extension files
  copy:
    src: 'dummy--{{ item }}.sql'
    dest: '{{ pg_extension_dir }}'
    mode: 0444
    owner: '{{ extension_directory.stat.pw_name }}'
  with_items:
    - '1.0'
    - '2.0'
