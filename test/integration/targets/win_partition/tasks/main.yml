---
- name: "Copy VHDX scripts"
  win_template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: 'vhdx_creation_script.j2', dest: 'C:\vhdx_creation_script.txt' }
    - { src: 'vhdx_deletion_script.j2', dest: 'C:\vhdx_deletion_script.txt' }

- name: "Create VHD"
  win_shell: diskpart.exe /s c:\vhdx_creation_script.txt

- name: "Run tests"
  block:
    - include: tests.yml
  always:
    - name: "Detach disk"
      win_shell: diskpart.exe /s c:\vhdx_deletion_script.txt

    - name: "Cleanup files"
      win_file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ AnsibleVhdx }}"
        - "c:\\vhdx_creation_script.txt"
        - "c:\\vhdx_deletion_script.txt"
