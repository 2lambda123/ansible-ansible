# Test code for the vmware_guest_find module.
# Copyright: (c) 2017, James Tanner <tanner.jc@gmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

# vcsim embeds the datacenter into the path and
# the VM name, so it can be chopped out for later
# use or verification
- name: show the datacenter(s)
  debug:
    msg: "{{ (item|basename).split('_')[0] }}"
  with_items: "{{ vmlist['json'] }}"

- name: find folders for each vm
  vmware_guest_find:
    validate_certs: False
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcsim_instance['json']['username'] }}"
    password: "{{ vcsim_instance['json']['password'] }}"
    name: "{{ item|basename }}"
    datacenter: "{{ (item|basename).split('_')[0] }}"
  with_items: "{{ vmlist['json'] }}"
  register: folders

- debug: var=item
  with_items: "{{ folders.results }}"

# We only care that each VM was found, not that the folder path
# is completely accurate. Eventually the test should be extended
# to validate the full path for each VM.
- assert:
    that:
        - "{{ 'folders' in item }}"
        - "{{ item['folders']|length == 1 }}"
  with_items: "{{ folders.results }}"

# Testcase 2: Find VMS using UUID
- name: get details about VMS from vcsim
  uri:
    url: http://{{ vcenter_hostname }}:5000/govc_vm_info
  register: vms_detail_list

- name: find folders for each vm using UUID
  vmware_guest_find:
    validate_certs: False
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcsim_instance['json']['username'] }}"
    password: "{{ vcsim_instance['json']['password'] }}"
    uuid: "{{ vms_detail_list['json'][item|basename]['UUID'] }}"
    datacenter: "{{ (item|basename).split('_')[0] }}"
  with_items: "{{ vmlist['json'] }}"
  register: folders_uuid

- debug: var=item
  with_items: "{{ folders_uuid.results }}"

- assert:
    that:
        - "{{ 'folders' in item }}"
        - "{{ item['folders']|length == 1 }}"
  with_items: "{{ folders_uuid.results }}"
