---
# these are extra tests for psrp that aren't covered under test/integration/targets/connection/*
- name: test out psrp specific tests
  hosts: winrm
  serial: 1
  gather_facts: no

  tasks:
  - name: test complex objects in raw output
    # until PyYAML is upgraded to 4.x we need to use the \U escape for a unicode codepoint
    # and enclose in a quote to it translates the \U
    raw: "
      [PSCustomObject]@{string = 'string'};
      [PSCustomObject]@{unicode = 'poo - \U0001F4A9'};
      [PSCustomObject]@{integer = 1};
      [PSCustomObject]@{list = @(1, 2)};
      Get-Service -Name winrm;
      Write-Output -InputObject 'string - \U0001F4A9';"
    register: raw_out

  - name: assert complex objects in raw output
    assert:
      that:
      - raw_out.stdout_lines|count == 6
      - "raw_out.stdout_lines[0] == 'string: string'"
      - "raw_out.stdout_lines[1] == 'unicode: poo - \U0001F4A9'"
      - "raw_out.stdout_lines[2] == 'integer: 1'"
      - "raw_out.stdout_lines[3] == \"list: [1, 2]\""
      - raw_out.stdout_lines[4] == "winrm"
      - raw_out.stdout_lines[5] == "string - \U0001F4A9"

  - name: test out become with psrp
    win_whoami:
    register: whoami_out
    become: yes
    become_method: runas
    become_user: SYSTEM
    vars:
      ansible_psrp_auth: basic  # Will fail on Server 2008 unless we use basic or CredSSP

  - name: assert test out become with psrp
    assert:
      that:
      - whoami_out.account.sid == "S-1-5-18"

  - name: test out async with psrp
    win_shell: Start-Sleep -Seconds 2; Write-Output abc
    async: 5
    poll: 1
    register: async_out

  - name: assert est out async with psrp
    assert:
      that:
      - async_out.stdout_lines == ["abc"]
