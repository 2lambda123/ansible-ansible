# Test playbook for the listen_ports_facts module
# Copyright: (c) 2019, Nathan Davison <ndavison85@gmail.com>

# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: install netstat and netcat on deb
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - net-tools
    - netcat
  when: ansible_os_family == "Debian"

- name: install netstat and netcat on rh < 7
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - net-tools
    - nc.x86_64
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int < 7

- name: install netstat and netcat on rh >= 7
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - net-tools
    - nmap-ncat
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 7

- name: start UDP server on port 5555
  command: nc -u -l -p 5555
  async: 1000
  poll: 0
  when: (ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 7) or ansible_os_family == "Debian"

- name: start UDP server on port 5555
  command: nc -u -l 5555
  async: 1000
  poll: 0
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int < 7

- name: start UDP server on port 5556
  command: "nc -u -l -p 5556"
  async: 1000
  poll: 0
  when: (ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 7) or ansible_os_family == "Debian"

- name: start UDP server on port 5556
  command: "nc -u -l 5556"
  async: 1000
  poll: 0
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int < 7

- name: start TCP server on port 5557
  command: "nc -l -p 5557"
  async: 1000
  poll: 0
  when: (ansible_os_family == "RedHat" and ansible_distribution_major_version|int >= 7) or ansible_os_family == "Debian"

- name: start TCP server on port 5557
  command: "nc -l 5557"
  async: 1000
  poll: 0
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int < 7

- name: Gather listening ports facts with whitelists
  listen_ports_facts:
    whitelist_tcp:
      - 22
    whitelist_udp:
      - 55556
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check for ansible_facts.tcp_listen_violations exists
  assert:
    that: ansible_facts.tcp_listen_violations is defined
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check for ansible_facts.udp_listen_violations exists
  assert:
    that: ansible_facts.udp_listen_violations is defined
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check for ansible_facts.udp_listen exists
  assert:
    that: ansible_facts.udp_listen is defined
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check for ansible_facts.tcp_listen exists
  assert:
    that: ansible_facts.tcp_listen is defined
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check TCP violations
  assert:
    that: ansible_facts.tcp_listen_violations|length > 0
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check UDP violations
  assert:
    that: ansible_facts.udp_listen_violations|length > 0
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check TCP listening ports
  assert:
    that: ansible_facts.tcp_listen|length > 0
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

- name: check UDP listening ports
  assert:
    that: ansible_facts.udp_listen|length > 0
  when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"
