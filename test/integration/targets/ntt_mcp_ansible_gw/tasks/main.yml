- hosts: localhost
  gather_facts: no
  connection: local
  vars:
    # Modify these if you really want
    region: na
    datacenter: NA12
    image: "CentOS 7 64-bit 2 CPU"
<<<<<<< HEAD
    cnd: ansible_gw_cnd
    cnd_description: "Ansible Module Testing"
    vlan: ansible_gw_vlan
    # Do NOT modify these
    ansible_gateway: "ansible_gateway"
  tasks:
  - local_action: stat path=host_passwd_file
    register: host_password
    become: no
    tags:
      - create
      - pwd

  - set_fact:
      pwd_alias_list: []
    when: not host_password.stat.exists
    tags:
      - testing
      - create
      - pwd

  - set_fact:
      pwd_alias_list: "{{ pwd_alias_list + [
                          lookup('password', '/dev/null length=4 chars=' ~ item) ]
                          }}"
    loop:
      - ascii_letters
      - digits
      - hexdigits
      - ',.:{}()-_+='
    when: not host_password.stat.exists
    tags:
      - testing
      - create
      - pwd

  - set_fact:
      host_password: "{{ pwd_alias_list|shuffle|join('') }}"
    when: not host_password.stat.exists
    tags:
      - testing
      - create
      - pwd
=======
    cnd: "myCND2"
    cnd_description: "My CND2"
    vlan: "myVLAN2"
    # Do NOT modify these
    ansible_gateway: "ansible_gateway"
  tasks:
  - name: Generate Host Password
    set_fact:
      host_password: "{{lookup('password', './host_passwd_file chars=ascii_letters,.:{}()-_+=')}}"
    tags:
      - testing
      - create
>>>>>>> a7e5b0f5d0df929597e380ab6dd9e7d22d714b53

  - name: Show host password
    debug:
      var: host_password
    tags:
      - create
<<<<<<< HEAD
      - pwd

  - name: Save Password
    local_action: copy content="{{host_password}}" dest="host_passwd_file" mode="0600"
    tags:
      - create
      - pwd
=======
>>>>>>> a7e5b0f5d0df929597e380ab6dd9e7d22d714b53

  - local_action: stat path=public_ipv4
    register: public_ipv4_state
    become: no
    tags:
      - testing
      - create
      - delete

  - name: Create the CND
    ntt_mcp_network:
      region: "{{region}}"
      datacenter: "{{datacenter}}"
      name: "{{cnd}}"
      description: "{{cnd_description}}"
      state: present
    tags:
      - testing
      - create
    register: cnd_return

  - name: Create the VLAN
    ntt_mcp_vlan:
      region: "{{region}}"
      datacenter: "{{datacenter}}"
      network_domain: "{{cnd}}"
      name: "{{vlan}}"
      ipv4_network_address: "172.16.0.0"
      ipv4_prefix_size: 24
      state: present
    tags:
      - testing
      - create
    register: vlan_return

  - name: Deploy an Ansible Gateway
    ntt_mcp_ansible_gw:
      region: "{{region}}"
      datacenter: "{{datacenter}}"
      name: "ANSIBLE_TEST"
      network_domain: "{{cnd}}"
      vlan: "{{vlan}}"
      image: "{{image}}"
      state: present
    tags:
      - testing
      - create
    register: server

  - name: debug
    debug:
      var: server
    tags:
      - create

  - set_fact:
      ansible_pw: "{{server.data.password | default(host_password)}}"
      ansible_gw: "{{server.data.public_ipv4}}"
    tags:
      - testing
      - create

  - set_fact:
      ansible_pw: "{{host_password}}"
    when: server.data.password == None
    tags:
      - testing
      - create

  - debug:
      var: ansible_pw
    tags:
      - testing
      - create

  - name: Add_Host
    add_host:
      name: "{{ansible_gw}}"
    tags:
      - testing
      - create

  - debug:
      var: ansible_gw
    tags:
      - testing
      - create

  - name: Remove an Ansible Gateway
    ntt_mcp_ansible_gw:
      region: "{{region}}"
      datacenter: "{{datacenter}}"
      name: "ANSIBLE_TEST"
      network_domain: "{{cnd}}"
      vlan: "{{vlan}}"
      state: absent
    register: remove_server
    tags:
      - testing
      - delete

  - name: Debug Removal of the Ansible gateway
    debug:
      var: remove_server
    tags:
      - testing
      - delete

  - name: Remove the VLAN
    ntt_mcp_vlan:
      region: "{{region}}"
      datacenter: "{{datacenter}}"
      network_domain: "{{cnd}}"
      name: "{{vlan}}"
      state: absent
    tags:
      - testing
      - delete

  - name: Remove the CND
    ntt_mcp_network:
      region: "{{region}}"
      datacenter: "{{datacenter}}"
      name: "{{cnd}}"
      state: absent
    tags:
      - testing
      - delete

- hosts: "{{hostvars.localhost.ansible_gw}}"
  gather_facts: no
  environment:
    host_key_checking: False
  vars:
    ansible_user: root
    ansible_gw: "{{hostvars['localhost']['ansible_gw']}}"
    ansible_pw: "{{hostvars['localhost']['ansible_pw']}}"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    ansible_ssh_pass: "{{ ansible_pw }}"
  tasks:
  - debug:
      var: ansible_pw
    tags:
      - testing
      - create

  - name: Get Hostname
    shell: hostname
    register: hostname
    tags:
      - testing
      - create

  - debug:
      var: hostname
    tags:
      - testing
      - create
