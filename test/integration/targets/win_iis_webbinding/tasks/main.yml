---
# Cannot use win_feature to install IIS on Server 2008.
# Run a brief check and skip hosts that don't support
# that operation
- name: register os version (seems integration tests don't gather this fact)
  raw: powershell.exe "gwmi Win32_OperatingSystem | select -expand version"
  register: os_version
  changed_when: False
# ^^ seems "raw" is the only module that works on 2008 non-r2. win_command and win_shell both failed


# Run actual tests
- block:
  - name: reboot before feature install to ensure server is in clean state
    win_reboot:

  - name: ensure IIS features are installed
    win_feature:
      name: Web-Server
      state: present
      includ_sub_features: True
      include_management_tools: True
    register: feature_install

  - name: reboot after feature install
    win_reboot:
    when: feature_install.reboot_required

  # - name: set version of IIS for tests
  #   win_file_version:
  #     path: C:\Windows\System32\inetsrv\w3wp.exe
  #   register: iis_version

  - name: ensure all bindings are removed prior to starting testing
    win_iis_webbinding:
      name: "{{ test_iis_site_name }}"
      state: absent
      protocol: "{{ item }}"
      host_header: '*'
    with_items:
      - http
      - https

  # Tests
  - name: run tests on hosts that support it
    include_tasks: http.yml

  always:
  # Cleanup
  - name: ensure bindings are cleaned up
    win_iis_webbinding:
      name: "{{ test_iis_site_name }}"
      state: absent
      protocol: "{{ item }}"
      host_header: '*'
    with_items:
      - http
      - https

  - name: remove IIS features after test
    win_feature:
      name: Web-Server
      state: absent
      includ_sub_features: True
      include_management_tools: True
    register: feature_uninstall

  - name: reboot after feature install
    win_reboot:
    when: feature_uninstall.reboot_required
  when: os_version.stdout_lines[0] | version_compare('6.1','lt')
