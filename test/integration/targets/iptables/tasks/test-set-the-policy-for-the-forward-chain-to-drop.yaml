---
- set_fact:
    chain: FORWARD
    table: filter
    name: Set the policy for the FORWARD chain to DROP
    idempotent: false
    rules: 0
    check: false
    command:

- name: clear {{chain}} chain / of {{table|default('filter')}} table
  iptables:
    chain: "{{chain}}"
    flush: true
  become: yes

- name: "{{name}}"
  iptables:
    chain: FORWARD
    policy: DROP
  become: yes
  register: iptables

- include_tasks: check-table.yml
- name: "{{name}} assert policy set"
  assert:
    that:
      - 'check_iptables.stdout_lines[0] == "Chain FORWARD (policy DROP)"'

- set_fact:
    idempotent: true

- name: "{{name}} idempotent"
  iptables:
    chain: FORWARD
    policy: DROP
  become: yes
  register: iptables

- include_tasks: check-table.yml
- name: "{{name}} assert policy set"
  assert:
    that:
      - 'check_iptables.stdout_lines[0] == "Chain FORWARD (policy DROP)"'
