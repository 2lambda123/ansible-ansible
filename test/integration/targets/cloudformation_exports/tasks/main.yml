- name: set connection information for aws modules and run tasks
  module_defaults:
    group/aws:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"

  block:
    - name: Create a minimal stack with an export set by parameter
      cloudformation:
        stack_name: "{{ stack_name }}"
        template_body: "{{ lookup('file','test_stack.yml') }}"
        template_parameters:
          TestParamName: "cf-exports-param"
          TestParamValue: "Set By CF Exports"
      register: cf_stack
    - name: Read from Exports
      cloudformation_exports:
        region: "{{ aws_region }}"
      register: exports_result
    - set_fact:
        export_value: "{{ exports_result['export_items']['cf-exports-param'] }}"
    - debug:
        var: export_value
    - assert:
        that:
          - export_value is defined
    # ==== Cleanup ============================================================

  always:

    - name: delete stack
      cloudformation:
        stack_name: "{{ stack_name }}"
        state: absent
      ignore_errors: yes
