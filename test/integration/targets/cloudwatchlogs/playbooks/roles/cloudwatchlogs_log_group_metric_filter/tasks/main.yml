---
- name: set up aws connection info
  set_fact:
    aws_connection_info: &aws_connection_info
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token }}"
      region: "{{ aws_region }}"
  no_log: yes

- name: test cloudwatch log group metric filter

  block:
    - name: create cloudwatch log group for integration test
      cloudwatchlogs_log_group:
        <<: *aws_connection_info
        state: present
        log_group_name: ansible/integrationtest
        retention: 1

    - name: check_mode set metric filter on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        filter_pattern: '{ ($.value = *) && ($.hostname = "box")}'
        state: present
        metric_transformation:
          metricName: box_free_space
          metricNamespace: fluentd_metrics
          metricValue: "$.value"
      check_mode: yes
      register: out

    - name: check_mode state must be changed
      assert:
        that:
          - out is changed

    - name: set metric filter on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        filter_pattern: '{ ($.value = *) && ($.hostname = "box")}'
        state: present
        metric_transformation:
          metricName: box_free_space
          metricNamespace: fluentd_metrics
          metricValue: "$.value"
      register: out

    - name: create metric filter
      assert:
        that:
          - out is changed

    - name: re-set metric filter on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        filter_pattern: '{ ($.value = *) && ($.hostname = "box")}'
        state: present
        metric_transformation:
          metricName: box_free_space
          metricNamespace: fluentd_metrics
          metricValue: "$.value"
      register: out

    - name: metric filter must not change
      assert:
        that:
          - out is not changed

    - name: update matric transformation on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        filter_pattern: '{ ($.value = *) && ($.hostname = "box")}'
        state: present
        metric_transformation:
          metricName: box_free_space
          metricNamespace: made_with_ansible
          metricValue: "$.value"
      register: out

    - name: update metric filter
      assert:
        that:
          - out is changed

    - name: update filter_pattern on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        filter_pattern: '{ ($.value = *) && ($.hostname = "ansible")}'
        state: present
        metric_transformation:
          metricName: box_free_space
          metricNamespace: made_with_ansible
          metricValue: "$.value"
      register: out

    - name: update metric filter
      assert:
        that:
          - out is changed

    - name: checkmode delete metric filter on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        state: absent
      check_mode: yes
      register: out

    - name: check_mode state must be changed
      assert:
        that:
          - out is changed

    - name: delete metric filter on ansible/integrationtest
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        state: absent
      register: out

    - name: delete metric filter
      assert:
        that:
          - out is changed

  always:
    - name: delete metric filter
      cloudwatchlogs_log_group_metric_filter:
        <<: *aws_connection_info
        log_group_name: ansible/integrationtest
        filter_name: MadeWithAnsible
        state: absent

    - name: delete cloudwatch log group for integration test
      cloudwatchlogs_log_group:
        <<: *aws_connection_info
        state: absent
        log_group_name: ansible/integrationtest
