###
# setup portstree if needed
- name: silent install of subversion and ca root certs with pkgng
  pkgng:
    name: subversion,ca_root_nss
    state: present
  
- name: checkout a tested revision of the ports tree to make the tests less dependent on externals
  subversion:
    repo: https://svn.FreeBSD.org/ports/head
    dest: /usr/ports
    revision: 493256
    force: yes

###
# test portmake absent

- name: check absence of package screen
  command: pkg info tmux
  register: pkg_info_out
  failed_when: pkg_info_out.rc == 0

- name: test removal of package tmux  not installed
  portmake:
    name: "sysutils/tmux"
    state: "absent"
    
- name: test removal of package tmux not installed with unneded options
  portmake:
    name: "sysutils/tmux"
    state: "absent"
    options_set: "BACKSPACE"


###
# test portmake present

- name: remove an possibly existing make.conf.
  file:
    path: /etc/make.conf
    state: absent

- name: set default python version for build to work...
  lineinfile:
    path: /etc/make.conf
    line: 'DEFAULT_VERSIONS += python=3.6'
    create: yes

- name: install a port with options - tmux
  portmake:
    name: sysutils/tmux
    options_set: "BACKSPACE"
    options_unset: "EXAMPLES"
    state: "present"

- name: check for added compile paramter of package tmux
  shell: "pkg info tmux | grep BACKSPACE"
  register: pkg_info_out
  failed_when: pkg_info_out.stdout.find("on") == -1

- name: check compile option EXAMPLES is absent
  shell: "pkg info tmux | grep 'EXAMPLES'"
  register: pkg_info_out
  failed_when: pkg_info_out.stdout.find("off") == -1

- name: write a test line to make.conf file to test it is not overwritten
  lineinfile:
    path: /etc/make.conf
    line: 'TEST_VARIABLE=nonsense'
    create: yes

- name: test installation of same package with an aditional option  and previous option saved in /etc/make.conf
  portmake:
    name: sysutils/tmux
    state: "present"
    options_set: "LIBEVENT_STATIC"
    disable_vulnerabilities: true
    
- name: check old compile paramter of package
  shell: "pkg info tmux | grep 'BACKSPACE'"
  register: pkg_info_out
  failed_when: pkg_info_out.stdout.find("on") == -1

- name: check compile option EXAMPLES is absent
  shell: "pkg info tmux | grep 'EXAMPLES'"
  register: pkg_info_out
  failed_when: pkg_info_out.stdout.find("off") == -1

- name: check new compile paramter of package
  shell: "pkg info tmux | grep 'LIBEVENT_STATIC'"
  register: pkg_info_out
  failed_when: pkg_info_out.stdout.find("on") == -1

- name: check test line in make.conf is still here
  command: "grep 'TEST_VARIABLE=nonsense' /etc/make.conf"
  register: grep_makeconf_out
  failed_when: grep_makeconf_out.rc != 0

###
# tests portmake absent removing pkg and make.conf lines

- name: uninstall tmux with unecessary options
  portmake:
    name: sysutils/tmux
    options_set: "BACKSPACE"
    options_unset: "EXAMPLES DOCS"
    state: "absent"
    disable_vulnerabilities: true
    
- name: check all options in make.conf are removed for tmux
  command: "grep 'sysutils_tmux_' /etc/make.conf"
  register: grep_makeconf_out
  failed_when: grep_makeconf_out.rc == 0
