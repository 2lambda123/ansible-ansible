- name: Prepare random number
  set_fact:
    rpfx: "{{ resource_group | hash('md5') | truncate(7, True, '') }}{{ 1000 | random }}"
  run_once: yes

- name: Create Recovery Services vault
  azure_rm_recoveryservicesvault:
    resource_group: "{{ resource_group }}"
    name: "myVault{{ rpfx }}"
    sku_name: Standard
    location: westus
  register: output

- assert:
    that: 
      - output.changed

- name: Update Recovery Services vault
  azure_rm_recoveryservicesvault:
    resource_group: "{{ resource_group }}"
    name: "myVault{{ rpfx }}"
    sku_name: RS0
    upgrade_details:
      message: myMessage
  register: output

- assert:
    that: 
      - output.changed

- name: Get Info of Recovery Services Resource
  azure_rm_recoveryservicesvault_info:
    resource_group: "{{ resource_group }}"
    name: "myVault{{ rpfx }}"
  register: output

- assert:
    that: 
      - not output.changed
      - output.vaults['id'] != None
      - output.vaults['name'] != None
      - output.vaults['location'] != None
      - output.vaults['e_tag'] != None
      - output.vaults['sku_name'] != None
      - output.vaults['upgrade_details'] != None
      - output.vaults['provisioning_state'] != None

- name: Delete Recovery Services Vault
  azure_rm_recoveryservicesvault:
    resource_group: "{{ resource_group }}"
    name: "myVault{{ rpfx }}"
    state: absent
  register: output

- assert:
    that: 
      - output.changed
