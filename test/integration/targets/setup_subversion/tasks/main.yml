---
- name: load OS specific vars
  include_vars: '{{ ansible_os_family }}.yml'

- name: install SVN pre-reqs
  package:
    name: '{{ subversion_packages }}'
    state: present

- name: create SVN home folder
  file:
    path: '{{ subversion_home }}'
    state: directory

- name: set SELinux security context for SVN folder
  sefcontext:
    target: '{{ subversion_home }}(/.*)?'
    setype: '{{ item }}'
    state: present
  when: ansible_selinux.status == "enabled"
  with_items:
  - httpd_sys_content_t
  - httpd_sys_rw_content_t

- name: apply new SELinux context to filesystem
  command: restorecon -irv {{ subversion_home }}
  when: ansible_selinux.status == "enabled"

- name: template out configuration file
  template:
    src: subversion.conf.j2
    dest: '{{ apache_conf_path }}'

- name: create a test repository
  script: create_repo.sh {{ subversion_repo_name }}
  args:
    chdir: '{{ subversion_home }}'
    creates: '{{ subversion_home }}/{{ subversion_repo_name }}'

- name: apply ownership for all SVN directories
  file:
    path: '{{ subversion_home }}'
    owner: '{{ apache_user }}'
    group: '{{ apache_group }}'
    recurse: True

- name: add test user
  htpasswd:
    path: '{{ subversion_home }}/svn-auth-users'
    name: '{{ subversion_username }}'
    password: '{{ subversion_password }}'
    state: present

- name: load the dav module for SUSE
  lineinfile:
    path: /etc/apache2/httpd.conf
    line: LoadModule dav_module {{ apache_module_path }}/mod_dav.so
    insertbefore: BOF
    state: present
  when: ansible_os_family == 'Suse'

- name: set the port for httpd
  lineinfile:
    path: '{{ apache_listen_conf_path }}'
    line: Listen {{ apache_port }}
    regexp: '^Listen\s*\d*$'
    state: present

- name: enable apache24 for FreeBSD
  lineinfile:
    path: /etc/rc.conf
    line: apache24_enable=YES
    state: present
  when: ansible_os_family == 'FreeBSD'

- name: restart apache
  service:
    name: '{{ apache_service }}'
    state: restarted
