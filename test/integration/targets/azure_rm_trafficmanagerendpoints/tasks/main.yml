---
- name: Create traffic manager
  set_fact:
    resource_group: "{{ resource_group }}"
    traffic_manager_name: "ansible-{{ resource_group | hash('md5') | truncate(24, True, '') }}"
    endpoint_name: "ansible-{{ resource_group | hash('md5') | truncate(24, True, '') }}"

- name: Test traffic manager creation
  azure_rm_trafficmanagerprofile:
    name: "{{ traffic_manager_name }}"
    resource_group:  "{{ resource_group }}"
    properties:
      profile_status: "Enabled"
      traffic_routing_method: "Performance"
      location: "global"
      monitor_config:
         protocol: "HTTP"
         path: "/"
         port: 80
         interval_in_seconds: 30
         timeout_in_seconds: 10
    state: "present"

- name: Test traffic manager endpoint creation
  azure_rm_trafficmanagerendpoints:
    resource_group:  "{{ resource_group }}"
    profile_name: "{{ traffic_manager_name }}"
    endpoint_name: "{{ endpoint_name }} "
    endpoint_type: "ExternalEndpoints"
    state: "present"
    properties:
      target: "bananachips.ddns.net"
      endpoint_status: "Disabled"
      endpoint_location: "South Central US"
      tags:
        production: "no"
        provider: "azure"
  register: output
  # ignore_errors: yes

- name: Assert that the Endpoint exist
  assert:
    that:
      - output.changed

- name: Test Traffic Manager Endpoint removal
  azure_rm_trafficmanagerendpoints:
    state: absent
    resource_group: "{{ resource_group }}"
    profile_name: "{{ traffic_manager_name }}"
    endpoint_name: "endpoint1"
    endpoint_type: "ExternalEndpoints"

- name: Test Traffic Manager removal
  azure_rm_trafficmanagerprofile:
    state: absent
    name: "{{ traffic_manager_name }}"
    resource_group: "{{ resource_group }}"
