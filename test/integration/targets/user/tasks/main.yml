# Test code for the user module.
# (c) 2017, James Tanner <tanner.jc@gmail.com>

# This file is part of Ansible
#
# Ansible is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Ansible is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.

##
## user add
##

- name: try to create a user
  user:
      name: ansibulluser
      state: present
  register: user_test0
- debug: var=user_test0

- name: make a list of users
  shell: |
      cat /etc/passwd | cut -d: -f1
  register: user_names
- debug: var=user_names

- name: validate results for testcase 0
  assert:
      that:
          - 'user_test0.changed is defined'
          - 'user_test0.changed'
          - '"ansibulluser" in user_names.stdout_lines'


##
## user check
##

- name: run existing user check tests
  user:
      name: "{{ user_names.stdout_lines|random }}"
      state: present
      createhome: no
  with_sequence: start=1 end=5
  register: user_test1
- debug: var=user_test1

- debug: msg="{{ user_test1.results|map(attribute='changed')|unique|list }}"

- name: validate results for testcase 1
  assert:
      that:
          - 'user_test1.results is defined'
          - 'user_test1.results|length == 5'
          - "user_test1.results|map(attribute='changed')|unique|list == [False]"
          - "user_test1.results|map(attribute='state')|unique|list == ['present']"

##
## user remove
##
            
- name: try to delete the user
  user:
      name: ansibulluser
      state: absent
  register: user_test2
- name: make a new list of users
  shell: |
      cat /etc/passwd | cut -d: -f1
  register: user_names2
- debug: var=user_names2
- name: validate results for testcase 2
  assert:
      that:
          - '"ansibulluser" not in user_names2.stdout_lines'
