---
- name: Compress parent directory
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: yes
    recurse: no
  register: result

- name: Get actual attributes for parent directory
  win_stat:
    path: "{{ test_directory.path }}"
  register: folder_info

- assert:
    that:
      - "'Compressed' in folder_info.stat.attributes"
      - "result.changed == true"

- name: Get actual attributes for sub directories
  win_stat:
    path: "{{ test_directory.path }}\\{{ item }}"
  register: subfolder_info
  loop: "{{ test_win_file_compression_sub_directories }}"

- assert:
    that:
      - "'Compressed' not in item.stat.attributes"
  loop: "{{ subfolder_info.results }}"

- name: Compress parent directory (idempotent)
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: yes
    recurse: no
  register: result

- assert:
    that:
      - "result.changed == false"

- name: Compress parent directory and all subdirectories
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: yes
    recurse: yes
  register: result

- name: Get actual attributes for parent directory
  win_stat:
    path: "{{ test_directory.path }}"
  register: folder_info

- assert:
    that:
      - "'Compressed' in folder_info.stat.attributes"
      - "result.changed == true"

- name: Get actual attributes for sub directories
  win_stat:
    path: "{{ test_directory.path }}\\{{ item }}"
  register: subfolder_info
  loop: "{{ test_win_file_compression_sub_directories }}"

- assert:
    that:
      - "'Compressed' in item.stat.attributes"
  loop: "{{ subfolder_info.results }}"

- name: Compress parent directory and all subdirectories (idempotent)
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: yes
    recurse: yes
  register: result

- assert:
    that:
      - "result.changed == false"

- name: Uncompress parent directory
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: no
    recurse: no
  register: result

- name: Get actual attributes for parent directory
  win_stat:
    path: "{{ test_directory.path }}"
  register: folder_info

- assert:
    that:
      - "'Compressed' not in folder_info.stat.attributes"
      - "result.changed == true"

- name: Get actual attributes for sub directories
  win_stat:
    path: "{{ test_directory.path }}\\{{ item }}"
  register: subfolder_info
  loop: "{{ test_win_file_compression_sub_directories }}"

- assert:
    that:
      - "'Compressed' in item.stat.attributes"
  loop: "{{ subfolder_info.results }}"

- name: Uncompress parent directory (idempotent)
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: no
    recurse: no
  register: result

- assert:
    that:
      - "result.changed == false"

- name: Uncompress parent directory and all subdirectories
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: no
    recurse: yes
  register: result

- name: Get actual attributes for parent directory
  win_stat:
    path: "{{ test_directory.path }}"
  register: folder_info

- assert:
    that:
      - "'Compressed' not in folder_info.stat.attributes"
      - "result.changed == true"

- name: Get actual attributes for sub directories
  win_stat:
    path: "{{ test_directory.path }}\\{{ item }}"
  register: subfolder_info
  loop: "{{ test_win_file_compression_sub_directories }}"

- assert:
    that:
      - "'Compressed' not in item.stat.attributes"
  loop: "{{ subfolder_info.results }}"

- name: Uncompress parent directory and all subdirectories (idempotent)
  win_file_compression:
    path: "{{ test_directory.path }}"
    compressed: no
    recurse: yes
  register: result

- assert:
    that:
      - "result.changed == false"

- name: Create test file
  win_file:
    state: touch
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"

- name: Compress specific file
  win_file_compression:
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"
    compressed: yes
  register: result

- name: Get actual attributes of file
  win_stat:
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"
  register: testfile_info

- assert:
    that:
      - "result.changed == true"
      - "'Compressed' in testfile_info.stat.attributes"

- name: Compress specific file (idempotent)
  win_file_compression:
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"
    compressed: yes
  register: result

- assert:
    that:
      - "result.changed == false"

- name: Uncompress specific file
  win_file_compression:
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"
    compressed: no
  register: result

- name: Get actual attributes of file
  win_stat:
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"
  register: testfile_info

- assert:
    that:
      - "result.changed == true"
      - "'Compressed' not in testfile_info.stat.attributes"

- name: Uncompress specific file (idempotent)
  win_file_compression:
    path: "{{ test_directory.path }}\\{{ test_win_file_compression_filename }}"
    compressed: no
  register: result

- assert:
    that:
      - "result.changed == false"
