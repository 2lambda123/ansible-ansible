- block:
    - name: Get current hostname
      command: hostname
      register: original

    - name: Run hostname module in check_mode
      hostname:
        name: crocodile.ansible.test.doesthiswork.net.example.com
      check_mode: true

    - name: Make sure no file was altered
      lineinfile:
        path: /etc/sysconfig/network
        line: HOSTNAME=crocodile.ansible.test.doesthiswork.net.example.com
      check_mode: true
      register: etc_sysconfig_network
      failed_when: etc_sysconfig_network is not changed

    - name: Ensure hostname was not altered either
      command: hostname
      register: current_after_cm

    - assert:
        that:
          - original.stdout == current_after_cm.stdout

    - name: Run hostname module for real now
      hostname:
        name: crocodile.ansible.test.doesthiswork.net.example.com
      register: hostname1

    - name: Get hostname
      command: hostname
      register: current_after_hostname1

    - name: Run hostname again to ensure it is idempotent
      hostname:
        name: crocodile.ansible.test.doesthiswork.net.example.com
      register: hostname2

    - name: Get hostname
      command: hostname
      register: current_after_hostname2

    - assert:
        that:
          - hostname1 is changed
          - hostname2 is not changed
          - current_after_hostname1.stdout == 'crocodile.ansible.test.doesthiswork.net.example.com'
          - current_after_hostname1.stdout == current_after_hostname2.stdout

    - name: Make sure we used SystemdStrategy...
      lineinfile:
        path: /etc/hostname
        line: crocodile.ansible.test.doesthiswork.net.example.com
      check_mode: true
      register: etc_hostname

    - name: ...and not RedhatStrategy
      lineinfile:
        path: /etc/sysconfig/network
        line: HOSTNAME=crocodile.ansible.test.doesthiswork.net.example.com
      check_mode: true
      register: etc_sysconfig_network

    - assert:
        that:
          - etc_hostname is not changed
          - etc_sysconfig_network is changed
  always:
    # Reset back to original hostname
    - hostname:
        name: "{{ original.stdout }}"
      register: revert

    # And make sure we really do
    - assert:
        that:
          - revert is changed
