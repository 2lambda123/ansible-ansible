- block:
    - name: Get current hostname
      command: hostname
      register: original

    - name: See if current hostname file exists
      stat:
        path: /etc/rc.conf.d/hostname
      register: hn_stat

    - name: Move the current hostname file if it exists
      command: mv /etc/rc.conf.d/hostname /etc/rc.conf.d/hostname.orig
      when: hn_stat.stat.exists

    - name: Run hostname module in check_mode
      hostname:
        name: crocodile.ansible.test.doesthiswork.net.example.com
      check_mode: true
      register: hn

    - stat:
        path: /etc/rc.conf.d/hostname
      register: hn_stat_checkmode

    - assert:
        that:
          # TODO: This is a legitimate bug and will be fixed in another PR.
          # - not hn_stat_checkmode.stat.exists
          - hn is changed

    - name: Get hostname again
      command: hostname
      register: current_after_cm

    - assert:
        that:
          - original.stdout == current_after_cm.stdout

    - name: Run hostname module for real now
      hostname:
        name: crocodile.ansible.test.doesthiswork.net.example.com
      register: hostname1

    - name: Get hostname
      command: hostname
      register: current_after_hostname1

    - name: Run hostname again to ensure it is idempotent
      hostname:
        name: crocodile.ansible.test.doesthiswork.net.example.com
      register: hostname2

    - name: Get hostname
      command: hostname
      register: current_after_hostname2

    - assert:
        that:
          - hostname1 is changed
          - hostname2 is not changed
          - current_after_hostname1.stdout == 'crocodile.ansible.test.doesthiswork.net.example.com'
          - current_after_hostname1.stdout == current_after_hostname2.stdout
  always:
    # Reset back to original hostname
    - name: Move back original file if it existed
      command: mv -f /etc/rc.conf.d/hostname.orig /etc/rc.conf.d/hostname
      when: hn_stat.stat.exists

    - name: Delete the file if it never existed
      file:
        path: /etc/rc.conf.d/hostname
        state: absent
      when: not hn_stat.stat.exists

    - hostname:
        name: "{{ original.stdout }}"
      register: revert

    - assert:
        that:
          - revert is changed
