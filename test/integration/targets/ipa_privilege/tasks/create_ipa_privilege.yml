---

- name: Create a privilege without permission.
  block:
    - ipa_privilege:
        cn: "{{ ipa_privilege_cn }}"
        description: Testing privilege.
        state: present
        ipa_host: "{{ freeipa_server_domain }}"
        ipa_user: "{{ freeipa_admin }}"
        ipa_pass: "{{ freeipa_admin_password }}"
        validate_certs: "{{ freeipa_validate_certs }}"

    - shell:
        "echo {{ freeipa_admin_password }} | kinit {{ freeipa_admin }} && ipa privilege-find {{ ipa_privilege_cn }}"
      register: ipa_privilege_output

    - assert:
        that:
          - '"Number of entries returned 1" in ipa_privilege_output.stdout'

    - ipa_privilege:
        cn: "{{ ipa_privilege_cn }}"
        state: absent
        ipa_host: "{{ freeipa_server_domain }}"
        ipa_user: "{{ freeipa_admin }}"
        ipa_pass: "{{ freeipa_admin_password }}"
        validate_certs: "{{ freeipa_validate_certs }}"

- name: Create a privilege with a non-existent permission.
  block:
    - ipa_privilege:
        cn: "{{ ipa_privilege_cn }}"
        description: Test privilege
        permission:
          - "{{ ipa_permission_cn1 }}"
        ipa_host: "{{ freeipa_server_domain }}"
        ipa_user: "{{ freeipa_admin }}"
        ipa_pass: "{{ freeipa_admin_password }}"
        validate_certs: "{{ freeipa_validate_certs }}"
      ignore_errors: true
      register: ipa_privilege_output

    - assert:
        that:
          - true == ipa_privilege_output.failed

    - ipa_privilege:
        cn: "{{ ipa_privilege_cn }}"
        state: absent
        ipa_host: "{{ freeipa_server_domain }}"
        ipa_user: "{{ freeipa_admin }}"
        ipa_pass: "{{ freeipa_admin_password }}"
        validate_certs: "{{ freeipa_validate_certs }}"

- name: Create a privilege with a existing permission.
  block:
    - ipa_permission:
        cn: "{{ ipa_permission_cn1 }}"
        ipapermbindruletype: permission
        ipapermright:
          - read
        type: user
        attrs:
          - cn
        state: present
        ipa_host: "{{ freeipa_server_domain }}"
        ipa_user: "{{ freeipa_admin }}"
        ipa_pass: "{{ freeipa_admin_password }}"
        validate_certs: "{{ freeipa_validate_certs }}"

    - ipa_privilege:
        cn: "{{ ipa_privilege_cn }}"
        description: Test privilege
        permission:
          - "{{ ipa_permission_cn1 }}"
        ipa_host: "{{ freeipa_server_domain }}"
        ipa_user: "{{ freeipa_admin }}"
        ipa_pass: "{{ freeipa_admin_password }}"
        validate_certs: "{{ freeipa_validate_certs }}"
      ignore_errors: true
      register: ipa_privilege_output

    - assert:
        that:
          - '"{{ ipa_permission_cn1 }}" in ipa_privilege_output.privilege.memberof_permission'
