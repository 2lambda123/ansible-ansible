---

- name: Remove a permission which belongs to a privilege.
  block:
    - ipa_permission:
        cn: "{{ ipa_permission_cn1 }}"
        ipapermbindruletype: permission
        ipapermright:
          - read
        type: user
        attrs:
          - cn
        state: present
        ipa_host: "{{ ipa_host }}"
        ipa_user: "{{ ipa_user }}"
        ipa_pass: "{{ ipa_pass }}"
        validate_certs: "{{ ipa_validate_certs }}"

    - ipa_privilege:
        cn: "{{ ipa_privilege_cn }}"
        permission:
          - "{{ ipa_permission_cn1 }}"
        state: present
        ipa_host: "{{ ipa_host }}"
        ipa_user: "{{ ipa_user }}"
        ipa_pass: "{{ ipa_pass }}"
        validate_certs: "{{ ipa_validate_certs }}"

    - ipa_permission:
        cn: "{{ ipa_permission_cn1 }}"
        ipapermbindruletype: permission
        state: absent
        ipa_host: "{{ ipa_host }}"
        ipa_user: "{{ ipa_user }}"
        ipa_pass: "{{ ipa_pass }}"
        validate_certs: "{{ ipa_validate_certs }}"

    - shell:
        "echo {{ ipa_pass }} | kinit {{ ipa_user }} && ipa privilege-find --all {{ ipa_privilege_cn }}"
      register: ipa_privilege_output

    - assert:
        that:
          - '"Permissions:" not in ipa_privilege_output.stdout'
