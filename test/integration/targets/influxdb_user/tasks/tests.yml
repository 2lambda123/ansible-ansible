---

- name: Install influxdb python module
  pip: name=influxdb

- name: Check adding admin user
  block:
    - name: Add admin user
      influxdb_user: user_name=admin user_password=admin admin=yes
      register: add_admin_user

    - name: Check that admin user adding succeeds with a change
      assert:
        that:
          - add_admin_user.changed == true

- name: Enable authentication and restart service
  block:
    - name: Enable authentication
      lineinfile:
        path: /etc/influxdb/influxdb.conf
        regexp: 'auth-enabled ='
        line: '  auth-enabled = true'

    - name: Restart InfluxDB service
      service: name=influxdb state=restarted

- name: Check adding user when authentication enabled
  block:
    - name: Add user
      influxdb_user: user_name=user user_password=user login_username=admin login_password=admin
      register: add_user_with_auth_enabled

    - name: Check that adding user with enabled authentication succeeds with a change
      assert:
        that:
          - add_user_with_auth_enabled.changed == true

- name: Check adding the same user
  block:
    - name: Add the same user
      influxdb_user: user_name=user user_password=user login_username=admin login_password=admin
      register: same_user

    - name: Check that adding same user succeeds without a change
      assert:
        that:
          - same_user.changed == false
