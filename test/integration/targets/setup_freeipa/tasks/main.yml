---

- block:
    - name: Ensure FreeIPA server hostname is set.
      hostname:
        name: "{{ freeipa_server_domain }}"

    - name: Install Samba.
      yum:
        name: samba
        state: present

    - name: Install ipa-server packages.
      yum:
        name:
          - "ipa-server"
          - "ipa-server-dns"
        state: present

    - name: Check ipa-server setup.
      command: ipa service-find --all
      register: freeipa_output

    - name: Configure ipa-server.
      command:
        ipa-server-install
          --unattended
          --ds-password={{ freeipa_ds_password }}
          --admin-password={{ freeipa_admin_password }}
          --ip-address={{ freeipa_server_ip }}
          --domain={{ freeipa_domain }}
          --realm={{ freeipa_domain | upper }}
          --hostname={{ freeipa_server_domain }}
          --setup-kra
          --setup-dns
          --idstart=100000
          --idmax=199999
          --no-hbac-allow
          --mkhomedir
          --ssh-trust-dns
          --auto-reverse
          --auto-forwarders
          --forward-policy=first
          --no-dnssec-validation
      when: '"Number of entries returned 5" not in freeipa_output.stdout'

    - name: Install Freeipa Server | Enable ntpd.
      systemd:
        name: ntpd
        state: started
        enabled: true
  when:
  - ansible_os_family == "RedHat" and ansible_distribution_major_version|int <= 7
