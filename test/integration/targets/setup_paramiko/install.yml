- hosts: localhost
  tasks:
    - name: Detect Paramiko
      detect_paramiko:
      register: detect_paramiko

    - name: Persist Result
      copy:
        content: "{{ detect_paramiko }}"
        dest: "{{ lookup('env', 'OUTPUT_DIR') }}/detect-paramiko.json"

    - block:
        - name: Figure out pip version
          command: "{{ ansible_python_interpreter }} -c 'import pip; print(pip.__version__)'"
          register: pip_version
          ignore_errors: true

        - name: Figure out python-cryptography pip constraint
          set_fact:
            cryptography_constraint: "{{ '' if pip_version.stdout is version('19', '>=') else '>=2.5,<3.4' }}"
          when: pip_version is successful

        - debug:
            msg:
              - '{{ pip_version }}'
              - '{{ cryptography_constraint }}'
          when: pip_version is successful

        - name: Install Paramiko
          include_tasks: "{{ item }}"
          with_first_found:
            - "install-{{ ansible_distribution }}-{{ ansible_distribution_version }}-python-{{ ansible_python.version.major }}.yml"
            - "install-{{ ansible_distribution }}-{{ ansible_distribution_major_version }}-python-{{ ansible_python.version.major }}.yml"
            - "install-{{ ansible_os_family }}-{{ ansible_distribution_major_version }}-python-{{ ansible_python.version.major }}.yml"
            - "install-{{ ansible_os_family }}-python-{{ ansible_python.version.major }}.yml"
            - "install-python-{{ ansible_python.version.major }}.yml"
            - "install-fail.yml"
      when: not detect_paramiko.found
