- block:
    - name: CLEANUP | Leave Docker Swarm
      docker_swarm:
        state: absent
        force: true

    - name: CLEANUP | Restart docker daemon
      service:
        name: docker
        state: restarted
      become: yes
      ignore_errors: yes
      register: restart_docker

  rescue:
    - name: CLEANUP | Kill docker daemon
      command: systemctl kill -s 9 docker
      become: yes

    - name: CLEANUP | Clear out /var/lib/docker
      shell: rm -rf  /var/lib/docker/*
      args:
        warn: no

    - name: CLEANUP | Force Docker service start when restart was attempted too often
      command: systemctl reset-failed docker.service
      when:
        - ansible_facts.service_mgr == 'systemd'
        - restart_docker.msg is search('start of the service was attempted too often')

    - name: CLEANUP | Restart docker daemon
      service:
        name: docker
        state: restarted
      become: yes

    - name: CLEANUP | Wait for docker daemon to be fully restarted
      command: docker ps
      register: result
      until: result is success
      retries: 10

    - name: CLEANUP | Leave Docker Swarm
      docker_swarm:
        state: absent
        force: true
      diff: no
