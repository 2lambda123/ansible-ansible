---

- block:

    # ============================================================

        # Set up VPC, subnet, security group, instance

    - name: Announce setup start
      debug:
        msg: "***** SETTING UP TESTING DEPENDENCIES *****"

    - name: create a VPC to test in
      ec2_vpc_net:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        cidr_block: 10.0.0.0/24
        state: present
        name: '{{ test_id }}_setup'
        resource_tags:
          Name: '{{ test_id }}_setup'
      register: setup_vpc

    - name: create a key pair to use for creating an ec2 instance
      ec2_key:
        name: '{{ test_id }}_setup'
        state: present
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
      register: setup_key

    - name: create a subnet to use for creating an ec2 instance
      ec2_vpc_subnet:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        az: '{{ ec2_region }}a'
        tags: '{{ test_id }}_setup'
        vpc_id: '{{ setup_vpc.vpc.id }}'
        cidr: 10.0.0.0/24
        state: present
        resource_tags:
          Name: '{{ test_id }}_setup'
      register: setup_subnet

    - name: create a security group to use for creating an ec2 instance
      ec2_group:
        name: '{{ test_id }}_setup'
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        description: 'created by Ansible integration tests'
        state: present
        vpc_id: '{{ setup_vpc.vpc.id }}'
      register: setup_sg

    - name: provision ec2 instance to create an image
      ec2:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        key_name: '{{ setup_key.key.name }}'
        instance_type: t2.micro
        state: present
        image: '{{ ec2_ami_image[ec2_region] }}'
        wait: yes
        instance_tags:
          '{{ test_id }}_instance_setup': 'integration_tests'
        group_id: '{{ setup_sg.group_id }}'
        vpc_subnet_id: '{{ setup_subnet.subnet.id }}'
      register: setup_instance

    - name: Announce testing start
      debug:
        msg: "***** SETTING UP TESTING DEPENDENCIES COMPLETE. RUNNING TESTS. *****"

    # ============================================================
    - name: test failure with no parameters
      ec2_snapshot:
      register: result
      ignore_errors: true

    - name: assert failure with no parameters
      assert:
        that:
           - result.failed
           - result.msg == "Either region or ec2_url must be specified"

    # ============================================================
    - name: test failure with no credentials
      ec2_snapshot:
        ec2_region: '{{ ec2_region }}'
      register: result
      ignore_errors: true

    - name:
      assert:
        that:
          - result.failed
          - result.msg == "No handler was ready to authenticate. 1 handlers were checked. ['HmacAuthV4Handler'] Check your credentials"

    # ============================================================

    - name: create a snapshot of the instance
      ec2_snapshot:
        ec2_region: '{{ec2_region}}'
        ec2_access_key: '{{ec2_access_key}}'
        ec2_secret_key: '{{ec2_secret_key}}'
        security_token: '{{security_token}}'
        instance_id: '{{ setup_instance.instance_ids[0] }}'
        device_name: /dev/xvda
        state: present
        snapshot_tags:
          Ansible: IntegrationTests
      register: snapshot_1

    - name: assert that a snapshot was created
      assert:
        that:
          - snapshot_1.changed
          - snapshot_1.snapshot_id.startswith('snap-')
          - snapshot_1.volume_id.startswith('vol-')
          - snapshot_1.volume_size == 8
          - "snapshot_1.tags == {'Ansible': 'IntegrationTests'}"

    # ============================================================

    - name: wait to avoid rate limits
      pause:
        seconds: 30

    # ============================================================

# FIXME: Currently ec2_snapshot does not support adding or removing tags
#    - name: modify snapshot tags
#      ec2_snapshot:
#        ec2_region: '{{ec2_region}}'
#        ec2_access_key: '{{ec2_access_key}}'
#        ec2_secret_key: '{{ec2_secret_key}}'
#        security_token: '{{security_token}}'
#        snapshot_id: '{{ snapshot.snapshot_id }}'
#        state: present
#        snapshot_tags:
#          Another: Tag
#          Ansible: IntegrationTests
#      register: snapshot

#    - name: assert that tags have been modified
#      assert:
#        that:
#          - snapshot.changed
#          - "'Another' in snapshot.tags"
#          - "'Ansible' in snapshot.tags"

    # ============================================================

# FIXME: currently ec2_snapshot does not support creating encrypted snapshots

    # ============================================================

    - name: create a snapshot from the volume id
      ec2_snapshot:
        ec2_region: '{{ec2_region}}'
        ec2_access_key: '{{ec2_access_key}}'
        ec2_secret_key: '{{ec2_secret_key}}'
        security_token: '{{security_token}}'
        volume_id: '{{ snapshot_1.volume_id }}'
        state: present
        snapshot_tags:
          Another: Tag
          Ansible: IntegrationTests
      register: snapshot_2

    - name: assert a new snapshot has been created
      assert:
        that:
          - snapshot_1.snapshot_id != snapshot_2.snapshot_id
          - snapshot_2.changed
          - "'Another' in snapshot_2.tags"
          - "'Ansible' in snapshot_2.tags"

    # ============================================================

    - name: wait to avoid rate limits
      pause:
        seconds: 30

    # ============================================================

    - name: test deleting a snapshot without providing a unique identifier
      ec2_snapshot:
        ec2_region: '{{ec2_region}}'
        ec2_access_key: '{{ec2_access_key}}'
        ec2_secret_key: '{{ec2_secret_key}}'
        security_token: '{{security_token}}'
        state: absent
      ignore_errors: true
      register: result

    - name: assert failure
      assert:
        that:
          - result.failed
          - result.msg == "One and only one of volume_id or instance_id or snapshot_id must be specified"

    # ============================================================

    - name: test deleting a snapshot providing only the volume id
      ec2_snapshot:
        ec2_region: '{{ec2_region}}'
        ec2_access_key: '{{ec2_access_key}}'
        ec2_secret_key: '{{ec2_secret_key}}'
        security_token: '{{security_token}}'
        state: absent
        volume_id: '{{ snapshot_2.volume_id }}'
      ignore_errors: true
      register: result

    - name: assert failure
      assert:
        that:
          - result.failed
          - result.msg == "snapshot_id must be set when state is absent"

    # ============================================================

    - name: test deleting a snapshot providing snapshot_id
      ec2_snapshot:
        ec2_region: '{{ec2_region}}'
        ec2_access_key: '{{ec2_access_key}}'
        ec2_secret_key: '{{ec2_secret_key}}'
        security_token: '{{security_token}}'
        state: absent
        snapshot_id: '{{ snapshot_1.snapshot_id }}'
      ignore_errors: true
      register: result

    - name: assert the snapshot was deleted
      assert:
        that:
          - result.changed

# FIXME: ec2_snapshot_facts fails with ClientError if given a snapshot_id that has been deleted
#    - name: verify the snapshot was deleted
#      ec2_snapshot_facts:
#        ec2_region: '{{ec2_region}}'
#        ec2_access_key: '{{ec2_access_key}}'
#        ec2_secret_key: '{{ec2_secret_key}}'
#        security_token: '{{security_token}}'
#        snapshot_ids:
#          - '{{ snapshot_1.snapshot_id }}'
#      ignore_errors: true
#      register: result

    # ============================================================

  always:

    # ============================================================


    # TEAR DOWN: snapshot, ec2 instance, ec2 key pair, security group, vpc
    - name: Announce teardown start
      debug:
        msg: "***** TESTING COMPLETE. COMMENCE TEARDOWN *****"

    - name: remove snapshots
      ec2_snapshot:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        state: absent
        snapshot_id: '{{ item }}'
      with_items:
        - "{{ snapshot_1.snapshot_id }}"
        - "{{ snapshot_2.snapshot_id }}"
      ignore_errors: yes

    - name: remove setup ec2 instance
      ec2:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        instance_type: t2.micro
        instance_ids: '{{ setup_instance.instance_ids }}'
        state: absent
        wait: yes
        instance_tags:
          '{{ test_id }}_instance_setup': 'integration_tests'
        group_id: '{{ setup_sg.group_id }}'
        vpc_subnet_id: '{{ setup_subnet.subnet.id }}'
      ignore_errors: yes

    - name: remove setup keypair
      ec2_key:
        name: '{{ test_id }}_setup'
        state: absent
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
      ignore_errors: yes

    - name: debug vpc
      debug:
        var: "{{ setup_vpc }}"

    - name: remove setup security group
      ec2_group:
        name: '{{ test_id }}_setup'
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        description: 'created by Ansible integration tests'
        state: absent
        vpc_id: '{{ setup_vpc.vpc.id }}'
      ignore_errors: yes

    - name: remove setup subnet
      ec2_vpc_subnet:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        az: '{{ ec2_region }}a'
        tags: '{{ test_id }}_setup'
        vpc_id: '{{ setup_vpc.vpc.id }}'
        cidr: 10.0.0.0/24
        state: absent
        resource_tags:
          Name: '{{ test_id }}_setup'
      ignore_errors: yes

    - name: remove setup VPC
      ec2_vpc_net:
        ec2_region: '{{ ec2_region }}'
        ec2_access_key: '{{ ec2_access_key }}'
        ec2_secret_key: '{{ ec2_secret_key }}'
        security_token: '{{ security_token }}'
        cidr_block: 10.0.0.0/24
        state: absent
        name: '{{ test_id }}_setup'
        resource_tags:
          Name: '{{ test_id }}_setup'
      ignore_errors: yes
