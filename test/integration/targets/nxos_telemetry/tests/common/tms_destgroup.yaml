---
- debug: msg="START connection={{ ansible_connection }} nxos_telemetry destgroup sanity test"
- debug: msg="Using provider={{ connection.transport }}"
  when: ansible_connection == "local"

- name: Setup
  nxos_feature: &setup_teardown
    feature: telemetry
    provider: "{{ connection }}"
    state: disabled
  ignore_errors: yes

- block:
  - name: Telemetry DestGroup - merged
    nxos_telemetry: &tms_destgroup_merged
      state: 'merged'
      config:
        destination_groups:
          - { id: 2, destination: {ip: 192.168.0.1, port: 50001, protocol: grpc, encoding: gpb}}
          - { id: 2, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: GPB}}
          - { id: 10, destination: {ip: 192.168.0.1, port: 50001, protocol: Grpc, encoding: gPB}}
          - { id: 10, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
      provider: "{{ connection }}"
    register: result

  - assert: &true
      that:
        - "result.changed == true"

  - name: Telemetry DestGroup - merged - idempotence
    nxos_telemetry: *tms_destgroup_merged
    register: result

  - assert: &false
      that:
        - "result.changed == false"

  - name: Telemetry DestGroup - deleted
    nxos_telemetry: &tms_destgroup_deleted
      state: 'deleted'
      config:
        destination_groups:
          - { id: 2, destination: {ip: 192.168.0.1, port: 50001, protocol: grpc, encoding: gpb}}
          - { id: 2, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: GPB}}
          - { id: 10, destination: {ip: 192.168.0.1, port: 50001, protocol: Grpc, encoding: gPB}}
          - { id: 10, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
      provider: "{{ connection }}"
    register: result

  - assert: *true

  - name: Telemetry DestGroup - deleted - idempotence
    nxos_telemetry: *tms_destgroup_deleted
    register: result

  - assert: *false

  - name: Telemetry DestGroup Scale - merged
    nxos_telemetry: &tms_destgroup_scale_merged
      state: 'merged'
      config:
        destination_groups:
          - { id: 2, destination: {ip: 192.168.0.1, port: 50001, protocol: grpc, encoding: gpb}}
          - { id: 2, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: GPB}}
          - { id: 10, destination: {ip: 192.168.0.1, port: 50001, protocol: Grpc, encoding: gPB}}
          - { id: 11, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 12, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 13, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 14, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 15, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 16, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 17, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 18, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 19, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 20, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 21, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 22, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 23, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 24, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 25, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 26, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 27, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 28, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 29, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 30, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 31, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 32, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 33, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 34, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 35, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 36, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 37, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 38, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 39, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 40, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
          - { id: 41, destination: {ip: 192.168.0.2, port: 60001, protocol: gRPC, encoding: gpb}}
      provider: "{{ connection }}"
    register: result

  - assert: *true

  - name: Telemetry DestGroup Scale - merged - idempotence
    nxos_telemetry: *tms_destgroup_scale_merged
    register: result

  - assert: *false

  always:
  - name: Teardown
    nxos_feature: *setup_teardown
    ignore_errors: yes

  - debug: msg="END connection={{ ansible_connection }} nxos_telemetry destgroup sanity test"
