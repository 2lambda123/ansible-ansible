---
- debug: msg="START connection={{ ansible_connection }} nxos_telemetry replaced sanity test"

# - set_fact: source_interface="Loopback55"
#   when: imagetag and (major_version is version_compare('9.1', 'ge'))
#
# - set_fact: command_list_length=30
# - set_fact: command_list_length=31
#   when: imagetag and (major_version is version_compare('9.1', 'ge'))

- name: Setup - disable feature telemetry
  nxos_feature: &setup_teardown
    feature: telemetry
    state: disabled
  ignore_errors: yes

- name: Setup - enable feature telemetry
  nxos_feature:
    feature: telemetry
    state: enabled

- name: Setup - add initial telemetry config
  cli_config:
    config: |
      telemetry
        certificate test_cert host.example.com
        destination-profile
          use-vrf blue
          use-compression gzip
          source-interface loopback55
        destination-group 2
          ip address 192.168.0.1 port 50001 protocol gRPC encoding GPB
          ip address 192.168.0.2 port 60001 protocol gRPC encoding GPB
        destination-group 10
          ip address 192.168.0.1 port 50001 protocol gRPC encoding GPB
          ip address 192.168.0.2 port 60001 protocol gRPC encoding GPB
          ip address 192.168.1.1 port 55 protocol HTTP encoding JSON
          ip address 192.168.1.2 port 100 protocol gRPC encoding GPB
        destination-group 99
        sensor-group 2
          data-source NX-API
          path sys/bgp/inst depth unbounded query-condition foo filter-condition foo
        sensor-group 8
          data-source NX-API
          path sys/bgp depth 0 query-condition foo filter-condition foo
        sensor-group 55
          data-source DME
          path sys/bgp/inst/dom-default/peer-[10.10.10.11]/ent-[10.10.10.11] depth 0 query-condition foo filter-condition foo
          path sys/ospf depth 0 query-condition foo filter-condition or(eq(ethpmPhysIf.operSt,"down"),eq(ethpmPhysIf.operSt,"up"))
        sensor-group 77
        subscription 44
          dst-grp 2
          dst-grp 10
          snsr-grp 2 sample-interval 2000
          snsr-grp 8 sample-interval 2000
        subscription 55
          dst-grp 10
          snsr-grp 55 sample-interval 2000
        subscription 99
          dst-grp 2
          dst-grp 99
          snsr-grp 8 sample-interval 90000
          snsr-grp 77 sample-interval 2000

- block:
  - name: Gather Telemetry Facts Before Changes
    nxos_facts: &facts
      gather_subset:
        - '!all'
        - '!min'
      gather_network_resources:
        - telemetry

  - name: Telemetry - replaced
    nxos_telemetry: &replace
      state: 'replaced'
      config:
        certificate:
          key: /file_dir/new_server.key
          hostname: newhost.example.com
        vrf: management
        destination_groups:
          - id: 2
            destination:
              ip: 192.168.0.1
              port: 65001
              protocol: grpc
              encoding: gpb
          - id: 2
            destination:
              ip: 192.168.0.3
              port: 55001
              protocol: grpc
              encoding: gpb
        subscriptions:
          - id: 99
            destination_group: 10
            sensor_group:
              id: 100
              sample_interval: 2000
    register: result

  always:
  # - name: Teardown
  #   nxos_feature: *setup_teardown
  #   ignore_errors: yes

  - debug: msg="END connection={{ ansible_connection }} nxos_telemetry replaced sanity test"
