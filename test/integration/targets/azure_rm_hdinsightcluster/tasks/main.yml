- name: Prepare random number
  set_fact:
    rpfx: "{{ resource_group | hash('md5') | truncate(7, True, '') }}{{ 1000 | random }}"
  run_once: yes

- name: Create storage account
  azure_rm_storageaccount:
      resource_group: "{{ resource_group }}"
      name: "storage{{ rpfx }}"
      account_type: Standard_LRS
      location: eastus2

- name: Sample for Azure REST API - StorageAccounts_ListKeys
  azure_rm_resource:
    api_version: '2018-07-01'
    method: POST
    resource_group: "{{ resource_group }}"
    provider: storage
    resource_type: storageaccounts
    resource_name: "storage{{ rpfx }}"
    subresource:
      - type: listkeys
  register: storage_output

- debug:
    var: storage_output



- name: Sample for Azure REST API - Clusters_Create
  azure_rm_resource:
    # url: /subscriptions/{{ lookup('env','AZURE_SUBSCRIPTION_ID') }}/resourceGroups/{resourceGroupName}/providers/Microsoft.HDInsight/clusters/{clusterName}
    api_version: '2015-03-01-preview'
    resource_group: "{{ resource_group }}"
    provider: hdinsight
    resource_type: clusters
    resource_name: "cluster{{ rpfx }}"
    body:
      location: eastus2
      properties: 
        clusterVersion: 3.6
        osType: Linux
        tier: Standard
        clusterDefinition: 
          kind: spark
          configurations:
            gateway: 
              restAuthCredential.isEnabled: True  
              restAuthCredential.username: http-user
              restAuthCredential.password: MuABCPassword!!@123
            #core-site:  
            #  fs.defaultFS: wasb://zimscontainer@zimshdstorage.blob.core.windows.net
            #  fs.azure.account.key.storageaccount.blob.core.windows.net: kCx3snczqrc1AbuH4TZZ1k5RrpFoUEcOTOIfMuXC6Xo9QsWuTDAZor90x2aV5fE9w/el5GlOIT4HlpHadeiePA==
          #componentVersion:
          #  spark: 2.3
        storageProfile: 
          storageaccounts: 
            - name: "storage{{ resource_group }}.blob.core.windows.net"
              isDefault: true
              container: "cluster{{ rpfx }}"
              key: "{{ storage_output['response']['keys'][0]['value'] }}"
        computeProfile: 
          roles: 
            - name: headnode
              #minInstanceCount: 1
              targetInstanceCount: 2
              hardwareProfile: 
                vmSize: Standard_D3
              osProfile: 
                linuxOperatingSystemProfile: 
                  username: sshuser
                  password: MuABCPassword!!@123
            - name: workernode
              #minInstanceCount: 1
              targetInstanceCount: 4
              hardwareProfile: 
                vmSize: Standard_D3
              osProfile: 
                linuxOperatingSystemProfile: 
                  username: sshuser
                  password: MuABCPassword!!@123
  register: rest_output

- debug:
    var: rest_output

- name: Create instance of Cluster -- check mode
  azure_rm_hdinsightcluster:
    resource_group: "{{ resource_group }}"
    name: "cluster{{ rpfx }}"
    location: eastus2
    cluster_version: 3.6
    os_type: linux
    tier: standard
    cluster_definition:
      kind: spark
      configurations:
        gateway:
          #restAuthCredential.isEnabled: True
          restAuthCredential.username: http-user
          restAuthCredential.password: MuABCPassword!!@123 
    storage_profile:
      storageaccounts:
        - name: storage{{ rpfx }}.blob.core.windows.net 
          is_default: yes
          container: "cluster{{ rpfx }}"
          key: "{{ storage_output['response']['keys'][0]['value'] }}"
    compute_profile:
      roles:
        - name: headnode
          target_instance_count: 2
          hardware_profile:
            vm_size: Standard_D3
          os_profile:
            linux_operating_system_profile:
              username: sshuser
              password: MuABCPassword!!@123
        - name: workernode
          target_instance_count: 2
          hardware_profile:
            vm_size: Standard_D3
          os_profile:
            linux_operating_system_profile:
              username: sshuser
              password: MuABCPassword!!@123
  check_mode: yes
  register: output
- name: Assert the resource instance is well created
  assert:
    that:
      - output.changed

- name: Create instance of Cluster
  azure_rm_hdinsightcluster:
    resource_group: "{{ resource_group }}"
    name: "cluster{{ rpfx }}"
    location: eastus2
    cluster_version: 3.6
    os_type: linux
    tier: standard
    cluster_definition:
      kind: spark
      configurations:
        gateway:
          #restAuthCredential.isEnabled: True
          restAuthCredential.username: http-user
          restAuthCredential.password: MuABCPassword!!@123 
    storage_profile:
      storageaccounts:
        - name: storage{{ rpfx }}.blob.core.windows.net 
          is_default: yes
          container: "cluster{{ rpfx }}"
          key: "{{ storage_output['response']['keys'][0]['value'] }}"
    compute_profile:
      roles:
        - name: headnode
          target_instance_count: 2
          hardware_profile:
            vm_size: Standard_D3
          os_profile:
            linux_operating_system_profile:
              username: sshuser
              password: MuABCPassword!!@123
        - name: workernode
          target_instance_count: 2
          hardware_profile:
            vm_size: Standard_D3
          os_profile:
            linux_operating_system_profile:
              username: sshuser
              password: MuABCPassword!!@123
  register: output

- name: Assert the resource instance is well created
  assert:
    that:
      - output.changed

- name: Create again instance of Cluster
  azure_rm_hdinsightcluster:
    resource_group: "{{ resource_group }}"
    name: "cluster{{ rpfx }}"
    location: eastus2
    cluster_version: 3.6
    os_type: linux
    tier: standard
    cluster_definition:
      kind: spark
      configurations:
        gateway:
          #restAuthCredential.isEnabled: True
          restAuthCredential.username: http-user
          restAuthCredential.password: MuABCPassword!!@123 
    storage_profile:
      storageaccounts:
        - name: storage{{ rpfx }}.blob.core.windows.net 
          is_default: yes
          container: "cluster{{ rpfx }}"
          key: "{{ storage_output['response']['keys'][0]['value'] }}"
    compute_profile:
      roles:
        - name: headnode
          target_instance_count: 2
          hardware_profile:
            vm_size: Standard_D3
          os_profile:
            linux_operating_system_profile:
              username: sshuser
              password: MuABCPassword!!@123
        - name: workernode
          target_instance_count: 2
          hardware_profile:
            vm_size: Standard_D3
          os_profile:
            linux_operating_system_profile:
              username: sshuser
              password: MuABCPassword!!@123
  register: output
- name: Assert the state has not changed
  assert:
    that:
      - output.changed == false

- name: Delete instance of Cluster -- check mode
  azure_rm_hdinsightcluster:
    resource_group: "{{ resource_group }}"
    name: "cluster{{ rpfx }}"
    state: absent
  check_mode: yes
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed

- name: Delete instance of Cluster
  azure_rm_hdinsightcluster:
    resource_group: "{{ resource_group }}"
    name: "cluster{{ rpfx }}"
    state: absent
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed

- name: Delete unexisting instance of Cluster
  azure_rm_hdinsightcluster:
    resource_group: "{{ resource_group }}"
    name: "cluster{{ rpfx }}"
    state: absent
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed == false
