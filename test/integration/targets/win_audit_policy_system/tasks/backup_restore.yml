#########################
### check mode backup ###
#########################
- name: check mode backup
  win_audit_policy_system:
    backup_path: "{{ backup_path }}"
  check_mode: yes
  register: cm_backup

- name: check mode stat the backup file
  win_stat:
    path: "{{ backup_path }}"
  register: cm_path_check

- name: check mode assert that backup_taken is false
  assert:
    that:
      - cm_backup | changed
      - not cm_backup.backup_taken
      - not cm_path_check.stat.exists

##############
### backup ###
##############
- name: backup
  win_audit_policy_system:
    backup_path: "{{ backup_path }}"
  register: backup

- name: check that the backup file is present
  win_stat:
    path: "{{ backup_path }}"
  register: path_check

- name: assert that backup_taken is false
  assert:
    that:
      - backup | changed
      - backup.backup_taken
      - path_check.stat.exists

####################
### test restore ###
####################

# only validate that the command returns changed and works since we don't
# do any validation of the restore process itself.

- name: restore
  win_audit_policy_system:
    restore_path: "{{ backup_path }}"
  register: restore

- name: assert that restore worked
  assert:
    that:
      - restore | changed
