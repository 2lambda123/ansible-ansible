---
## Task file for setup/teardown AWS resources for aws_ssm integration testing
## Setup Infra in AWS
- name: Install Session Manager Plugin for Debian/Ubuntu
  include_tasks: debian.yml
  when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"
  tags: setup_infra

- name: Install Session Manager Plugin for RedHat/Amazon
  include_tasks: redhat.yml
  when: ansible_distribution == "CentOS" or ansible_distribution == "RedHat" or ansible_distribution == "Amazon"
  tags: setup_infra

- name: Install Boto3
  pip:
    name: boto3

- name: Create IAM role
  iam:
    iam_type: role
    name: "{{iam_role_name}}{{ 600 | random }}"
    state: present
  register: role_output
  tags: setup_infra

- name: Setting fact for role name
  set_fact:
     random_role_name: "{{role_output.role_result.role_name}}"
  tags: setup_infra

- name: Assign a policy called SSM and S3 to the "{{iam_role_name}}"
  iam_policy:
    iam_type: role
    iam_name: "{{random_role_name}}"
    policy_name: "{{iam_policy_name}}{{ 600 | random }}"
    policy_document:  aws_ssm_integration_test_setup_teardown/files/custom_role.json
    state: present
  register: policy_name
  tags: setup_infra

- name: Setting fact for policy name
  set_fact:
    random_policy_name: "{{policy_name.policies[0]}}"
  tags: setup_infra

- pause:
    seconds: 10
  tags: setup_infra

- name: Create Linux ec2 instance
  ec2:
    instance_type: "{{instance_type}}"
    image: "{{linux_ami_id}}"
    wait: "yes"
    count: 1
    region: "{{region_name}}"
    instance_profile_name: "{{random_role_name}}"
    instance_tags:
      name: aws_ssm_integration_test
    user_data: |
                 #!/bin/sh
                 sudo systemctl start amazon-ssm-agent
    state: present
  register: output
  tags: setup_infra and linux

- name: Create Windows ec2 instance
  ec2:
    instance_type: "{{instance_type}}"
    image: "{{windows_ami_id}}"
    wait: "yes"
    count: 1
    region: "{{region_name}}"
    instance_profile_name: "{{iam_role_name}}"
    instance_tags:
      name: aws_ssm_integration_test
    user_data: |
                <powershell>
                Restart-Service AmazonSSMAgent
                </powershell>
    state: present
  register: output
  tags: setup_infra and windows

- name: Wait for EC2 to be available
  wait_for_connection:
    delay: 30
  tags: setup_infra

- name: Setting fact for S3 bucket-name using EC2 instance-id
  set_fact:
    bucket_name: "{{output.instance_ids[0]}}"
    del_instance_id: "{{output.instance_ids[0]}}"
    del_bucket_name: "{{output.instance_ids[0]}}"
  tags: setup_infra

- name: Create var_to_delete.yml
  template:
    dest: "/tmp/vars_to_delete.yml"
    src: vars_to_delete.yml.j2
  tags: setup_infra

- name: Create hosts file
  template:
    dest: "{{playbook_dir}}/inventory.aws_ssm"
    src: inventory.aws_ssm.j2
  tags: setup_infra

- name: create bucket with instance id and rolename
  s3_bucket:
    name: "{{bucket_name}}"
  register: s3_output
  tags: setup_infra

- name: Include variable file to delete infra
  include_vars:  "/tmp/vars_to_delete.yml"
  tags: delete_infra

## Delete Infra in AWS
- name: S3 bucket Deletion
  aws_s3:
    bucket: "{{bucket_name}}"
    mode: delete
  register: s3_delete_status
  tags: delete_infra

- name: Terminate EC2 instances that were previously launched
  ec2:
    state: 'absent'
    instance_ids: "{{instance_id}}"
    region: "{{region_name}}"
  register: ec2_terminate_status
  tags: delete_infra

- name: Delete IAM policy
  iam_policy:
    iam_type: role
    iam_name: "{{role_name_random}}"
    policy_name: "{{policy_name}}"
    policy_document:  aws_ssm_integration_test_setup_teardown/files/custom_role.json
    state: absent
  tags: delete_infra
  register: iam_policy_deletion_status

- name: Delete IAM role
  iam:
    iam_type: role
    name: "{{role_name_random}}"
    state: absent
  register: iam_role_deletion_status
  tags: delete_infra
