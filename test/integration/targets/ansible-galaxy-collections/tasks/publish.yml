---
- name: fail to publish with no token
  command: ansible-galaxy collection publish ansible_test-my_collection-1.0.0.tar.gz -s {{ galaxy_server }}
  args:
    chdir: '{{ galaxy_dir }}'
  register: fail_no_token
  failed_when: '"HTTP Code: 401" not in fail_no_token.stderr'

- name: fail to publish with invalid token
  command: ansible-galaxy collection publish ansible_test-my_collection-1.0.0.tar.gz -s {{ galaxy_server }} --token fail
  args:
    chdir: '{{ galaxy_dir }}'
  register: fail_invalid_token
  failed_when: '"HTTP Code: 401" not in fail_invalid_token.stderr'

- name: publish collection
  command: ansible-galaxy collection publish ansible_test-my_collection-1.0.0.tar.gz -s {{ galaxy_server }} --token {{ galaxy_token }}
  args:
    chdir: '{{ galaxy_dir }}'
  register: publish_collection

- name: get result of publish collection
  uri:
    url: '{{ galaxy_server }}v2/collections/ansible_test/my_collection/versions/1.0.0/'
    return_content: yes
  register: publish_collection_actual

- name: assert publish collection
  assert:
    that:
    - '"Collection has been successfully published and imported to the Galaxy server" in publish_collection.stdout'
    - publish_collection_actual.json.metadata.name == 'my_collection'
    - publish_collection_actual.json.metadata.namespace == 'ansible_test'
    - publish_collection_actual.json.metadata.version == '1.0.0'

#- name: fail to publish existing collection version
#  command: ansible-galaxy collection publish ansible_test-my_collection-1.0.0.tar.gz -s {{ galaxy_server }} --token {{ galaxy_token }}
#  args:
#    chdir: '{{ galaxy_dir }}'
#  register: fail_publish_existing
