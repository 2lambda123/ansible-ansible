- name: Build collection
  command: ansible-galaxy collection build --output-path {{ output_dir|quote }} -vvv
  args:
    chdir: '{{ role_path }}/files/test_manifest_collection'

- name: Get artifact contents
  command: tar tzf '{{ output_dir }}/ns-col-1.0.0.tar.gz'
  register: artifact_contents

- debug:
    var: artifact_contents.stdout_lines|sort

- debug:
    var: lookup('file', 'expected.txt').splitlines()|sort

- assert:
    that:
      - artifact_contents.stdout_lines|sort == lookup('file', 'expected.txt').splitlines()|sort

- name: Create dir
  file:
    path: '{{ output_dir }}/test_manifest_full_collection'
    state: directory

- name: Copy test collection
  copy:
    src: '{{ role_path }}/files/test_manifest_collection/'
    dest: '{{ output_dir }}/test_manifest_full_collection/'

- name: Copy galaxy.yml with manifest_directives_full
  copy:
    src: full_manifest_galaxy.yml
    dest: '{{ output_dir }}/test_manifest_full_collection/galaxy.yml'

- name: Build collection
  command: ansible-galaxy collection build --output-path {{ output_dir|quote }} -vvv
  args:
    chdir: '{{ output_dir }}/test_manifest_full_collection'

- name: Get artifact contents
  command: tar tzf '{{ output_dir }}/ns-col-2.0.0.tar.gz'
  register: artifact_contents

- debug:
    var: artifact_contents.stdout_lines|sort

- debug:
    var: lookup('file', 'expected_full_manifest.txt').splitlines()|sort

- assert:
    that:
      - artifact_contents.stdout_lines|sort == lookup('file', 'expected_full_manifest.txt').splitlines()|sort
