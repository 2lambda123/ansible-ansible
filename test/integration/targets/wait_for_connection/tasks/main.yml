- name: Test normal connection to target node
  wait_for_connection:
    connect_timeout: 5
    sleep: 1
    timeout: 10

- name: Test normal connection to target node with delay
  wait_for_connection:
    connect_timeout: 5
    sleep: 1
    timeout: 10
    delay: 3
  register: result

- name: Verify delay was honored
  assert:
    that:
      - result.elapsed >= 3

- name: Use invalid parameter
  wait_for_connection:
    foo: bar
  ignore_errors: yes
  register: invalid_parameter

- name: Ensure task fails with error
  assert:
    that:
    - invalid_parameter is failed
    - "invalid_parameter.msg == 'Invalid options for wait_for_connection: foo'"


- name: Test timeout with unreachable host
  wait_for_connection:
    timeout: 3
    connect_timeout: 1
  register: timeout_unreachable
  delegate_to: 198.51.100.2  # address is in TEST-NET-2 (RFC-5737), which should not have hosts in it
  ignore_errors: true

- name: Verify timeout honoured
  assert:
    that:
      - timeout_unreachable.elapsed < 4
