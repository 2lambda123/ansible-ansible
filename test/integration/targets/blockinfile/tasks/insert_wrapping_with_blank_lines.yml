- name: Create insert_wrapping_with_blank_lines test file
  copy:
    dest: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
    content: |
      line1
      line2
      line3

- name: add content to file with blank lines wrapping
  blockinfile:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
    wrap_with_blank_lines: true
    insertafter: "line1"
    block: |
      line1.5
  register: insert_wrapped_by_blank_lines

- name: add content to file with blank lines wrapping (again)
  blockinfile:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
    wrap_with_blank_lines: true
    insertafter: "line1"
    block: |
      line1.5
  register: insert_wrapped_by_blank_lines_again

- name: get file content after adding content with blank lines
  stat:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
  register: wrapped_by_blank_lines

- name: check content is the expected one after inserting with blank lines wrapping
  assert:
    that:
      - insert_wrapped_by_blank_lines is changed
      - insert_wrapped_by_blank_lines_again is not changed
      - wrapped_by_blank_lines.stat.checksum == "043193159b0f2821bd0ca48322721f49f45ff24a"

- name: add content to file without blank lines wrapping
  blockinfile:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
    wrap_with_blank_lines: false
    marker: "{mark} UNWRAPPED TEXT"
    insertafter: "line3"
    block: |
      line3.5
  register: insert_unwrapped_by_blank_lines

- name: get file content after adding content without blank lines
  stat:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
  register: unwrapped_by_blank_lines

- name: check content is the expected one after inserting without blank lines wrapping
  assert:
    that:
      - insert_unwrapped_by_blank_lines is changed
      - unwrapped_by_blank_lines.stat.checksum == "2eb09ca625bfa4a05859b7cb8708069cbdaf0110"

- name: add blank line wrapping to existing block
  blockinfile:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
    wrap_with_blank_lines: true
    marker: "{mark} UNWRAPPED TEXT"
    insertafter: "line3"
    block: |
      line3.5
  register: add_blank_lines_wrapping_to_existing_block


- name: get file content after wrapping existing block with blank lines
  stat:
    path: "{{ remote_tmp_dir_test }}/wrap_blank_lines.txt"
  register: blank_lines_wrap_added

- name: check content is the expected one after wrapping existing block with blank lines
  assert:
    that:
      - add_blank_lines_wrapping_to_existing_block is changed
      - blank_lines_wrap_added.stat.checksum == "6548c6c54a8b63671a09ac1cbd8f0c93ca3a58a6"