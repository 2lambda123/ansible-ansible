################################
### check mode remove a rule ###
################################
- name: check mode remove directory rule
  win_audit_rule:
    path: "{{ test_audit_rule_folder }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: cm_rm_directory
  check_mode: yes

- name: check mode remove file rule
  win_audit_rule:
    path: "{{ test_audit_rule_file }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: cm_rm_file
  check_mode: yes

- name: check mode remove registry rule
  win_audit_rule:
    path: "{{ test_audit_rule_registry }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: cm_rm_registry
  check_mode: yes

- name: check mode remove get directory rule results
  test_get_audit_rule:
    path: "{{ test_audit_rule_folder }}"
    user: "{{ test_audit_rule_user }}"
    rights: "{{ test_audit_rule_new_rights }}"
    audit_flags: "{{ test_audit_rule_audit_flags }}"
  register: cm_rm_directory_results

- name: check mode remove get file rule results
  test_get_audit_rule:
    path: "{{ test_audit_rule_file }}"
    user: "{{ test_audit_rule_user }}"
    rights: "{{ test_audit_rule_new_rights }}"
    audit_flags: "{{ test_audit_rule_audit_flags }}"
    inheritance_flags: none
  register: cm_rm_file_results

- name: check mode remove get REGISTRY rule results
  test_get_audit_rule:
    path: "{{ test_audit_rule_registry }}"
    user: "{{ test_audit_rule_user }}"
    rights: "{{ test_audit_rule_new_rights }}"
    audit_flags: "{{ test_audit_rule_audit_flags }}"
  register: cm_rm_registry_results

- name: check mode remove assert that change detected, but rule is still present
  assert:
    that:
    - cm_rm_directory | changed
    - cm_rm_file | changed
    - cm_rm_registry | changed
    - cm_rm_directory_results.matching_rule_found and cm_rm_directory_results.target_type == 'directory'
    - cm_rm_file_results.matching_rule_found and cm_rm_file_results.target_type == 'file'
    - cm_rm_registry_results.matching_rule_found and cm_rm_registry_results.target_type == 'registry'

#####################
### remove a rule ###
#####################
- name: remove directory rule
  win_audit_rule:
    path: "{{ test_audit_rule_folder }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: rm_directory

- name: remove file rule
  win_audit_rule:
    path: "{{ test_audit_rule_file }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: rm_file

- name: remove registry rule
  win_audit_rule:
    path: "{{ test_audit_rule_registry }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: rm_registry

- name: remove get directory rule results
  test_get_audit_rule:
    path: "{{ test_audit_rule_folder }}"
    user: "{{ test_audit_rule_user }}"
    rights: "{{ test_audit_rule_new_rights }}"
    audit_flags: "{{ test_audit_rule_audit_flags }}"
  register: rm_directory_results

- name: remove get file rule results
  test_get_audit_rule:
    path: "{{ test_audit_rule_file }}"
    user: "{{ test_audit_rule_user }}"
    rights: "{{ test_audit_rule_new_rights }}"
    audit_flags: "{{ test_audit_rule_audit_flags }}"
    inheritance_flags: none
  register: rm_file_results

- name: remove get REGISTRY rule results
  test_get_audit_rule:
    path: "{{ test_audit_rule_registry }}"
    user: "{{ test_audit_rule_user }}"
    rights: "{{ test_audit_rule_new_rights }}"
    audit_flags: "{{ test_audit_rule_audit_flags }}"
  register: rm_registry_results

- name: remove assert that change detected and rule is gone
  assert:
    that:
    - rm_directory | changed
    - rm_file | changed
    - rm_registry | changed
    - not rm_directory_results.matching_rule_found and rm_directory_results.target_type == 'directory'
    - not rm_file_results.matching_rule_found and rm_file_results.target_type == 'file'
    - not rm_registry_results.matching_rule_found and rm_registry_results.target_type == 'registry'

################################
### idempotent remove a rule ###
################################
- name: idempotent remove directory rule
  win_audit_rule:
    path: "{{ test_audit_rule_folder }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: idem_rm_directory

- name: idempotent remove file rule
  win_audit_rule:
    path: "{{ test_audit_rule_file }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: idem_rm_file

- name: idempotent remove registry rule
  win_audit_rule:
    path: "{{ test_audit_rule_registry }}"
    user: "{{ test_audit_rule_user }}"
    state: absent
  register: idem_rm_registry

- name: idempotent remove assert that no change detected
  assert:
    that:
    - not idem_rm_file | changed and idem_rm_file.target_type == 'directory'
    - not idem_rm_directory | changed and idem_rm_directory.target_type == 'file'
    - not idem_rm_registry | changed and idem_rm_registry.target_type == 'registry'
