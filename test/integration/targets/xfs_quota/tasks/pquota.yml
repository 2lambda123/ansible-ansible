---
- name: 'Create disk image'
  command: >
    dd if=/dev/zero of={{ ansible_user_dir }}/ansible_testing/img-pquota bs=1M count=20

- name: 'Create XFS filesystem'
  filesystem:
    dev: '{{ ansible_user_dir }}/ansible_testing/img-pquota'
    fstype: xfs

- name: Create xfs related files
  file:
    path:  '/etc/{{ item }}'
    state: touch
  become: True
  loop:
    - 'projid'
    - 'projects'

- name: 'Add test xfs quota project id'
  lineinfile:
    path: /etc/projid
    line: 'xft_quotaval:99999'
    state: present
  become: True

- name: 'Add test xfs quota project path'
  lineinfile:
    path: /etc/projects
    line: '99999:{{ ansible_user_dir }}/ansible_testing/pquota/test'
    state: present
  become: True

- block:
    - name: 'Mount filesystem'
      mount:
        fstab: '{{ ansible_user_dir }}/ansible_testing/fstab'
        src: '{{ ansible_user_dir }}/ansible_testing/img-pquota'
        path: '{{ ansible_user_dir }}/ansible_testing/pquota'
        fstype: xfs
        opts: pquota
        state: mounted
      become: True

    - name: 'Create test directory'
      file:
        path: '{{ ansible_user_dir }}/ansible_testing/pquota/test'
        state: directory
      become: True


    - name: 'Apply default project limits'
      xfs_quota:
        bsoft: '{{ pquota_default_bsoft }}'
        bhard: '{{ pquota_default_bhard }}'
        isoft: '{{ pquota_default_isoft }}'
        ihard: '{{ pquota_default_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/pquota'
        rtbsoft: '{{ pquota_default_rtbsoft }}'
        rtbhard: '{{ pquota_default_rthard }}'
        type: project 
      become: True
      register: test_pquota_default_bsoft_before

    - name: 'Apply project limits'
      xfs_quota:
        bsoft: '{{ pquota_project_bsoft }}'
        bhard: '{{ pquota_project_bhard }}'
        isoft: '{{ pquota_project_isoft }}'
        ihard: '{{ pquota_project_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/pquota'
        name: xft_quotaval
        rtbsoft: '{{ pquota_project_rtbsoft }}'
        rtbhard: '{{ pquota_project_rthard }}'
        type: project 
      become: True
      register: test_pquota_project_bsoft_before

    - name: 'Re-apply default project limits'
      xfs_quota:
        bsoft: '{{ pquota_default_bsoft }}'
        bhard: '{{ pquota_default_bhard }}'
        isoft: '{{ pquota_default_isoft }}'
        ihard: '{{ pquota_default_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/pquota'
        rtbsoft: '{{ pquota_default_rtbsoft }}'
        rtbhard: '{{ pquota_default_rthard }}'
        type: project
      become: True
      register: test_pquota_default_bsoft_after

    - name: 'Re-apply project limits'
      xfs_quota:
        bsoft: '{{ pquota_project_bsoft }}'
        bhard: '{{ pquota_project_bhard }}'
        isoft: '{{ pquota_project_isoft }}'
        ihard: '{{ pquota_project_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/pquota'
        name: xft_quotaval
        rtbsoft: '{{ pquota_project_rtbsoft }}'
        rtbhard: '{{ pquota_project_rthard }}'
        type: project
      become: True
      register: test_pquota_project_bsoft_after

    - name: 'Evaluate Project quotas'
      assert:
        that:
          - not test_pquota_default_bsoft_after.changed
          - test_pquota_default_bsoft_after.xfs_quota.bsoft == pquota_default_bsoft|human_to_bytes
          - test_pquota_default_bsoft_after.xfs_quota.bhard == pquota_default_bhard|human_to_bytes
          - test_pquota_default_bsoft_after.xfs_quota.isoft == pquota_default_isoft|human_to_bytes
          - test_pquota_default_bsoft_after.xfs_quota.ihard == pquota_default_ihard|human_to_bytes
          - test_pquota_default_bsoft_after.xfs_quota.rtbsoft == pquota_default_rtbsoft|human_to_bytes
          - test_pquota_default_bsoft_after.xfs_quota.rtbhard == pquota_default_rthard|human_to_bytes
          - not test_pquota_project_bsoft_after.changed
          - test_pquota_project_bsoft_after.xfs_quota.bsoft == pquota_project_bsoft|human_to_bytes
          - test_pquota_project_bsoft_after.xfs_quota.bhard == pquota_project_bhard|human_to_bytes
          - test_pquota_project_bsoft_after.xfs_quota.isoft == pquota_project_isoft|human_to_bytes
          - test_pquota_project_bsoft_after.xfs_quota.ihard == pquota_project_ihard|human_to_bytes
          - test_pquota_project_bsoft_after.xfs_quota.rtbsoft == pquota_project_rtbsoft|human_to_bytes
          - test_pquota_project_bsoft_after.xfs_quota.rtbhard == pquota_project_rthard|human_to_bytes

  always:
    - name: 'Unmount filesystem'
      mount:
        fstab: '{{ ansible_user_dir }}/ansible_testing/fstab'
        path: '{{ ansible_user_dir }}/ansible_testing/pquota'
        state: unmounted
      become: True

    - name: Remove disk image
      file:
        path: '{{ ansible_user_dir }}/ansible_testing/img-pquota'
        state: absent

    - name: Remove xfs quota project id
      lineinfile:
        path: /etc/projid
        regexp: '^xft_quotaval:99999$'
        state: absent
      become: True

    - name: Remove xfs quota project path
      lineinfile:
        path: /etc/projects
        regexp: '^99999:.*$'
        state: absent
      become: True
