
- name: 'Create disk image'
  command: >
    dd if=/dev/zero of={{ ansible_user_dir }}/ansible_testing/img-gquota bs=1M count=20

- name: 'Create XFS filesystem'
  filesystem:
    dev: '{{ ansible_user_dir }}/ansible_testing/img-gquota'
    fstype: xfs

- block:
    - name: 'Mount filesystem'
      mount:
        fstab: '{{ ansible_user_dir }}/ansible_testing/fstab'
        src: '{{ ansible_user_dir }}/ansible_testing/img-gquota'
        path: '{{ ansible_user_dir }}/ansible_testing/gquota'
        fstype: xfs
        opts: gquota
        state: mounted
      become: True

#    - include_tasks: gquota-default.yml
#    - include_tasks: gquota-group.yml

    - name: 'Apply default group limits'
      xfs_quota:
        bsoft: '{{ gquota_default_bsoft }}'
        bhard: '{{ gquota_default_bhard }}'
        isoft: '{{ gquota_default_isoft }}'
        ihard: '{{ gquota_default_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/gquota'
        rtbsoft: '{{ gquota_default_rtbsoft }}'
        rtbhard: '{{ gquota_default_rthard }}'
        type: group
      become: True
      register: test_gquota_default_bsoft_before

    - name: 'Apply group limits'
      xfs_quota:
        bsoft: '{{ gquota_group_bsoft }}'
        bhard: '{{ gquota_group_bhard }}'
        isoft: '{{ gquota_group_isoft }}'
        ihard: '{{ gquota_group_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/gquota'
        name: xfsquotauser
        rtbsoft: '{{ gquota_group_rtbsoft }}'
        rtbhard: '{{ gquota_group_rthard }}'
        type: group
      become: True
      register: test_gquota_group_bsoft_before

    - name: 'Re-apply default group limits'
      xfs_quota:
        bsoft: '{{ gquota_default_bsoft }}'
        bhard: '{{ gquota_default_bhard }}'
        isoft: '{{ gquota_default_isoft }}'
        ihard: '{{ gquota_default_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/gquota'
        rtbsoft: '{{ gquota_default_rtbsoft }}'
        rtbhard: '{{ gquota_default_rthard }}'
        type: group
      become: True
      register: test_gquota_default_bsoft_after

    - name: 'Re-apply group limits'
      xfs_quota:
        bsoft: '{{ gquota_group_bsoft }}'
        bhard: '{{ gquota_group_bhard }}'
        isoft: '{{ gquota_group_isoft }}'
        ihard: '{{ gquota_group_ihard }}'
        mountpoint: '{{ ansible_user_dir }}/ansible_testing/gquota'
        name: xfsquotauser
        rtbsoft: '{{ gquota_group_rtbsoft }}'
        rtbhard: '{{ gquota_group_rthard }}'
        type: group
      become: True
      register: test_gquota_group_bsoft_after

    - name: 'Evaluate group quotas'
      assert:
        that:
          - not test_gquota_default_bsoft_after.changed
          - test_gquota_default_bsoft_after.xfs_quota.bsoft == gquota_default_bsoft|human_to_bytes
          - test_gquota_default_bsoft_after.xfs_quota.bhard == gquota_default_bhard|human_to_bytes
          - test_gquota_default_bsoft_after.xfs_quota.isoft == gquota_default_isoft|human_to_bytes
          - test_gquota_default_bsoft_after.xfs_quota.ihard == gquota_default_ihard|human_to_bytes
          - test_gquota_default_bsoft_after.xfs_quota.rtbsoft == gquota_default_rtbsoft|human_to_bytes
          - test_gquota_default_bsoft_after.xfs_quota.rtbhard == gquota_default_rthard|human_to_bytes
          - not test_gquota_group_bsoft_after.changed
          - test_gquota_group_bsoft_after.xfs_quota.bsoft == gquota_group_bsoft|human_to_bytes
          - test_gquota_group_bsoft_after.xfs_quota.bhard == gquota_group_bhard|human_to_bytes
          - test_gquota_group_bsoft_after.xfs_quota.isoft == gquota_group_isoft|human_to_bytes
          - test_gquota_group_bsoft_after.xfs_quota.ihard == gquota_group_ihard|human_to_bytes
          - test_gquota_group_bsoft_after.xfs_quota.rtbsoft == gquota_group_rtbsoft|human_to_bytes
          - test_gquota_group_bsoft_after.xfs_quota.rtbhard == gquota_group_rthard|human_to_bytes




  always:
    - name: 'Unmount filesystem'
      mount:
        fstab: '{{ ansible_user_dir }}/ansible_testing/fstab'
        path: '{{ ansible_user_dir }}/ansible_testing/gquota'
        state: unmounted
      become: True

    - name: Remove disk image
      file:
        path: '{{ ansible_user_dir }}/ansible_testing/img-gquota'
        state: absent


