# Clean up before running tests
- name: Remove any previous Nodejs modules
  file:
    path: '{{output_dir}}/node_modules'
    state: absent

# Set vars for our test harness
- vars:
    node_path: '{{ output_dir }}/{{nodejs_path}}/bin'
    yarn_bin_path: '{{ output_dir }}/yarn-v{{yarn_version}}_pkg.tar.gz/bin'
    package: 'iconv-lite'
  block:
    # Get the version of Yarn and register to a variable
    - shell: '{{ output_dir }}/yarn-v{{yarn_version}}_pkg.tar.gz/bin/yarn' --version
      environment:
        - PATH: '{{yarn_bin_path}}:{{node_path}}:{{ansible_env.PATH}}'
      register: yarn_version

  - debug:
      var: yarn_version.stdout

  - name: 'Install a simple package.'
    yarn:
      path: '{{ output_dir }}'
      executable: '{{ yarn_bin_path }}/yarn'
      name: '{{ package }}'
      state: present
    environment:
      - PATH: '{{yarn_bin_path}}:{{node_path}}:{{ansible_env.PATH}}'
    register: yarn_install

  - assert:
      that:
        - yarn_install is success
        - yarn_install is changed

  - name: 'Assert idempotency when installing the same package again.'
    yarn:
      path: '{{ output_dir }}'
      executable: '{{ yarn_bin_path }}/yarn'
      name: '{{ package }}'
      state: present
    environment:
      - PATH: '{{yarn_bin_path}}:{{node_path}}:{{ansible_env.PATH}}'
    register: yarn_reinstall

  - name: 'Assert no change after reinstalling the same package'
    assert:
      that:
        - yarn_reinstall is success
        - not (yarn_resintall is changed)

  - name: 'Remove a package'
    yarn:
      path: '{{ output_dir }}'
      executable: '{{ yarn_bin_path }}/yarn'
      name: '{{ package }}'
      state: absent
    environment:
      - PATH: '{{yarn_bin_path}}:{{node_path}}:{{ansible_env.PATH}}'
    register: yarn_uninstall_package

  - name: 'Assert package removed'
    assert:
      that:
        - yarn_uninstall_package is success
        - yarn_uninstall_package is changed