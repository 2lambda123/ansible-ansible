- name: Include system specific variables
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - "{{ ansible_facts.system }}.yml"
        - default.yml
      paths:
        - "{{ role_path }}/vars"

- name: Work-around for locked users on Alpine
  # see https://github.com/ansible/ansible/issues/68676
  set_fact:
    password: '*'
  when: ansible_distribution == 'Alpine'

- name: Create test user
  user:
    name: fetcher
    create_home: yes
    group: "{{ _fetch_group | default(omit) }}"
    groups: "{{ _fetch_additional_groups | default(omit) }}"
    append: "{{ True if _fetch_additional_groups else False }}"
    password: "{{ password | default(omit) }}"
  become: yes
  notify:
    - remove test user

- name: Create a file that we can use to fetch
  copy:
    content: "test"
    dest: "{{ remote_tmp_dir }}/orig"

- name: Create symlink to a file that we can fetch
  file:
    path: "{{ remote_tmp_dir }}/link"
    src: "{{ remote_tmp_dir }}/orig"
    state: "link"

- name: Create an inaccessible directory
  file:
    path: "{{ remote_tmp_dir }}/noaccess"
    state: directory
    mode: '0600'
    owner: root
  become: yes

- name: Create local encrypted file for comparison
  copy:
    decrypt: No
    content: |
      $ANSIBLE_VAULT;1.2;AES256;vault1
      31313538313965306339376134316466333462613034376263643035326338323961303466316434
      3738376564383234623363323463646436653962613463370a653136346538653962396433653139
      64633565623463633066346330306264626637383763633436316631393361333764393663343065
      3761666335336531380a353766633131626538346638663466396161666464306463336536663161
      6666
    dest: "{{ output_dir }}/orig_enc"
