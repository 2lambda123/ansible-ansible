- hosts: testhost
  gather_facts: no

  tasks:
    - import_role:
        name: fetch_tests
        tasks_from: setup.yml
      vars:
        skip_cleanup: yes

    - name: Remove /run/nologin
      file:
        path: /run/nologin
        state: absent

    - name: Get home directory for temporary user
      command: echo ~fetcher
      register: fetcher_home

    - name: Create .ssh dir
      file:
        path: "{{ fetcher_home.stdout }}/.ssh"
        state: directory
        owner: fetcher
        mode: '0700'

    - name: Configure authorized_keys
      copy:
        src: "~root/.ssh/authorized_keys"
        dest: "{{ fetcher_home.stdout }}/.ssh/authorized_keys"
        owner: fetcher
        mode: '0600'

    - copy:
        content: "{{ remote_tmp_dir }}"
        dest: "{{ playbook_dir }}/remote_tmp_dir.txt"
      delegate_to: localhost
