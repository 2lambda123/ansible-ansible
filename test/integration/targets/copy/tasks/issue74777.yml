- name: Create test dir
  file:
    path: "{{ output_dir }}/src"
    state: directory

- name: Create test dir dest
  file:
    path: "{{ output_dir }}/dest"
    state: directory

- name: Create a file to symlink to
  file:
    path: "{{ output_dir }}/src/issue74777.txt"
    state: touch

- name: Create a symbolic link to the file in the src dir
  file:
    src: "{{ output_dir }}/src/issue74777.txt"
    dest: "{{ output_dir }}/src/symlink"
    state: link

- name: stat the original link
  stat:
      path: "{{ output_dir }}/src/symlink"
  register: orig_st

- debug: var=orig_st

- name: Try to copy the symlink to dest dir as a symlink
  copy:
    remote_src: true
    local_follow: false
    mode: preserve
    owner: "{{ remote_unprivileged_user }}"
    src: "{{ output_dir }}/src/symlink"
    dest: "{{ output_dir }}/dest/symlink"
  register: copy_result

- debug: var=copy_result

- name: get stat info
  stat:
    path: "{{ output_dir }}/dest/symlink"
  register: new_st

- debug: var=new_st

- name: assert that we have a link with proper owner/perms/etc
  assert:
    that:
        - copy_result.changed
        - new_st.stat.islnk is defined and new_st.stat.islnk
        - new_st.stat.pw_name == remote_unprivileged_user
        - new_st.stat.mode == orig_st.stat.mode
        - new_st.stat.lnk_source == orig_st.stat.lnk_source
