# Copyright: (c) 2019 Gregory Thiemonge <gregory.thiemonge@gmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: test update or add another dns record in check mode
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    values: "{{ item.update_values | default(item['values']) }}"
    ttl: "{{ item.update_ttl | default(omit) }}"
    type: "{{ item.type | default(omit) }}"
  check_mode: yes
  register: result
- name: verify test update in check mode
  assert:
    that:
    - result is changed
    - result.record['values'] == {{ item['values'] }}
    - result.record.name == "{{ item.name | default("") }}"
    - result.record.type == "{{ item.type | default('@') }}"
    - result.record.ttl == {{ item.ttl | default(10800) }}

- name: test update or add another dns record
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    values: "{{ item.update_values | default(item['values']) }}"
    ttl: "{{ item.update_ttl | default(omit) }}"
    type: "{{ item.type | default(omit) }}"
  register: result
- name: verify test update a dns record
  assert:
    that:
    - result is changed
    - result.record['values'] == {{ item.update_values | default(item['values']) }}
    - result.record.name == "{{ item.name | default("") }}"
    - result.record.ttl == {{ item.update_ttl | default(10800) }}
    - result.record.type == "{{ item.type | default('@') }}"

- name: test update or add another dns record idempotence
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    values: "{{ item.update_values | default(item['values']) }}"
    ttl: "{{ item.update_ttl | default(omit) }}"
    type: "{{ item.type | default(omit) }}"
  register: result
- name: verify test update a dns record idempotence
  assert:
    that:
    - result is not changed
    - result.record['values'] == {{ item.update_values | default(item['values']) }}
    - result.record.name == "{{ item.name | default("") }}"
    - result.record.ttl == {{ item.update_ttl | default(10800) }}
    - result.record.type == "{{ item.type | default('@') }}"
