# Copyright: (c) 2019 Gregory Thiemonge <gregory.thiemonge@gmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: test setup dns record
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    type: "{{ item.type | default(omit) }}"
    state: absent
  register: result
- name: verify test setup dns record
  assert:
    that:
    - result is successful

- name: test create a dns record in check mode
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    values: "{{ item['values'] }}"
    ttl: "{{ item.ttl | default(omit) }}"
    type: "{{ item.type | default(omit) }}"
  check_mode: yes
  register: result
- name: verify test create a dns record in check mode
  assert:
    that:
    - result is changed

- name: test create a dns record
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    values: "{{ item['values'] }}"
    ttl: "{{ item.ttl | default(omit) }}"
    type: "{{ item.type | default(omit) }}"
  register: result
- name: verify test create a dns record
  assert:
    that:
    - result is changed
    - result.record['values'] == {{ item['values'] }}
    - result.record.name == "{{ item.name | default("@") }}"
    - result.record.type == "{{ item.type }}"
    - result.record.ttl == {{ item.ttl | default(10800) }}

- name: test create a dns record idempotence
  gandi_livedns:
    api_key: "{{ gandi_api_key }}"
    name: "{{ item.name | default(omit) }}"
    domain: "{{ gandi_livedns_domain_name }}"
    values: "{{ item['values'] }}"
    ttl: "{{ item.ttl | default(omit) }}"
    type: "{{ item.type | default(omit) }}"
  register: result
- name: verify test create a dns record idempotence
  assert:
    that:
    - result is not changed
    - result.record['values'] == {{ item['values'] }}
    - result.record.name == "{{ item.name | default("@") }}"
    - result.record.type == "{{ item.type }}"
    - result.record.ttl == {{ item.ttl | default(10800) }}
