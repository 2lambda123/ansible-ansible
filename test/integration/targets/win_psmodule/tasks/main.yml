# This file is part of Ansible

# test code for the win_psmodule module when using winrm connection
# Copyright: (c) 2018, Wojciech Sciesinski <wojciech[at]sciesinski[dot]net>
# Copyright: (c) 2017, Daniele Lazzari <lazzari@mailup.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: get PowerShell version
  win_shell: '$PSVersionTable.PSVersion.Major'
  register: powershell_major_version

- name: Perform integration tests for Powershell 5+
  when: powershell_major_version.stdout | int >= 5
  block:

    - name: update NuGet version
      win_shell: |
        $nuget_exists = (Get-PackageProvider | Where-Object { $_.Name -eq 'Nuget' } | Measure-Object).Count -eq 1

        if ( $nuget_exists ) {
          $nuget_outdated = (Get-PackageProvider -Name NuGet -ErrorAction Ignore).Version -lt [Version]"2.8.5.201"
        }

        if ( -not $nuget_exists -or $nuget_outdated ) {
          Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
        }

    - name: uninstall any versions of module used for tests
      win_shell: 'Uninstall-Module {{ item }} -AllVersions -Force -ErrorAction Ignore'
      changed_when: false
      with_items:
        - "powershell-yaml"
        - "Pester"
        - "PowerShellCookbook"
        - "Format-Pester"

    - name: unregister custom repo
      win_shell: 'Unregister-PSRepository {{ custom_repo_name }} -ErrorAction Ignore'

    - name: run all tests
      include: tests.yml
      vars:
        in_check_mode: no

    - name: uninstall any versions of module used for tests
      win_shell: 'Uninstall-Module {{ item }} -AllVersions -Force -ErrorAction Ignore'
      changed_when: false
      with_items:
        - "Pester"
        - "powershell-yaml"
        - "PowerShellCookbook"
        - "Format-Pester"

    - name: unregister custom repo
      win_shell: 'Unregister-PSRepository {{ custom_repo_name }} -ErrorAction Ignore'

    - name: run all tests
      include: tests.yml
      vars:
        in_check_mode: yes
