- name: test with_first_found
  set_fact: "first_found={{ item }}"
  with_first_found:
    - "{{ role_path + '/files/does_not_exist' }}"
    - "{{ role_path + '/files/foo1' }}"
    - "{{ role_path + '/files/bar1' }}"

- name: set expected
  set_fact: first_expected="{{ role_path + '/files/foo1' }}"

- name: set unexpected
  set_fact: first_unexpected="{{ role_path + '/files/bar1' }}"

- name: verify with_first_found results
  assert:
    that:
      - "first_found == first_expected"
      - "first_found != first_unexpected"

- name: test q(first_found) with no files produces empty list
  set_fact:
    first_found_var: "{{ q('first_found', params, errors='ignore') }}"
  vars:
    params:
      files: "not_a_file.yaml"

- name: verify q(first_found) result
  assert:
    that:
      - "first_found_var == []"

- name: test lookup(first_found) with no files produces empty string
  set_fact:
    first_found_var: "{{ lookup('first_found', params, errors='ignore') }}"
  vars:
    params:
      files: "not_a_file.yaml"

- name: verify lookup(first_found) result
  assert:
    that:
      - "first_found_var == ''"

# NOTE: skip: True deprecated e17a2b502d6601be53c60d7ba1c627df419460c9, remove 2.12
- name: test first_found with no matches and skip=True does nothing
  set_fact: "this_not_set={{ item }}"
  vars:
    params:
      files:
        - not/a/file.yaml
        - another/non/file.yaml
      skip: True
  loop: "{{ q('first_found', params) }}"

- name: verify skip
  assert:
    that:
      - "this_not_set is not defined"

- name: test first_found with no matches and errors='ignore' skips in a loop
  set_fact: "this_not_set={{ item }}"
  vars:
    params:
      files:
        - not/a/file.yaml
        - another/non/file.yaml
  loop: "{{ query('first_found', params, errors='ignore') }}"

- name: verify errors=ignore
  assert:
    that:
      - "this_not_set is not defined"

- name: test first_found with paths in a loop
  set_fact: "file={{ item }}"
  vars:
    params:
      files:
        - not/a/file.yaml
        - another/non/file.yaml
        - foo1
      paths:
        - "{{ role_path + '/not-real-dir/' }}"
        - "{{ role_path + '/files/' }}"
  loop: "{{ query('first_found', params) }}"

- name: verify errors=ignore
  assert:
    that:
      - "file == role_path + '/files/foo1'"

# https://github.com/ansible/ansible/issues/70772
- name: test first_found with files with empty variables works (dict)
  set_fact:
    file_found_dict_var: "{{ item }}"
  with_first_found:
    - files:
        - "{{ this_var_is_empty }}"
        - "{{ role_path + '/files/foo1' }}"
  vars:
    this_var_is_empty: null

- name: verify task does work
  assert:
    that:
      - "file_found_dict_var == first_expected"

- name: test first_found with files with empty variable works (list)
  set_fact:
    file_found_list_var: "{{ item }}"
  with_first_found:
    - "{{ this_var_is_empty }}"
    - "{{ role_path + '/files/foo1' }}"
  vars:
    this_var_is_empty: null

- name: verify task does work
  assert:
    that:
      - "file_found_list_var == first_expected"

- name: test first_found with files with non-existing variables works (dict)
  set_fact:
    file_found_dict_var: "{{ item }}"
  with_first_found:
    - files:
        - "{{ this_var_does_not_exist }}"
        - "{{ role_path + '/files/foo1' }}"

- name: verify task does work
  assert:
    that:
      - "file_found_dict_var == first_expected"

- name: test first_found with files with non-existing key works (list)
  set_fact:
    file_found_list_var: "{{ item }}"
  with_first_found:
    - "{{ this_var_is_empty.key_does_not_exist }}"
    - "{{ role_path + '/files/foo1' }}"

- name: verify task does work
  assert:
    that:
      - "file_found_list_var == first_expected"

- name: test first_found with files with non-existing variables works (dict)
  set_fact:
    file_found_dict_var: "{{ item }}"
  with_first_found:
    - files:
        - "{{ this_var_is_empty.key_does_not_exist }}"
        - "{{ role_path + '/files/foo1' }}"
  vars:
    this_var_is_empty: null

- name: verify task does work
  assert:
    that:
      - "file_found_dict_var == first_expected"

- name: test first_found with files with non-existint key works (list)
  set_fact:
    file_found_list_var: "{{ item }}"
  with_first_found:
    - "{{ this_var_is_empty.key_does_not_exist }}"
    - "{{ role_path + '/files/foo1' }}"
  vars:
    this_var_is_empty: null

- name: verify task does work
  assert:
    that:
      - "file_found_list_var == first_expected"
