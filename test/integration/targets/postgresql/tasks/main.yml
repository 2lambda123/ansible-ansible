# Unsorted tests that were moved from here to unsorted.yml
- import_tasks: unsorted.yml

# Test ssl.
# Restricted using Debian family because of there are errors on other distributions
# that not related with PostgreSQL or psycopg2 SSL support.
# The tests' key point is to be sure that ssl options work in general
- import_tasks: ssl.yml
  when:
  - ansible_os_family == 'Debian'
  - postgres_version_resp.stdout is version('9.4', '>=')

# Test postgresql_publication
- import_tasks: postgresql_publication.yml
  when: postgres_version_resp.stdout is version('10', '>=')

- include_tasks: '{{ loop_item }}'
  loop:
  # Test postgresql_set
  - postgresql_set.yml

  # Test postgresql_copy module
  - postgresql_copy.yml

  # Test postgresql_slot module.
  # Physical replication slots are available from PostgreSQL 9.4
  - postgresql_slot.yml
  loop_control:
    loop_var: loop_item
  when: postgres_version_resp.stdout is version('9.4', '>=')

- include_tasks: '{{ loop_item }}'
  loop:
  # Test postgresql_user module
  - postgresql_user.yml

  # Verify different session_role scenarios
  - session_role.yml

  # Test postgresql_idx module
  - postgresql_idx.yml

  # Test postgresql_query module
  - postgresql_query.yml

  # Test postgresql_tablespace module
  - postgresql_tablespace.yml

  # Test postgresql_db module, specific options
  - postgresql_db.yml

  # Test postgresql_privs
  - postgresql_privs.yml
  loop_control:
    loop_var: loop_item

# Test postgresql_ping module
- import_tasks: postgresql_ping.yml
  vars:
    db_name_nonexist: fake_db

# Test default_privs with target_role
- import_tasks: test_target_role.yml
  when: postgres_version_resp.stdout is version('9.1', '>=')

# dump/restore tests per format
# ============================================================
- include_tasks: state_dump_restore.yml
  vars:
    test_fixture: user
    file: '{{ loop_item }}'
  loop:
  - dbdata.sql
  - dbdata.sql.gz
  - dbdata.sql.bz2
  - dbdata.sql.xz
  - dbdata.tar
  - dbdata.tar.gz
  - dbdata.tar.bz2
  - dbdata.tar.xz
  loop_control:
    loop_var: loop_item

# dump/restore tests per other logins
# ============================================================
- import_tasks: state_dump_restore.yml
  vars:
    file: dbdata.tar
    test_fixture: admin
