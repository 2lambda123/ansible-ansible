# Test code for the postgresql_facts module
# Copyright: (c) 2019, Andrew Klychkov (@Andersson007) <aaklychkov@mail.ru>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: "postgresql_facts - test return values"
  become_user: "{{ pg_user }}"
  become: True
  postgresql_facts:
    db: "{{ db_default }}"
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: True

- assert:
    that:
      - 'result.postgresql_facts.version != ""'
      - 'result.postgresql_facts.databases.{{ db_default }}.collate'
      - 'result.postgresql_facts.languages'
      - 'result.postgresql_facts.namespaces.information_schema'
      - 'result.postgresql_facts.settings'

- name: "postgresql_facts - test check mode (for order, this module doesn't change anything)"
  become_user: "{{ pg_user }}"
  become: True
  postgresql_facts:
    db: "{{ db_default }}"
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: True

- assert:
    that:
      - 'result.changed == False'

- name: "postgresql_facts - check include_subset param"
  become_user: "{{ pg_user }}"
  become: True
  postgresql_facts:
    db: "{{ db_default }}"
    include_subset: ver*,role*
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: True

- assert:
    that:
      - 'result.postgresql_facts.version != ""'
      - 'result.postgresql_facts.roles'
      - 'result.postgresql_facts.namespaces == {}'

- name: "postgresql_facts - check exclude_subset param"
  become_user: "{{ pg_user }}"
  become: True
  postgresql_facts:
    db: "{{ db_default }}"
    exclude_subset: ver*
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: True

- assert:
    that:
      - 'result.postgresql_facts.version == ""'
      - 'result.postgresql_facts.roles'
