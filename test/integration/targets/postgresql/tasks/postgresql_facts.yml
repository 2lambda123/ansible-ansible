# Test code for the postgresql_facts module
# Copyright: (c) 2019, Andrew Klychkov (@Andersson007) <aaklychkov@mail.ru>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: postgresql_facts - test return values
  become_user: "{{ pg_user }}"
  become: yes
  postgresql_facts:
    db: "{{ db_default }}"
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: yes

- assert:
    that:
      - result.postgresql_facts.version != {}
      - result.postgresql_facts.databases.{{ db_default }}.collate
      - result.postgresql_facts.languages
      - result.postgresql_facts.namespaces.information_schema
      - result.postgresql_facts.settings
      - result.postgresql_facts.tablespaces
      - result.postgresql_facts.roles

- name: postgresql_facts - check filter param passed by list
  become_user: "{{ pg_user }}"
  become: yes
  postgresql_facts:
    db: "{{ db_default }}"
    login_user: "{{ pg_user }}"
    filter:
      - ver*
      - rol*
  register: result
  ignore_errors: yes

- assert:
    that:
      - result.postgresql_facts.version != {}
      - result.postgresql_facts.roles
      - result.postgresql_facts.databases == {}
      - result.postgresql_facts.extensions == {}
      - result.postgresql_facts.namespaces == {}
      - result.postgresql_facts.languages == {}
      - result.postgresql_facts.repl_slots == {}
      - result.postgresql_facts.replications == {}
      - result.postgresql_facts.settings == {}
      - result.postgresql_facts.tablespaces == {}

- name: postgresql_facts - check filter param passed by string
  become_user: "{{ pg_user }}"
  become: yes
  postgresql_facts:
    db: "{{ db_default }}"
    filter: ver*,role*
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: yes

- assert:
    that:
      - result.postgresql_facts.version != {}
      - result.postgresql_facts.roles
      - result.postgresql_facts.databases == {}
      - result.postgresql_facts.extensions == {}
      - result.postgresql_facts.namespaces == {}
      - result.postgresql_facts.languages == {}
      - result.postgresql_facts.repl_slots == {}
      - result.postgresql_facts.replications == {}
      - result.postgresql_facts.settings == {}
      - result.postgresql_facts.tablespaces == {}

- name: postgresql_facts - check filter param passed by string
  become_user: "{{ pg_user }}"
  become: yes
  postgresql_facts:
    db: "{{ db_default }}"
    filter: ver*
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: yes

- assert:
    that:
      - result.postgresql_facts.version
      - result.postgresql_facts.roles == {}

- name: postgresql_facts - check excluding filter param passed by list
  become_user: "{{ pg_user }}"
  become: yes
  postgresql_facts:
    db: "{{ db_default }}"
    filter:
      - "!ver*"
      - "!rol*"
    login_user: "{{ pg_user }}"
  register: result
  ignore_errors: yes

- assert:
    that:
      - result.postgresql_facts.version == {}
      - result.postgresql_facts.roles == {}
      - result.postgresql_facts.databases
