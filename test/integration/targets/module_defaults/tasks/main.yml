- name: main block
  vars:
    test_file: /tmp/ansible-test.module_defaults.foo
  module_defaults:
    debug:
      msg: test default
    file:
      path: '{{ test_file }}'
  block:
    - debug:
      register: foo

    - name: test that 'debug' task used default 'msg' param
      assert:
        that: foo.msg == "test default"

    - name: remove test file
      file:
        state: absent

    - name: touch test file
      file:
        state: touch

    - name: stat test file
      stat:
        path: '{{ test_file }}'
      register: foo

    - name: check that test file exists
      assert:
        that: foo.stat.exists

    - name: remove test file
      file:
        state: absent

    - name: test that module defaults from parent are inherited and merged
      module_defaults:
        # Meaningless values to make sure that 'module_defaults' gets
        # evaluated for this block
        foo:
          bar: baz
      block:
      - debug:
        register: foo

      - assert:
          that: foo.msg == "test default"

    - name: test that we can override module defaults inherited from parent
      module_defaults:
        debug:
          msg: "different test message"
      block:
      - debug:
        register: foo

      - assert:
          that: foo.msg == "different test message"

    - name: test that module defaults inherited from parent can be removed
      module_defaults:
        debug: {}
      block:
      - debug:
        register: foo

      - assert:
          that:
            foo.msg == "Hello world!"

    - name: test that module defaults can be overridden by module params
      block:
      - debug:
          msg: another test message
        register: foo

      - assert:
          that:
            foo.msg == "another test message"

      - debug:
          msg: '{{ omit }}'
        register: foo

      - assert:
          that:
            foo.msg == "Hello world!"

- name: test inheriting and extending variable module_defaults
  vars:
    test_file: /tmp/ansible-test.module_defaults.foo
    defaults_1:
      - debug:
          msg: initial msg
      - file:
          path: "{{ test_file }}"
      - fail:
          msg: initial failure msg
    defaults_2:
      - debug:
          msg: new msg
  block:

    - name: create a block with a templated value for module_defaults
      module_defaults: "{{ defaults_1 }}"
      block:

        - name: block containing tasks that inherit + extend module_defaults
          block:

            - debug:
              register: result

            - assert:
                that:
                  - result.msg == "initial msg"

            - debug:
              register: result
              module_defaults: "{{ defaults_2 }}"

            - assert:
                that:
                  - result.msg == "new msg"

            - name: test that the parent value was extended rather than overridden
              file:
                state: absent
              register: result

            - assert:
                that:
                  - not result is failed

            - name: test post validation for inheriting templated defaults
              set_fact:
                defaults_1:
                  - debug:
                      msg: updated msg

            - name: test that inheriting defaults_1 has the updated values
              debug:
              register: result

            - assert:
                that:
                  - result.msg == "updated msg"

            - file:
                state: absent
              ignore_errors: yes
              register: result

            - assert:
                that:
                  - result is failed
                  - 'result.msg == "missing required arguments: path"'
