- name: Create storage account name
  set_fact:
      storage_account: "{{ resource_group | hash('md5') | truncate(24, True, '') }}"

- name: Create storage account
  azure_rm_storageaccount:
      resource_group: "{{ resource_group }}"
      name: "{{ storage_account }}"
      account_type: Standard_LRS

- name: Create virtual network
  azure_rm_virtualnetwork:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}"
      address_prefixes: "10.10.0.0/16"

- name: Add subnet
  azure_rm_subnet:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}"
      address_prefix: "10.10.0.0/24"
      virtual_network: "vn{{ storage_account }}"

- name: Create public ip
  azure_rm_publicipaddress:
      resource_group: "{{ resource_group }}"
      allocation_method: Static
      name: "vn{{ storage_account }}"

- name: Create security group
  azure_rm_securitygroup:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}"

- name: Create NIC
  azure_rm_networkinterface:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}"
      virtual_network: "vn{{ storage_account }}"
      subnet: "vn{{ storage_account }}"
      public_ip_name: "vn{{ storage_account }}"
      security_group: "vn{{ storage_account }}"

- name: Create virtual machine
  azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}x"
      vm_size: Standard_A0
      storage_account: "{{ storage_account }}"
      storage_container: "vn{{ storage_account }}"
      storage_blob: "vn{{ storage_account }}.vhd"
      admin_username: adminuser
      admin_password: Password123!
      os_type: Linux
      network_interfaces: "vn{{ storage_account }}"
      image:
        offer: UbuntuServer
        publisher: Canonical
        sku: 16.04-LTS
        version: latest

- name: Deallocate the virtual machine
  azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}x"
      allocated: no 
      vm_size: Standard_A0
  register: output

- name: Start the virtual machine
  azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}x"
      vm_size: Standard_A0

- name: Create an image from VM (check mode)
  azure_rm_image:
      resource_group: "{{ resource_group }}"
      source: "https://{{ storage_account }}.blob.core.windows.net/vn{{ storage_account }}/vn{{ storage_account }}.vhd"
      name: testimage001
      os_type: Linux
  check_mode: yes
  register: output

- assert:
      that: output.changed

- name: Create an image from VM
  azure_rm_image:
      resource_group: "{{ resource_group }}"
      source: "https://{{ storage_account }}.blob.core.windows.net/vn{{ storage_account }}/vn{{ storage_account }}.vhd"
      name: testimage001
      os_type: Linux
  register: output

- assert:
      that:
          - output.changed
          - output.id

- name: Create an image from VM (idempotent)
  azure_rm_image:
      resource_group: "{{ resource_group }}"
      source: "https://{{ storage_account }}.blob.core.windows.net/vn{{ storage_account }}/vn{{ storage_account }}.vhd"
      name: testimage001
      os_type: Linux
  register: output

- assert:
      that:
          - not output.changed
          - output.id

- name: Delete image (check mode)
  azure_rm_image:
      resource_group: "{{ resource_group }}"
      name: testimage001
      state: absent
  register: output
  check_mode: yes

- assert:
    that:
      - output.changed

- name: Delete image
  azure_rm_image:
      resource_group: "{{ resource_group }}"
      name: testimage001
      state: absent
  register: output

- assert:
    that:
      - output.changed

- name: Delete image (idempotent)
  azure_rm_image:
      resource_group: "{{ resource_group }}"
      name: testimage001
      state: absent
  register: output

- assert:
    that:
      - not output.changed

- name: Delete VM
  azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "vn{{ storage_account }}x"
      state: absent
      vm_size: Standard_A0
  register: output

- name: Delete public ip
  azure_rm_publicipaddress:
      resource_group: "{{ resource_group }}"
      allocation_method: Static
      name: "vn{{ storage_account }}"
      state: absent
