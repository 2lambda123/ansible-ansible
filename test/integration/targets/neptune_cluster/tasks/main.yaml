---
- name: set connection information for all tasks
  set_fact:
    aws_connection_info: &aws_connection_info
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token }}"
      region: "{{ aws_region }}"
  no_log: true

- block:

    # ============================================================
    # Parameter Tests
    # ============================================================

    - name: test with no parameters
      neptune_cluster:
      register: result
      ignore_errors: true

    - name: assert failure when called with no parameters
      assert:
        that:
           - 'result.failed'
           - 'result.msg.startswith("missing required arguments:")'

    # ============================================================
    # Resource Tests
    # ============================================================

    - name: Create graph database cluster
      neptune_cluster:
        <<: *aws_connection_info
        name: "{{ resource_prefix }}-test-cluster"
        state: present
        encrypted: true
        retention_period: 7
        skip_final_snapshot: true
      register: result

    - name: assert correct keys are returned
      assert:
        that:
          - result.changed
          - result.db_cluster_arn is not none

    - name: No changes to graph database cluster
      neptune_cluster:
        <<: *aws_connection_info
        name: "{{ resource_prefix }}-test-cluster"
        state: present
        encrypted: true
        retention_period: 7
        skip_final_snapshot: true
      register: result

    - name: assert correct keys are returned
      assert:
        that:
          - not result.changed
          - result.db_cluster_arn is not none

    - name: Update graph database cluster
      neptune_cluster:
        <<: *aws_connection_info
        name: "{{ resource_prefix }}-test-cluster"
        state: present
        encrypted: true
        retention_period: 12
        skip_final_snapshot: true
      register: result

    - name: assert correct keys are returned
      assert:
        that:
          - result.changed
          - result.db_cluster_arn is not none

  always:

    # ============================================================
    # Teardown testing resources
    # ============================================================

    - name: Destroy graph database cluster
      neptune_cluster:
        <<: *aws_connection_info
        name: "{{ resource_prefix }}-test-cluster"
        state: absent
        encrypted: true
        retention_period: 12
        skip_final_snapshot: true
      ignore_errors: yes
