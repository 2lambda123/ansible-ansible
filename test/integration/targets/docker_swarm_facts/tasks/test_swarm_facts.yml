---
- block:
  - name: Make sure we're not already using Docker swarm
    docker_swarm:
      state: absent
      force: true

  - name: Try to get docker_swarm_facts when docker is not running in swarm mode
    docker_swarm_facts:
    ignore_errors: yes
    register: output

  - name: assert failure when called when swarm is not in use or not run on mamager node
    assert:
      that:
         - 'output.failed'
         - 'output.msg == "Error running docker swarm module: must run on swarm manager node"'

#  - name: Test parameters with state=remove
#    docker_swarm:
#      state: remove
#    ignore_errors: yes
#    register: output
#
#  - name: assert failure when called with state=remove and no node_id
#    assert:
#      that:
#         - 'output.failed'
#         - 'output.msg == "state is remove but all of the following are missing: node_id"'
#
  - name: Create a Swarm cluster
    docker_swarm:
      state: present
    register: output

  - name: assert changed when create a new swarm cluster
    assert:
      that:
         - 'output.changed'
         - 'output.actions[0] | regex_search("New Swarm cluster created: ")'
         - 'output.swarm_facts.JoinTokens.Manager'
         - 'output.swarm_facts.JoinTokens.Worker'

  - name: Try to get docker_swarm_facts when docker is running in swarm mode and as manager
    docker_swarm_facts:
    ignore_errors: yes
    register: output
#
#  - name: Remove a Swarm cluster
#    docker_swarm:
#      state: absent
#      force: true
#    register: output
#
#  - name: assert changed when remove a swarm cluster
#    assert:
#      that:
#         - 'output.changed'
#         - 'output.actions[0] == "Node has left the swarm cluster"'

  always:
  - name: Cleanup
    docker_swarm:
      state: absent
      force: true
