---
- name: Confirm winrm is open on the host
  wait_for_connection:
    timeout: 10

- name: Get Ansible Facts
  setup:

- name: Try to Suspend host
  win_powerstate:
  register: win_powerstatesuspend_result

- name: assert win_powerstatesuspend_result (Windows Client) for suspend state
  assert:
    that:
    - win_powerstatesuspend_result is changed
  when: not hostvars[inventory_hostname].ansible_distribution is search (' Server ')

- name: assert win_powerstatesuspend_result (Windows Server) for suspend state
  assert:
    that:
    - not win_powerstatesuspend_result is changed
  when: hostvars[inventory_hostname].ansible_distribution is search (' Server ')

- name: Try to Hibernate host
  win_powerstate:
    state: hibernate
  register: win_powerstatehibernate_result

- name: assert win_powerstatehibernate_result (Windows Client) for suspend state
  assert:
    that:
    - win_powerstatehibernate_result is changed
  when: not hostvars[inventory_hostname].ansible_distribution is search (' Server ')

- name: assert win_powerstatehibernate_result (Windows Server) for suspend state
  assert:
    that:
    - not win_powerstatehibernate_result is changed
  when: hostvars[inventory_hostname].ansible_distribution is search (' Server ')

- name: Force Shutdown to host (Check Mode)
  win_powerstate:
    state: shutdown
    force: true
  register: win_powerstateshutdown_result
  check_mode: true

- name: Confirm winrm is open on the host
  wait_for_connection:
    timeout: 10
  register: winrm_port_open

- name: assert shutdown state
  assert:
    that:
    - not winrm_port_open.failed
