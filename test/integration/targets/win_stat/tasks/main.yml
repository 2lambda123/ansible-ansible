# while most of the setup can be done with modules, it is quicker to do them
# all in bulk than with with_items to save each round trip over WinRM
- name: set test files and folders
  win_shell: |
    $ErrorActionPreference = "Stop"
    $directories = @(
        "folder",
        "folder space",
        "nested\nested",
        "shared",
        "hidden",
        "link-dest",
        "junction-dest"
    )

    $tmp_path = '{{ remote_tmp_dir }}'
    foreach ($directory in $directories) {
        New-Item -Path "$tmp_path\$directory" -ItemType Directory
    }

    $normal_content = "abc"
    $normal_files = @(
        "nested\file.ps1",
        "nested\hard-target.txt",
        "nested\read-only.ps1",
        "nested\archive.ps1",
        "nested\hidden.ps1",
        "nested\nested\file.ps1",
        "folder space\file.ps1",
        "link-dest\file.txt"
    )
    foreach ($file in $normal_files) {
        New-Item -Path "$tmp_path\$file" -ItemType File
        [System.IO.File]::WriteAllText("$tmp_path\$file", $normal_content)
    }

    $share_stat = Get-WmiObject -Class Win32_Share -Filter "name='folder-share'"
    if ($share_stat) {
        $share_stat.Delete()
    }
    $wmi = [wmiClass] 'Win32_Share'
    $wmi.Create("$tmp_path\shared", "folder-share", 0)

    cmd.exe /c mklink /D "$tmp_path\link" "$tmp_path\link-dest"
    cmd.exe /c mklink /H "$tmp_path\nested\hard-link.ps1" "$tmp_path\nested\hard-target.txt"
    cmd.exe /c mklink /J "$tmp_path\junction-link" "$tmp_path\junction-dest"
    cmd.exe /c mklink /D "$tmp_path\nested\nested\link-rel" "..\..\link-dest"
    cmd.exe /c mklink /D "$tmp_path\outer-link" "$tmp_path\nested\nested\link-rel"

    $date = Get-Date -Year 2016 -Month 11 -Day 1 -Hour 7 -Minute 10 -Second 5 -Millisecond 0
    Get-ChildItem -LiteralPath $tmp_path -Recurse | ForEach-Object {
        $_.CreationTime = $date
        $_.LastAccessTime = $date
        $_.LastWriteTime = $date
    }

    $attributes = @{
        "hidden" = "Hidden"
        "nested\read-only.ps1" = "ReadOnly"
        "nested\archive.ps1" = "Archive"
        "nested\hidden.ps1" = "Hidden"
    }

    foreach ($attribute in $attributes.GetEnumerator()) {
        $item = Get-Item -LiteralPath "$tmp_path\$($attribute.Name)"
        $file_attributes = $item.Attributes -split ','
        if ($file_attributes -notcontains $attribute.Value) {
            $file_attributes += $attribute.Value
        }
        $item.Attributes = $file_attributes -join ','
    }

    # weird issue, need to access the file in anyway to get the correct date stats
    Test-Path -LiteralPath "$tmp_path\nested\hard-link.ps1"

# mklink.exe and win_file cannot do this right now so we need a custom module
- name: create file symlink
  test_symlink_file:
    src: '{{ remote_tmp_dir }}\file-link.txt'
    target: '{{ remote_tmp_dir }}\nested\file.ps1'
    state: present

- block:
  - include_tasks: tests.yml

  always:
  - name: ensure test user is deleted
    win_user:
      name: '{{win_stat_user}}'
      state: absent

  - name: ensure test user profile is deleted
    win_shell: rmdir /S /Q {{profile_dir_out.stdout_lines[0]}}
    args:
      executable: cmd.exe
    when: win_stat_user in profile_dir_out.stdout_lines[0]
