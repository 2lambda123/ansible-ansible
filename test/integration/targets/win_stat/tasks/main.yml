# test code for the win_stat module
# (c) 2014, Chris Church <chris@ninemoreminutes.com>

# This file is part of Ansible
#
# Ansible is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Ansible is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.

- name: template out setup script
  win_template:
    src: setup.ps1.tmpl
    dest: "{{win_output_dir}}\\setup.ps1"

- name: run setup script
  win_command: powershell "{{win_output_dir}}\\setup.ps1"

- name: test win_stat module on file
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
  register: actual

- name: set expected fact for file
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Archive
        checksum: 34d4150adc3347f1dd8ce19fdf65b74d971ab602
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: file.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
        size: 5

- name: check actual for file
  assert:
    that:
    - "actual == expected"

- name: test win_stat module on file without md5
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
    get_md5: False
  register: actual

- name: set expected fact for file without md5
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Archive
        checksum: 34d4150adc3347f1dd8ce19fdf65b74d971ab602
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: file.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
        size: 5

- name: check actual for file without md5
  assert:
    that:
    - "actual == expected"

- name: test win_stat module on file with sha256
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
    checksum_algorithm: sha256
  register: actual

- name: set expected fact for file with sha256
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Archive
        checksum: 552bab6864c7a7b69a502ed1854b9245c0e1a30f008aaa0b281da62585fdb025
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: file.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
        size: 5

- name: check actual for file with sha256
  assert:
    that:
    - "actual == expected"

- name: test win_stat module on file with sha384
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
    checksum_algorithm: sha384
  register: actual

- name: set expected fact for file with sha384
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Archive
        checksum: fdaeef7c96bcb25e206826709ede56f46b8a843d3159e05a8714584ff7bbc33f51635b5a503e91ee0c07227085caadde
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: file.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
        size: 5

- name: check actual for file with sha384
  assert:
    that:
    - "actual == expected"

- name: test win_stat module on file with sha512
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
    checksum_algorithm: sha512
  register: actual

- name: set expected fact for file with sha512
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Archive
        checksum: e3bcf148cf4aba61ad59042dcca53e018f685cdc009f5e9f239e6f83de6dcc4d8ef0c714721b596627b7d8f9e2edb6c093298f95589c47ba82e439e1ae519f41
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: file.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\file.ps1"
        size: 5

- name: check actual for file with sha512
  assert:
    that:
    - "actual == expected"

- name: test win_stat on hidden file
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\hidden.ps1"
  register: actual

- name: set expected fact for hidden file
  set_fact:
    expected:
      changed: False
      stat:
        attributes: "Hidden, Archive"
        checksum: 34d4150adc3347f1dd8ce19fdf65b74d971ab602
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: hidden.ps1
        isarchive: True
        isdir: False
        ishidden: True
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\hidden.ps1"
        size: 5

- name: check actual for hidden file
  assert:
    that:
    - "actual == expected"

- name: test win_stat on readonly file
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\read-only.ps1"
  register: actual

- name: set expected fact for readonly file
  set_fact:
    expected:
      changed: False
      stat:
        attributes: "ReadOnly, Archive"
        checksum: 34d4150adc3347f1dd8ce19fdf65b74d971ab602
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: read-only.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: True
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\read-only.ps1"
        size: 5

- name: check actual for readonly file
  assert:
    that:
    - "actual == expected"

- name: test win_stat on hard link file
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested\\hard-link.ps1"
  register: actual

- name: set expected fact for hard link file
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Archive
        checksum: 34d4150adc3347f1dd8ce19fdf65b74d971ab602
        creationtime: 1477984205
        exists: True
        extension: .ps1
        filename: hard-link.ps1
        isarchive: True
        isdir: False
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        md5: c13b6afecf97ea6b38d21a8f5167fa1e
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested\\hard-link.ps1"
        size: 5

- name: check actual for hard link file
  assert:
    that:
    - "actual == expected"

- name: test win_stat on directory
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\nested"
  register: actual

- name: set expected fact for directory
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Directory
        creationtime: 1477984205
        exists: True
        filename: nested
        isarchive: False
        isdir: True
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\nested"
        size: 25

- name: check actual for directory
  assert:
    that:
    - "actual == expected"

- name: test win_stat on empty directory
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\folder"
  register: actual

- name: set expected fact for empty directory
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Directory
        creationtime: 1477984205
        exists: True
        filename: folder
        isarchive: False
        isdir: True
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\folder"
        size: 0

- name: check actual for empty directory
  assert:
    that:
    - "actual == expected"

- name: test win_stat on directory with space in name
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\folder space"
  register: actual

- name: set expected fact for directory with space in name
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Directory
        creationtime: 1477984205
        exists: True
        filename: folder space
        isarchive: False
        isdir: True
        ishidden: False
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\folder space"
        size: 5

- name: check actual for directory with space in name
  assert:
    that:
    - "actual == expected"

- name: test win_stat on hidden directory
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\hidden"
  register: actual

- name: set expected fact for hidden directory
  set_fact:
    expected:
      changed: False
      stat:
        attributes: "Hidden, Directory"
        creationtime: 1477984205
        exists: True
        filename: hidden
        isarchive: False
        isdir: True
        ishidden: True
        islink: False
        isreadonly: False
        isshared: False
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\hidden"
        size: 0

- name: check actual for hidden directory
  assert:
    that:
    - "actual == expected"

- name: test win_stat on shared directory
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\shared"
  register: actual

- name: set expected fact for shared directory
  set_fact:
    expected:
      changed: False
      stat:
        attributes: Directory
        creationtime: 1477984205
        exists: True
        filename: shared
        isarchive: False
        isdir: True
        ishidden: False
        islink: False
        isreadonly: False
        isshared: True
        lastaccesstime: 1477984205
        lastwritetime: 1477984205
        owner: BUILTIN\Administrators
        path: "{{win_output_dir}}\\win_stat\\shared"
        sharename: folder-share
        size: 0

- name: check actual for shared directory
  assert:
    that:
    - "actual == expected"

- name: test win_stat on symlink
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\link"
  register: actual

# I cannot change modification time on links so we are resorting to checking the dict against known valuea
- name: assert symlink actual
  assert:
    that:
    - "actual.stat.attributes == 'Directory, ReparsePoint'"
    - "actual.stat.creationtime is defined"
    - "actual.stat.exists == True"
    - "actual.stat.filename == 'link'"
    - "actual.stat.isarchive == False"
    - "actual.stat.isdir == True"
    - "actual.stat.ishidden == False"
    - "actual.stat.islink == True"
    - "actual.stat.isreadonly == False"
    - "actual.stat.isshared == False"
    - "actual.stat.lastaccesstime is defined"
    - "actual.stat.lastwritetime is defined"
    - "actual.stat.lnk_source == '{{win_output_dir|regex_replace('\\\\', '\\\\\\\\')}}\\\\win_stat\\\\link-dest'"
    - "actual.stat.owner == 'BUILTIN\\Administrators'"
    - "actual.stat.path == '{{win_output_dir|regex_replace('\\\\', '\\\\\\\\')}}\\\\win_stat\\\\link'"
    - "actual.stat.size is not defined"
    - "actual.stat.checksum is not defined"
    - "actual.stat.md5 is not defined"

- name: test win_stat on junction
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\junction-link"
  register: actual

- name: assert symlink actual
  assert:
    that:
    - "actual.stat.attributes == 'Directory, ReparsePoint'"
    - "actual.stat.creationtime is defined"
    - "actual.stat.exists == True"
    - "actual.stat.filename == 'junction-link'"
    - "actual.stat.isarchive == False"
    - "actual.stat.isdir == True"
    - "actual.stat.ishidden == False"
    - "actual.stat.islink == True"
    - "actual.stat.isreadonly == False"
    - "actual.stat.isshared == False"
    - "actual.stat.lastaccesstime is defined"
    - "actual.stat.lastwritetime is defined"
    - "actual.stat.lnk_source == '{{win_output_dir|regex_replace('\\\\', '\\\\\\\\')}}\\\\win_stat\\\\junction-dest'"
    - "actual.stat.owner == 'BUILTIN\\Administrators'"
    - "actual.stat.path == '{{win_output_dir|regex_replace('\\\\', '\\\\\\\\')}}\\\\win_stat\\\\junction-link'"
    - "actual.stat.size is not defined"
    - "actual.stat.checksum is not defined"
    - "actual.stat.md5 is not defined"

- name: test win_stat module non-existent path
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\this_file_should_not_exist"
  register: win_stat_missing

- name: check win_stat missing result
  assert: 
    that:
      - "not win_stat_missing.stat.exists"
      - "not win_stat_missing|failed"
      - "not win_stat_missing|changed"

- name: test win_stat module without path argument
  action: win_stat
  register: win_stat_no_args
  ignore_errors: true

- name: check win_stat result with no path argument
  assert:
    that:
      - "win_stat_no_args|failed"
      - "win_stat_no_args.msg"
      - "not win_stat_no_args|changed"

- name: check if junction symbolic link exists
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\junction-link"
  register: junction_link_exists

- name: delete junction symbolic link if it exists
  win_command: cmd.exe /c rmdir {{win_output_dir}}\win_stat\junction-link
  when: junction_link_exists.stat.exists

- name: check if symbolic link exists
  win_stat:
    path: "{{win_output_dir}}\\win_stat\\link"
  register: nested_link_exists

- name: delete nested symbolic link if it exists
  win_shell: cmd.exe /c rmdir {{win_output_dir}}\win_stat\link
  when: nested_link_exists.stat.exists

- name: remove testing folder
  win_file:
    path: "{{win_output_dir}}\\win_stat"
    state: absent
