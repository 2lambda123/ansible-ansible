- name: Fetch initial user_data (Check)
  check_mode: yes
  scaleway_user_data:
    region: par1
    server_id: "{{ server_id }}"
  register: initial_user_data_check_task

- debug: var=initial_user_data_check_task

- name: initial_user_data_check_task is success
  assert:
    that:
      - initial_user_data_check_task is success

- name: initial_user_data_check_task is not changed
  assert:
    that:
      - initial_user_data_check_task is not changed

- name: Fetch initial user_data
  scaleway_user_data:
    region: par1
    server_id: "{{ server_id }}"
  register: initial_user_data_task

- debug: var=initial_user_data_task

- name: initial_user_data_task is success
  assert:
    that:
      - initial_user_data_task is success

- name: initial_user_data_task is not changed
  assert:
    that:
      - initial_user_data_task is not changed

- name: Patch user_data cloud-init configuration (Check)
  check_mode: yes
  scaleway_user_data:
    region: '{{ scaleway_region }}'
    server_id: "{{ server_id }}"
    user_data:
      cloud-init: "{{ cloud_init_script }}"
  register: user_data_check_task

- debug: var=user_data_check_task

- name: user_data_check_task is success
  assert:
    that:
      - user_data_check_task is success

- name: user_data_check_task is changed
  assert:
    that:
      - user_data_check_task is changed

- name: Patch user_data cloud-init configuration
  scaleway_user_data:
    region: '{{ scaleway_region }}'
    server_id: "{{ server_id }}"
    user_data:
      cloud-init: "{{ cloud_init_script }}"
  register: user_data_task

- debug: var=user_data_task

- name: user_data_task is success
  assert:
    that:
      - user_data_task is success

- name: user_data_task is changed
  assert:
    that:
      - user_data_task is changed

- name: user_data pushed equals the one defined
  assert:
    that:
      - user_data_task.scaleway_user_data["cloud-init"] == cloud_init_script

- name: Patch user_data cloud-init configuration (Confirmation)
  scaleway_user_data:
    region: '{{ scaleway_region }}'
    server_id: "{{ server_id }}"
    user_data:
      cloud-init: "{{ cloud_init_script }}"
  register: user_data_confirmation_task

- debug: var=user_data_confirmation_task

- name: user_data_confirmation_task is success
  assert:
    that:
      - user_data_confirmation_task is success

- name: user_data_confirmation_task is not changed
  assert:
    that:
      - user_data_confirmation_task is not changed

- name: user_data pushed equals the one defined
  assert:
    that:
      - user_data_confirmation_task.scaleway_user_data["cloud-init"] == cloud_init_script

- name: Delete user_data cloud-init configuration (Check)
  check_mode: yes
  scaleway_user_data:
    region: par1
    server_id: "{{ server_id }}"
    user_data:
      cloud-init: null
  register: user_data_delete_check_task

- debug: var=user_data_delete_check_task

- name: user_data_delete_check_task is success
  assert:
    that:
      - user_data_delete_check_task is success

- name: user_data_delete_check_task is changed
  assert:
    that:
      - user_data_delete_check_task is changed

- name: Delete user_data cloud-init configuration
  scaleway_user_data:
    region: par1
    server_id: "{{ server_id }}"
    user_data:
      cloud-init: null
  register: user_data_delete_task

- debug: var=user_data_delete_task

- name: user_data_delete_task is success
  assert:
    that:
      - user_data_delete_task is success

- name: user_data_delete_task is changed
  assert:
    that:
      - user_data_delete_task is changed

- name: cloud-init not in user_data_delete_task.scaleway_user_data.keys()
  assert:
    that:
      - "{{ 'cloud-init' not in user_data_delete_task.scaleway_user_data.keys() }}"

- name: Delete user_data cloud-init configuration (Confirmation)
  scaleway_user_data:
    region: par1
    server_id: "{{ server_id }}"
    user_data:
      cloud-init: null
  register: user_data_delete_confirmation_task

- debug: var=user_data_delete_confirmation_task

- name: user_data_delete_confirmation_task is success
  assert:
    that:
      - user_data_delete_confirmation_task is success

- name: user_data_delete_confirmation_task is not changed
  assert:
    that:
      - user_data_delete_confirmation_task is not changed

- name: cloud-init not in user_data_delete_confirmation_task.scaleway_user_data.keys()
  assert:
    that:
      - "{{ 'cloud-init' not in user_data_delete_confirmation_task.scaleway_user_data.keys() }}"
