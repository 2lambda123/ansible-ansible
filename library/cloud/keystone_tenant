#!/usr/bin/python
# -*- coding: utf-8 -*-
try:
    from keystoneclient.v2_0 import client as key_v2
    from keystoneclient.openstack.common.apiclient import exceptions as key_exception
except ImportError:
    print("failed=True msg='keystoneclient is required'")

DOCUMENTATION = '''
---
module: keystone_tenant
version_added: "1.0"
short_description: Manage OpenStack Identity (keystone) tenants
description:
   - Manage tenants from OpenStack.
options:
   os_username:
     description:
        - OpenStack Auth username
     required: true
     default: None
   os_password:
     description:
        - OpenStack Auth password
     required: true
     default: None
   os_tenant_name:
     description:
        - OpenStack Auth tenant name
     required: true
     default: None
   token:
     description:
        - The token to be used in case the password is not specified
     required: false
     default: None
   os_auth_url:
     description:
        - OpenStack Keystone Auth URL
     required: true
     default: None
   region_name:
     description:
        - Region name
     required: false
     default: None
   name:
     description:
        - The name of the tenant that has to added/removed from OpenStack
     required: true
     default: None
   descritpion:
     description:
        - Tenant description
     required: false
     default: None
   state:
     description:
        - Indicate desired state of the resource
     choices: ['present', 'absent']
     default: present
requirements: [ python-keystoneclient ]
'''

EXAMPLES = '''
# Create a tenant
- keystone_tenant:
    name: batcave
    description: Yes, that Batcave
    state: present
    os_username: admin
    os_password: password
    os_tenant_name: admin
    os_auth_url: http://10.0.2.15:5000/v2.0
'''
def _authenticate(module):
    try:
        if module.params['token']:
            return key_v2.Client(auth_url=module.params['auth_url'],
                                 token=module.params['token'],
                                 region_name=module.params['region_name'],)
        else:
            return key_v2.Client(username=module.params['os_username'],
                                 password=module.params['os_password'],
                                 tenant_name=module.params['os_tenant_name'],
                                 auth_url=module.params['os_auth_url'],
                                 region_name=module.params['region_name'],)
    except key_exception, e:
        module.fail_json(msg='Error getting keystone client:%s' % str(e))
    return None

def _get_tenant(keystone, tenant_name):
    for tenant in keystone.tenants.list():
        if tenant.name == tenant_name:
            return tenant
    return None

def _tenant_present(module, keystone):
    try:
        tenant = _get_tenant(keystone, module.params['name'])
    except key_exception, e:
        module.fail_json(msg='Error getting tenant list:%s' % str(e))
    if tenant is not None:
        module.exit_json(changed=False, result='Tenant found', info=tenant._info)
    args = {'tenant_name' : module.params['name'],
            'description' : module.params['description']
           }
    try:
        tenant = keystone.tenants.create(**args)
    except key_exception, e:
        module.fail_json(msg='Cannot create tenant:%s' % str(e))
    module.exit_json(changed=True, info=tenant._info, result='Tenant Created')

def _tenant_absent(module, keystone):
    try:
        tenant = _get_tenant(keystone, module.params['name'])
    except key_exception, e:
        module.fail_json(msg='Error getting tenant list:%s' % str(e))
    if tenant is None:
        module.exit_json(changed=False, result='Tenant not found')
    try:
        keystone.tenants.delete(tenant.id)
    except key_exception, e:
        module.fail_json(msg="Cannot delete tenant:%s" % str(e))
    module.exit_json(changed=True, result='Tenant Deleted')

def main():
    module = AnsibleModule(
        argument_spec=dict(
            name            = dict(required=True),
            description     = dict(default=None),
            state           = dict(default='present', choices=['present', 'absent']),
            os_auth_url     = dict(required=True),
            token           = dict(required=False),
            os_username     = dict(required=True),
            os_password     = dict(required=True),
            os_tenant_name  = dict(required=True),
            region_name     = dict(default=None),
        ),
    )
    keystone = _authenticate(module)
    if module.params['state'] == 'present':
        _tenant_present(module, keystone)
    if module.params['state'] == 'absent':
        _tenant_absent(module, keystone)

# import module snippets
from ansible.module_utils.basic import *
if __name__ == '__main__':
    main()
