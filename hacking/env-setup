# usage: . hacking/env-setup [-q]
#    modifies environment for running Ansible from checkout

verbosity=${1-info} # Defaults to `info' if unspecified
if [ "$verbosity" = -q ]; then
    verbosity=silent
fi

HACKING_DIR=$PWD/hacking

# The below is an alternative to readlink -fn which doesn't exist on OS X
# Source: http://stackoverflow.com/a/1678636
FULL_PATH=$(python -c "import os; print(os.path.realpath('$HACKING_DIR'))")
ANSIBLE_HOME=$(dirname "$FULL_PATH")

PREFIX_PYTHONPATH=$ANSIBLE_HOME/lib
prefix_path=$ANSIBLE_HOME/bin
prefix_manpath=$ANSIBLE_HOME/docs/man

path_already_in() {
    local path_element=$1
    local path_list=$2
    case :$path_list: in
        *:"$path_element":*)
            return 0 # true
            ;;
        *)
            return 1 # false
            ;;
    esac
}

if ! path_already_in "$PREFIX_PYTHONPATH" "$PYTHONPATH"; then
    export PYTHONPATH=$PREFIX_PYTHONPATH:$PYTHONPATH
fi

if ! path_already_in "$prefix_path" "$PATH"; then
    export PATH=$prefix_path:$PATH
fi

if ! path_already_in "$prefix_manpath" "$MANPATH"; then
    export MANPATH=$prefix_manpath:$MANPATH
fi

# Generate egg_info so that pkg_resources works
gen_egg_info()
{
    python setup.py egg_info
    if [ -e "$PREFIX_PYTHONPATH"/ansible.egg-info ] ; then
        rm -r "$PREFIX_PYTHONPATH"/ansible.egg-info
    fi
    mv ansible.egg-info "$PREFIX_PYTHONPATH"
}

if [ "$ANSIBLE_HOME" != "$PWD" ] ; then
    current_dir=$PWD
else
    current_dir=$ANSIBLE_HOME
fi
cd "$ANSIBLE_HOME"
if [ "$verbosity" = silent ] ; then
    gen_egg_info > /dev/null 2>&1
else
    gen_egg_info
fi
cd "$current_dir"

if [ "$verbosity" != silent ] ; then
    cat <<- EOF
	
	Setting up Ansible to run out of checkout...
	
	PATH=$PATH
	PYTHONPATH=$PYTHONPATH
	MANPATH=$MANPATH
	
	Remember, you may wish to specify your host file with -i
	
	Done!
	
	EOF
fi
